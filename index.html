<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Dr.&nbsp;Martín Lozano.">

<title>Forecasting with  R</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="index_files/libs/clipboard/clipboard.min.js"></script>
<script src="index_files/libs/quarto-html/quarto.js"></script>
<script src="index_files/libs/quarto-html/popper.min.js"></script>
<script src="index_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="index_files/libs/quarto-html/anchor.min.js"></script>
<link href="index_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="index_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="index_files/libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="index_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="index_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="index_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="index_files/libs/bootstrap/bootstrap-dark.min.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<link href="index_files/libs/quarto-contrib/fontawesome6-0.1.0/all.css" rel="stylesheet">
<link href="index_files/libs/quarto-contrib/fontawesome6-0.1.0/latex-fontsize.css" rel="stylesheet">
<style>html{ scroll-behavior: smooth; }</style>



  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    #btn-back-to-top {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 15px; /* Adjust the width */
      height: 15px; /* Adjust the height */
      box-sizing: content-box;
      z-index: 1000;
      background-color: rgba(0, 123, 255, 0.7);
      border: none;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
    }
  </style>
</head>
<body>

<button type="button" class="btn btn-primary btn-lg bi bi-arrow-up" id="btn-back-to-top"></button>

<script>
  let backToTopButton = document.getElementById("btn-back-to-top");

  backToTopButton.addEventListener("click", function () {
    document.documentElement.scrollTop = 0;
  });
</script>



<div id="progress-bar" style="width: 0%; height:2px; background-color: rgb(89 127 235);; position: fixed; top: 0px; z-index: 2000;"></div>

<script id="progressbar" type="text/javascript">

document.addEventListener("DOMContentLoaded", function() {

    const bar = document.querySelector('#progress-bar');
    const post = document.querySelector('#quarto-content');
    const html = document.documentElement;
    
    const height = post.scrollHeight + post.offsetTop;
    
    window.addEventListener('scroll', () => {
        bar.style.width = (html.scrollTop / (height- html.clientHeight)) * 100 + '%';
    });
});
</script>

<link href="index_files/libs/vembedr-0.1.5/css/vembedr.css" rel="stylesheet">
<script src="index_files/libs/kePrint-0.0.1/kePrint.js"></script>
<link href="index_files/libs/lightable-0.0.1/lightable.css" rel="stylesheet">

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>





<div id="quarto-content" class="page-columns page-rows-contents page-layout-full toc-left">
<div id="quarto-sidebar-toc-left" class="sidebar toc-left">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Contents</h2>
   
  <ul class="collapse">
  <li><a href="#introduction." id="toc-introduction." class="nav-link active" data-scroll-target="#introduction.">Introduction.</a></li>
  <li><a href="#the-forecast-problem." id="toc-the-forecast-problem." class="nav-link" data-scroll-target="#the-forecast-problem."><span class="header-section-number">1</span> The forecast problem.</a>
  <ul class="collapse">
  <li><a href="#the-data." id="toc-the-data." class="nav-link" data-scroll-target="#the-data."><span class="header-section-number">1.1</span> The data.</a></li>
  <li><a href="#time-series-properties." id="toc-time-series-properties." class="nav-link" data-scroll-target="#time-series-properties."><span class="header-section-number">1.2</span> Time series properties.</a></li>
  </ul></li>
  <li><a href="#forecasts-with-fpp3." id="toc-forecasts-with-fpp3." class="nav-link" data-scroll-target="#forecasts-with-fpp3."><span class="header-section-number">2</span> Forecasts with <tt><code>fpp3</code></tt>.</a>
  <ul class="collapse">
  <li><a href="#four-simple-techniques." id="toc-four-simple-techniques." class="nav-link" data-scroll-target="#four-simple-techniques."><span class="header-section-number">2.1</span> Four simple techniques.</a></li>
  <li><a href="#exponential-smoothing." id="toc-exponential-smoothing." class="nav-link" data-scroll-target="#exponential-smoothing."><span class="header-section-number">2.2</span> Exponential smoothing.</a></li>
  <li><a href="#arima." id="toc-arima." class="nav-link" data-scroll-target="#arima."><span class="header-section-number">2.3</span> ARIMA.</a></li>
  <li><a href="#neural-network." id="toc-neural-network." class="nav-link" data-scroll-target="#neural-network."><span class="header-section-number">2.4</span> Neural network.</a></li>
  </ul></li>
  <li><a href="#forecasts-with-h2o." id="toc-forecasts-with-h2o." class="nav-link" data-scroll-target="#forecasts-with-h2o."><span class="header-section-number">3</span> Forecasts with <tt><code>h2o</code></tt>.</a>
  <ul class="collapse">
  <li><a href="#the-h2o-package." id="toc-the-h2o-package." class="nav-link" data-scroll-target="#the-h2o-package."><span class="header-section-number">3.1</span> The <tt><code>h2o</code></tt> package.</a></li>
  <li><a href="#the-data.-1" id="toc-the-data.-1" class="nav-link" data-scroll-target="#the-data.-1"><span class="header-section-number">3.2</span> The data.</a></li>
  <li><a href="#prepare-for-h2o." id="toc-prepare-for-h2o." class="nav-link" data-scroll-target="#prepare-for-h2o."><span class="header-section-number">3.3</span> Prepare for H2O.</a></li>
  <li><a href="#estimate-h2o-models." id="toc-estimate-h2o-models." class="nav-link" data-scroll-target="#estimate-h2o-models."><span class="header-section-number">3.4</span> Estimate H2O models.</a></li>
  <li><a href="#predictions." id="toc-predictions." class="nav-link" data-scroll-target="#predictions."><span class="header-section-number">3.5</span> Predictions.</a></li>
  <li><a href="#summary-h2o-models." id="toc-summary-h2o-models." class="nav-link" data-scroll-target="#summary-h2o-models."><span class="header-section-number">3.6</span> Summary H2O models.</a></li>
  </ul></li>
  <li><a href="#two-more-forecast-models." id="toc-two-more-forecast-models." class="nav-link" data-scroll-target="#two-more-forecast-models."><span class="header-section-number">4</span> Two more forecast models.</a>
  <ul class="collapse">
  <li><a href="#linear-regression." id="toc-linear-regression." class="nav-link" data-scroll-target="#linear-regression."><span class="header-section-number">4.1</span> Linear regression.</a></li>
  <li><a href="#estimation." id="toc-estimation." class="nav-link" data-scroll-target="#estimation."><span class="header-section-number">4.2</span> Estimation.</a></li>
  <li><a href="#predict." id="toc-predict." class="nav-link" data-scroll-target="#predict."><span class="header-section-number">4.3</span> Predict.</a></li>
  <li><a href="#arima.-1" id="toc-arima.-1" class="nav-link" data-scroll-target="#arima.-1"><span class="header-section-number">4.4</span> ARIMA.</a></li>
  <li><a href="#prepare-the-data." id="toc-prepare-the-data." class="nav-link" data-scroll-target="#prepare-the-data."><span class="header-section-number">4.5</span> Prepare the data.</a></li>
  <li><a href="#estimation.-1" id="toc-estimation.-1" class="nav-link" data-scroll-target="#estimation.-1"><span class="header-section-number">4.6</span> Estimation.</a></li>
  <li><a href="#predict.-1" id="toc-predict.-1" class="nav-link" data-scroll-target="#predict.-1"><span class="header-section-number">4.7</span> Predict.</a></li>
  </ul></li>
  <li><a href="#summary-of-all-results." id="toc-summary-of-all-results." class="nav-link" data-scroll-target="#summary-of-all-results."><span class="header-section-number">5</span> Summary of all results.</a>
  <ul class="collapse">
  <li><a href="#unsorted-references." id="toc-unsorted-references." class="nav-link" data-scroll-target="#unsorted-references."><span class="header-section-number">5.1</span> Unsorted references.</a></li>
  </ul></li>
  <li><a href="#robotrader-in-fa-brands-python" id="toc-robotrader-in-fa-brands-python" class="nav-link" data-scroll-target="#robotrader-in-fa-brands-python"><span class="header-section-number">6</span> Robotrader in <i class="fa-brands fa-python" aria-label="python"></i></a>
  <ul class="collapse">
  <li><a href="#download-the-data." id="toc-download-the-data." class="nav-link" data-scroll-target="#download-the-data."><span class="header-section-number">6.1</span> Download the data.</a></li>
  <li><a href="#visualize-the-data." id="toc-visualize-the-data." class="nav-link" data-scroll-target="#visualize-the-data."><span class="header-section-number">6.2</span> Visualize the data.</a></li>
  <li><a href="#simple-moving-averages." id="toc-simple-moving-averages." class="nav-link" data-scroll-target="#simple-moving-averages."><span class="header-section-number">6.3</span> Simple moving averages.</a></li>
  <li><a href="#preliminaries-to-classify-returns." id="toc-preliminaries-to-classify-returns." class="nav-link" data-scroll-target="#preliminaries-to-classify-returns."><span class="header-section-number">6.4</span> Preliminaries to classify returns.</a></li>
  <li><a href="#set-up-the-model." id="toc-set-up-the-model." class="nav-link" data-scroll-target="#set-up-the-model."><span class="header-section-number">6.5</span> Set up the model.</a></li>
  <li><a href="#evalute-the-model." id="toc-evalute-the-model." class="nav-link" data-scroll-target="#evalute-the-model."><span class="header-section-number">6.6</span> Evalute the model.</a></li>
  <li><a href="#visualize-the-results." id="toc-visualize-the-results." class="nav-link" data-scroll-target="#visualize-the-results."><span class="header-section-number">6.7</span> Visualize the results.</a></li>
  </ul></li>
  <li><a href="#references." id="toc-references." class="nav-link" data-scroll-target="#references.">References.</a></li>
  </ul>
</nav>
</div>
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar zindex-bottom">
</div>
<main class="content column-page-right" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">Forecasting with <i class="fa-brands fa-r-project" aria-label="r-project"></i> <span style="color:white">R</span></h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li></ul></div></div>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Dr.&nbsp;Martín Lozano. </p>
          </div>
  </div>
    
  
    <div>
    <div class="quarto-title-meta-heading">Modified</div>
    <div class="quarto-title-meta-contents">
      <p class="date-modified">January 9, 2024, 00:30:32 am.</p>
    </div>
  </div>
    
  </div>
  
<div>
  <div class="abstract">
    <div class="abstract-title">Abstract</div>
    This material relies on <span class="citation" data-cites="hull2020machine">Hull (<a href="#ref-hull2020machine" role="doc-biblioref">2020</a>)</span>, <span class="citation" data-cites="hyndman2021forecasting">Hyndman and Athanasopoulos (<a href="#ref-hyndman2021forecasting" role="doc-biblioref">2021</a>)</span>, and on Matt Dancho Business Science IO freely available codes in R that explains how to implement machine learning workflow using H2O. Some mathematical background is skipped to emphasize the data analysis, model logic, discussion, graphical approach and R coding <span class="citation" data-cites="Rref">(<a href="#ref-Rref" role="doc-biblioref">R Core Team 2024</a>)</span>. As in the philosophy of <span class="citation" data-cites="knuth1984literate">Knuth (<a href="#ref-knuth1984literate" role="doc-biblioref">1984</a>)</span>, the objective of this document is to explain to human beings what we want a computer to do as literate programming. This is a work in progress and it is under revision.
  </div>
</div>

</header>


<br>
<p align="right"> 
  <a href="https://mlozanoqf.github.io/">
    <span style="color: black">Back to Quantitative Finance with </span>
    <img src="https://cdn.jsdelivr.net/npm/simple-icons@3.0.1/icons/r.svg" alt="R Icon" style="width: 30px; height: 30px;">
  </a>
</p>

<p align="right"> 
    <a href="https://github.com/mlozanoqf" target="blank"><img align="center" src="https://cdn.jsdelivr.net/npm/simple-icons@3.0.1/icons/github.svg" alt="martin-lozano-21818a22" height="20" width="30"></a>
    <a href="https://ssrn.com/author=1490785" target="blank"><img align="center" src="./ssrn.svg" height="90" width="30"></a>
    <a href="mailto:mlozanoqf@gmail.com" target="blank"><img align="center" src="./envelope-solid.svg" alt="mailto:mlozanoqf@gmail.com" height="20" width="30"></a>
    <a href="https://linkedin.com/in/martin-lozano-21818a22" target="blank"><img align="center" src="https://cdn.jsdelivr.net/npm/simple-icons@3.0.1/icons/linkedin.svg" alt="martin-lozano-21818a22" height="20" width="30"></a>
    <a href="https://www.youtube.com/user/drmartinlozano" target="blank"><img align="center" src="https://cdn.jsdelivr.net/npm/simple-icons@3.0.1/icons/youtube.svg" alt="https://www.youtube.com/channel/drmartinlozano" height="20" width="30"></a>
    <a href="https://scholar.google.com/citations?user=w8boOboAAAAJ&amp;hl=en" target="blank"><img align="center" src="./google-scholar.svg" height="30" width="25"></a>
    <a href="https://sites.google.com/site/mlozanoqf" target="blank"><img align="center" src="https://cdn.jsdelivr.net/npm/simple-icons@3.0.1/icons/icloud.svg" alt="https://www.youtube.com/channel/drmartinlozano" height="20" width="30"></a>
    <a href="https://us02web.zoom.us/j/9209945512" target="blank"><img align="center" src="https://cdn.jsdelivr.net/npm/simple-icons@3.0.1/icons/zoom.svg" alt="zoom" height="60" width="50"></a>
</p>

<hr style="border:2px solid gray">

<section id="introduction." class="level1 unnumbered">
<h1 class="unnumbered">Introduction.</h1>
<p>Forecast methods are essential in business and finance for strategic decision-making, efficient resource allocation, and financial planning. Accurate forecasts enable organizations to identify and manage risks, attract investor confidence, stay competitive in the market, optimize supply chains, and evaluate performance against benchmarks. By anticipating changes in the business environment, businesses can adapt proactively and comply with regulatory requirements. Overall, forecasting provides a structured approach to planning, allowing businesses to navigate uncertainties and achieve long-term success.</p>
</section>
<section id="the-forecast-problem." class="level1" data-number="1">
<h1 data-number="1"><span class="header-section-number">1</span> The forecast problem.</h1>
<p>The problem is to forecast a time series. In particular, the time series is the <em>Beer, Wine, and Distilled Alcoholic Beverages Sales</em> as in the original Matt Dancho’s example. The data is taken from FRED (Federal Reserve Economic Data). The data belongs to the non-durable goods category, it includes U.S. merchant wholesalers, except manufacturers’ sales branches and offices sales. The monthly time series goes from 2010-01-01 to 2022-10-31. And the goal is to use 2022 data (10 months) as a test data to conduct the forecast.</p>
<p>For the full database details see: https://fred.stlouisfed.org/series/S4248SM144NCEN</p>
<p>Before start, see: What is forecasting?</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1"></a><span class="fu">embed_url</span>(<span class="st">"https://youtu.be/zvd9oboayEc?si=DfK9JkSqapE8JHiw"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="vembedr">
<div>
<iframe src="https://www.youtube.com/embed/zvd9oboayEc" width="533" height="300" frameborder="0" allowfullscreen="" data-external="1"></iframe>
</div>
</div>
</div>
</div>
<section id="the-data." class="level2" data-number="1.1">
<h2 data-number="1.1" class="anchored" data-anchor-id="the-data."><span class="header-section-number">1.1</span> The data.</h2>
<p>Let’s load the R packages.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1"></a><span class="co"># Load libraries</span></span>
<span id="cb2-2"><a href="#cb2-2"></a><span class="fu">library</span>(fpp3)</span>
<span id="cb2-3"><a href="#cb2-3"></a><span class="fu">library</span>(h2o)        <span class="co"># ML Library.</span></span>
<span id="cb2-4"><a href="#cb2-4"></a><span class="fu">library</span>(timetk)     <span class="co"># Toolkit for working with time series in R.</span></span>
<span id="cb2-5"><a href="#cb2-5"></a><span class="fu">library</span>(tidyquant)  <span class="co"># Loads tidyverse, financial pkgs, used to get data.</span></span>
<span id="cb2-6"><a href="#cb2-6"></a><span class="fu">library</span>(dplyr)      <span class="co"># Database manipulation.</span></span>
<span id="cb2-7"><a href="#cb2-7"></a><span class="fu">library</span>(ggplot2)    <span class="co"># Plots.</span></span>
<span id="cb2-8"><a href="#cb2-8"></a><span class="fu">library</span>(tibble)     <span class="co"># Tables.</span></span>
<span id="cb2-9"><a href="#cb2-9"></a><span class="fu">library</span>(kableExtra) <span class="co"># Tables.</span></span>
<span id="cb2-10"><a href="#cb2-10"></a><span class="fu">library</span>(knitr)      </span>
<span id="cb2-11"><a href="#cb2-11"></a><span class="fu">library</span>(bit64)      <span class="co"># Useful in the machine learning workflow.</span></span>
<span id="cb2-12"><a href="#cb2-12"></a><span class="fu">library</span>(sweep)      <span class="co"># Broom-style tidiers for the forecast package.</span></span>
<span id="cb2-13"><a href="#cb2-13"></a><span class="fu">library</span>(forecast)   <span class="co"># Forecasting models and predictions package.</span></span>
<span id="cb2-14"><a href="#cb2-14"></a><span class="fu">library</span>(seasonal)</span>
<span id="cb2-15"><a href="#cb2-15"></a><span class="fu">library</span>(tictoc)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>We can conveniently download the data directly from the FRED API in one line of code.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1"></a><span class="co"># Beer, Wine, Distilled Alcoholic Beverages, in Millions USD.</span></span>
<span id="cb3-2"><a href="#cb3-2"></a>beer <span class="ot">&lt;-</span> <span class="fu">tq_get</span>(<span class="st">"S4248SM144NCEN"</span>, <span class="at">get =</span> <span class="st">"economic.data"</span>, </span>
<span id="cb3-3"><a href="#cb3-3"></a>               <span class="at">from =</span> <span class="st">"2010-01-01"</span>, <span class="at">to =</span> <span class="st">"2022-10-31"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Let’s have a look of the data set. By default it says <em>price</em>, but these are sales figures in monetary terms. According to the main FRED reference, these are in millions of dollars, not seasonally adjusted.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1"></a><span class="fu">head</span>(beer)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 3
  symbol         date       price
  &lt;chr&gt;          &lt;date&gt;     &lt;int&gt;
1 S4248SM144NCEN 2010-01-01  6558
2 S4248SM144NCEN 2010-02-01  7481
3 S4248SM144NCEN 2010-03-01  9475
4 S4248SM144NCEN 2010-04-01  9424
5 S4248SM144NCEN 2010-05-01  9351
6 S4248SM144NCEN 2010-06-01 10552</code></pre>
</div>
</div>
<p>We can change the name of the price column.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1"></a>beer <span class="ot">&lt;-</span> beer <span class="sc">%&gt;%</span></span>
<span id="cb6-2"><a href="#cb6-2"></a>  <span class="fu">rename</span>(<span class="at">sales =</span> price)</span>
<span id="cb6-3"><a href="#cb6-3"></a></span>
<span id="cb6-4"><a href="#cb6-4"></a><span class="fu">tail</span>(beer)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 3
  symbol         date       sales
  &lt;chr&gt;          &lt;date&gt;     &lt;int&gt;
1 S4248SM144NCEN 2022-05-01 16755
2 S4248SM144NCEN 2022-06-01 17882
3 S4248SM144NCEN 2022-07-01 15168
4 S4248SM144NCEN 2022-08-01 16977
5 S4248SM144NCEN 2022-09-01 16430
6 S4248SM144NCEN 2022-10-01 15480</code></pre>
</div>
</div>
<p>Better now.</p>
<p>Visualization is particularly important for time series analysis and forecasting. It’s a good idea to identify spots where we will split the data into training and test. This kind of split is consistent with most machine learning algorithms. The <em>training</em> dataset is the sample of data used to fit and train the model by learning from the data. The <em>test</em> dataset is the sample of data used to provide an unbiased evaluation of a final model fit on the training dataset. The test dataset provides the gold standard used to evaluate the model. It is only used once a model is completely trained. The test set is generally what is used to evaluate competing models.</p>
<p>It is also important to see the time series because normally the models will perform better if we can identify basic characteristics such as trend and seasonality. This data set clearly has a trend and a seasonality as people drink more alcohol in December.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1"></a>beer <span class="sc">%&gt;%</span></span>
<span id="cb8-2"><a href="#cb8-2"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(date, sales)) <span class="sc">+</span></span>
<span id="cb8-3"><a href="#cb8-3"></a>  <span class="co"># Train Region:</span></span>
<span id="cb8-4"><a href="#cb8-4"></a>  <span class="fu">annotate</span>(<span class="st">"text"</span>, <span class="at">x =</span> <span class="fu">ymd</span>(<span class="st">"2013-01-01"</span>), <span class="at">y =</span> <span class="dv">14000</span>, </span>
<span id="cb8-5"><a href="#cb8-5"></a>           <span class="at">color =</span> <span class="st">"black"</span>, <span class="at">label =</span> <span class="st">"Train region"</span>) <span class="sc">+</span></span>
<span id="cb8-6"><a href="#cb8-6"></a>  <span class="fu">geom_rect</span>(<span class="at">xmin =</span> <span class="fu">as.numeric</span>(<span class="fu">ymd</span>(<span class="st">"2022-01-01"</span>)), </span>
<span id="cb8-7"><a href="#cb8-7"></a>            <span class="at">xmax =</span> <span class="fu">as.numeric</span>(<span class="fu">ymd</span>(<span class="st">"2022-09-30"</span>)), <span class="at">ymin =</span> <span class="dv">0</span>, <span class="at">ymax =</span> <span class="dv">20000</span>, </span>
<span id="cb8-8"><a href="#cb8-8"></a>            <span class="at">alpha =</span> <span class="fl">0.02</span>, <span class="at">fill =</span> <span class="st">"pink"</span>) <span class="sc">+</span></span>
<span id="cb8-9"><a href="#cb8-9"></a>  <span class="fu">annotate</span>(<span class="st">"text"</span>, <span class="at">x =</span> <span class="fu">ymd</span>(<span class="st">"2022-06-01"</span>), <span class="at">y =</span> <span class="dv">9000</span>,</span>
<span id="cb8-10"><a href="#cb8-10"></a>           <span class="at">color =</span> <span class="st">"black"</span>, <span class="at">label =</span> <span class="st">"Test</span><span class="sc">\n</span><span class="st">region"</span>) <span class="sc">+</span></span>
<span id="cb8-11"><a href="#cb8-11"></a>  <span class="co"># Data.</span></span>
<span id="cb8-12"><a href="#cb8-12"></a>  <span class="fu">geom_line</span>(<span class="at">col =</span> <span class="st">"black"</span>) <span class="sc">+</span></span>
<span id="cb8-13"><a href="#cb8-13"></a>  <span class="fu">geom_point</span>(<span class="at">col =</span> <span class="st">"black"</span>, <span class="at">alpha =</span> <span class="fl">0.5</span>, <span class="at">size =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb8-14"><a href="#cb8-14"></a>  <span class="co"># Aesthetics.</span></span>
<span id="cb8-15"><a href="#cb8-15"></a>  <span class="fu">theme_tq</span>() <span class="sc">+</span></span>
<span id="cb8-16"><a href="#cb8-16"></a>  <span class="fu">scale_x_date</span>(<span class="at">date_breaks =</span> <span class="st">"1 year"</span>, <span class="at">date_labels =</span> <span class="st">"%Y"</span>) <span class="sc">+</span></span>
<span id="cb8-17"><a href="#cb8-17"></a>  <span class="fu">labs</span>(<span class="at">subtitle =</span> </span>
<span id="cb8-18"><a href="#cb8-18"></a>  <span class="st">"Train (2010 - 2021), and test set (Jan 2022 to Oct 2022)"</span>,</span>
<span id="cb8-19"><a href="#cb8-19"></a>  <span class="at">x =</span> <span class="st">"Date"</span>, <span class="at">y =</span> <span class="st">"Sales"</span>,</span>
<span id="cb8-20"><a href="#cb8-20"></a>       <span class="at">caption =</span> <span class="st">"The models do not know the test region, this is for us </span></span>
<span id="cb8-21"><a href="#cb8-21"></a><span class="st">       to see how well the models do the 10-month ahead forecast."</span>) <span class="sc">+</span></span>
<span id="cb8-22"><a href="#cb8-22"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">labels =</span> scales<span class="sc">::</span>dollar)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-bwadabs" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="index_files/figure-html/fig-bwadabs-1.png" class="img-fluid figure-img" width="672"></p>
<figcaption class="figure-caption">Figure&nbsp;1.1: Beer, Wine, and Distilled Alcoholic Beverages Sales.</figcaption>
</figure>
</div>
</div>
</div>
<p>Then, the problem is to forecast the 10 months of the test region. This is, from January to October 2022.</p>
<p>Here is a zoom version of the plot above.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1"></a>beer <span class="sc">%&gt;%</span></span>
<span id="cb9-2"><a href="#cb9-2"></a>  <span class="fu">filter</span>(date <span class="sc">&gt;</span> <span class="fu">as.Date</span>(<span class="st">"2020-01-01"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb9-3"><a href="#cb9-3"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(date, sales)) <span class="sc">+</span></span>
<span id="cb9-4"><a href="#cb9-4"></a>  <span class="fu">annotate</span>(<span class="st">"text"</span>, <span class="at">x =</span> <span class="fu">ymd</span>(<span class="st">"2020-08-01"</span>), <span class="at">y =</span> <span class="dv">17000</span>, </span>
<span id="cb9-5"><a href="#cb9-5"></a>           <span class="at">color =</span> <span class="st">"black"</span>, <span class="at">label =</span> <span class="st">"Train region"</span>) <span class="sc">+</span></span>
<span id="cb9-6"><a href="#cb9-6"></a>  <span class="fu">geom_rect</span>(<span class="at">xmin =</span> <span class="fu">as.numeric</span>(<span class="fu">ymd</span>(<span class="st">"2022-01-01"</span>)), </span>
<span id="cb9-7"><a href="#cb9-7"></a>            <span class="at">xmax =</span> <span class="fu">as.numeric</span>(<span class="fu">ymd</span>(<span class="st">"2022-09-30"</span>)), <span class="at">ymin =</span> <span class="dv">0</span>, <span class="at">ymax =</span> <span class="dv">20000</span>, </span>
<span id="cb9-8"><a href="#cb9-8"></a>            <span class="at">alpha =</span> <span class="fl">0.02</span>, <span class="at">fill =</span> <span class="st">"pink"</span>) <span class="sc">+</span></span>
<span id="cb9-9"><a href="#cb9-9"></a>  <span class="fu">annotate</span>(<span class="st">"text"</span>, <span class="at">x =</span> <span class="fu">ymd</span>(<span class="st">"2022-05-01"</span>), <span class="at">y =</span> <span class="dv">14000</span>,</span>
<span id="cb9-10"><a href="#cb9-10"></a>           <span class="at">color =</span> <span class="st">"black"</span>, <span class="at">label =</span> <span class="st">"Test region"</span>) <span class="sc">+</span></span>
<span id="cb9-11"><a href="#cb9-11"></a>  <span class="fu">geom_line</span>(<span class="at">col =</span> <span class="st">"black"</span>) <span class="sc">+</span></span>
<span id="cb9-12"><a href="#cb9-12"></a>  <span class="fu">geom_point</span>(<span class="at">col =</span> <span class="st">"black"</span>, <span class="at">alpha =</span> <span class="fl">0.5</span>, <span class="at">size =</span> <span class="dv">5</span>) <span class="sc">+</span></span>
<span id="cb9-13"><a href="#cb9-13"></a>  <span class="fu">theme_tq</span>() <span class="sc">+</span></span>
<span id="cb9-14"><a href="#cb9-14"></a>  <span class="fu">scale_x_date</span>(<span class="at">date_breaks =</span> <span class="st">"1 year"</span>, <span class="at">date_labels =</span> <span class="st">"%Y"</span>) <span class="sc">+</span></span>
<span id="cb9-15"><a href="#cb9-15"></a>  <span class="fu">labs</span>(<span class="at">subtitle =</span> </span>
<span id="cb9-16"><a href="#cb9-16"></a>  <span class="st">"Train (2010 - 2021) and test set (Jan 2022 to Oct 2022)"</span>,</span>
<span id="cb9-17"><a href="#cb9-17"></a>  <span class="at">x =</span> <span class="st">"Date"</span>, <span class="at">y =</span> <span class="st">"Sales"</span>,</span>
<span id="cb9-18"><a href="#cb9-18"></a>       <span class="at">caption =</span> <span class="st">"The models do not know the test region, this is for us </span></span>
<span id="cb9-19"><a href="#cb9-19"></a><span class="st">       to see how well the models do the 10-month ahead forecast."</span>) <span class="sc">+</span></span>
<span id="cb9-20"><a href="#cb9-20"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">labels =</span> scales<span class="sc">::</span>dollar)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-zbwadabs" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="index_files/figure-html/fig-zbwadabs-1.png" class="img-fluid figure-img" width="672"></p>
<figcaption class="figure-caption">Figure&nbsp;1.2: Zoom: Beer, Wine, and Distilled Alcoholic Beverages Sales.</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="time-series-properties." class="level2" data-number="1.2">
<h2 data-number="1.2" class="anchored" data-anchor-id="time-series-properties."><span class="header-section-number">1.2</span> Time series properties.</h2>
<p>The forecasting techniques are expected to exploit the time-series components like trend and seasonal component. Here we use the <span class="citation" data-cites="hyndman2021forecasting">Hyndman and Athanasopoulos (<a href="#ref-hyndman2021forecasting" role="doc-biblioref">2021</a>)</span> <tt><code>fpp3</code></tt> package to learn about the time series properties before conducting the forecast techniques. In order to use the <tt><code>fpp3</code></tt> package, we have to transform <tt><code>beer</code></tt> from a <tt><code>tibble</code></tt> to a <tt><code>tsibble</code></tt> object.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1"></a>beer_tbls <span class="ot">&lt;-</span> beer</span>
<span id="cb10-2"><a href="#cb10-2"></a>beer_tbls<span class="sc">$</span>date <span class="ot">&lt;-</span> <span class="fu">yearmonth</span>(beer_tbls<span class="sc">$</span>date)</span>
<span id="cb10-3"><a href="#cb10-3"></a>beer_tbls <span class="ot">&lt;-</span> <span class="fu">as_tsibble</span>(beer_tbls)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>According to <span class="citation" data-cites="hyndman2021forecasting">Hyndman and Athanasopoulos (<a href="#ref-hyndman2021forecasting" role="doc-biblioref">2021</a>)</span>, the X-11 method was originated in the US Census Bureau and further developed by Statistics Canada. The decomposition process tends to be highly robust to outliers and level shifts in the time series. The details of the X-11 method are described in <span class="citation" data-cites="dagum2016seasonal">Dagum and Bianconcini (<a href="#ref-dagum2016seasonal" role="doc-biblioref">2016</a>)</span>.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1"></a>beer_tbls <span class="sc">%&gt;%</span></span>
<span id="cb11-2"><a href="#cb11-2"></a>  <span class="fu">model</span>(<span class="at">x11 =</span> <span class="fu">X_13ARIMA_SEATS</span>(sales <span class="sc">~</span> <span class="fu">x11</span>())) <span class="sc">%&gt;%</span></span>
<span id="cb11-3"><a href="#cb11-3"></a>  <span class="fu">components</span>() <span class="sc">%&gt;%</span></span>
<span id="cb11-4"><a href="#cb11-4"></a>  <span class="fu">autoplot</span>() <span class="sc">+</span></span>
<span id="cb11-5"><a href="#cb11-5"></a>  <span class="fu">labs</span>(<span class="at">y =</span> <span class="st">"Sales"</span>, <span class="at">x =</span> <span class="st">"Date"</span>) <span class="sc">+</span></span>
<span id="cb11-6"><a href="#cb11-6"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">labels =</span> scales<span class="sc">::</span>dollar)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-amdobsux" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="index_files/figure-html/fig-amdobsux-1.png" class="img-fluid figure-img" width="672"></p>
<figcaption class="figure-caption">Figure&nbsp;1.3: A multiplicative decomposition of beer sales using X-11.</figcaption>
</figure>
</div>
</div>
</div>
<p>The trend shows a clear change in the first half of 2020. Let’s take a look of it.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1"></a>beer_tbls <span class="sc">%&gt;%</span></span>
<span id="cb12-2"><a href="#cb12-2"></a>  <span class="fu">model</span>(<span class="at">x11 =</span> <span class="fu">X_13ARIMA_SEATS</span>(sales <span class="sc">~</span> <span class="fu">x11</span>())) <span class="sc">%&gt;%</span></span>
<span id="cb12-3"><a href="#cb12-3"></a>  <span class="fu">components</span>() <span class="sc">%&gt;%</span></span>
<span id="cb12-4"><a href="#cb12-4"></a>  <span class="fu">select</span>(date, sales, trend) <span class="sc">%&gt;%</span></span>
<span id="cb12-5"><a href="#cb12-5"></a>  <span class="fu">filter_index</span>(<span class="st">"2020-03"</span> <span class="sc">~</span> <span class="st">"2020-10"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb12-6"><a href="#cb12-6"></a>  <span class="fu">head</span>(<span class="dv">8</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tsibble: 8 x 3 [1M]
       date sales  trend
      &lt;mth&gt; &lt;dbl&gt;  &lt;dbl&gt;
1 2020 mar. 13308 13656.
2 2020 abr. 12167 13728.
3 2020 may. 13925 13805.
4 2020 jun. 16032 13874.
5 2020 jul. 15598 15290.
6 2020 ago. 15217 15300.
7 2020 sep. 15449 15286.
8 2020 oct. 16139 15253.</code></pre>
</div>
</div>
<p>The consumption trend significantly increased from June 2020 to July 2020. It is big enough to create a discontinuity in the trend plot below.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1"></a>beer_tbls <span class="sc">%&gt;%</span></span>
<span id="cb14-2"><a href="#cb14-2"></a>  <span class="fu">model</span>(<span class="at">x11 =</span> <span class="fu">X_13ARIMA_SEATS</span>(sales <span class="sc">~</span> <span class="fu">x11</span>())) <span class="sc">%&gt;%</span></span>
<span id="cb14-3"><a href="#cb14-3"></a>  <span class="fu">components</span>() <span class="sc">%&gt;%</span></span>
<span id="cb14-4"><a href="#cb14-4"></a>  <span class="fu">select</span>(date, trend) <span class="sc">%&gt;%</span></span>
<span id="cb14-5"><a href="#cb14-5"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="fu">yearmonth</span>(date), trend)) <span class="sc">+</span> </span>
<span id="cb14-6"><a href="#cb14-6"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.3</span>, <span class="at">size =</span> <span class="dv">4</span>) <span class="sc">+</span></span>
<span id="cb14-7"><a href="#cb14-7"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">yearmonth</span>(<span class="st">"2020 jun."</span>), <span class="at">y =</span> <span class="fl">13950.99</span>), </span>
<span id="cb14-8"><a href="#cb14-8"></a>             <span class="at">alpha =</span> <span class="fl">0.3</span>, <span class="at">size =</span> <span class="dv">4</span>, <span class="at">colour =</span> <span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb14-9"><a href="#cb14-9"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">yearmonth</span>(<span class="st">"2020 jul."</span>), <span class="at">y =</span> <span class="fl">15356.13</span>), </span>
<span id="cb14-10"><a href="#cb14-10"></a>             <span class="at">alpha =</span> <span class="fl">0.3</span>, <span class="at">size =</span> <span class="dv">4</span>, <span class="at">colour =</span> <span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb14-11"><a href="#cb14-11"></a>  <span class="fu">labs</span>(<span class="at">y =</span> <span class="st">"Trend"</span>, <span class="at">x =</span> <span class="st">"Date"</span>) <span class="sc">+</span></span>
<span id="cb14-12"><a href="#cb14-12"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">labels =</span> scales<span class="sc">::</span>dollar)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-td" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="index_files/figure-html/fig-td-1.png" class="img-fluid figure-img" width="672"></p>
<figcaption class="figure-caption">Figure&nbsp;1.4: Trend discontinuity.</figcaption>
</figure>
</div>
</div>
</div>
<p>There are also three negative spikes in the irregular component.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1"></a>beer_tbls <span class="sc">%&gt;%</span></span>
<span id="cb15-2"><a href="#cb15-2"></a>  <span class="fu">model</span>(<span class="at">x11 =</span> <span class="fu">X_13ARIMA_SEATS</span>(sales <span class="sc">~</span> <span class="fu">x11</span>())) <span class="sc">%&gt;%</span></span>
<span id="cb15-3"><a href="#cb15-3"></a>  <span class="fu">components</span>() <span class="sc">%&gt;%</span></span>
<span id="cb15-4"><a href="#cb15-4"></a>  <span class="fu">select</span>(date, sales, irregular) <span class="sc">%&gt;%</span></span>
<span id="cb15-5"><a href="#cb15-5"></a>  <span class="fu">filter</span>(irregular <span class="sc">&lt;</span> <span class="fl">0.95</span>) <span class="sc">%&gt;%</span></span>
<span id="cb15-6"><a href="#cb15-6"></a>  <span class="fu">head</span>(<span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tsibble: 3 x 3 [1M]
       date sales irregular
      &lt;mth&gt; &lt;dbl&gt;     &lt;dbl&gt;
1 2020 abr. 12167     0.889
2 2020 dic. 16309     0.867
3 2021 dic. 18211     0.909</code></pre>
</div>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1"></a>beer_tbls <span class="sc">%&gt;%</span></span>
<span id="cb17-2"><a href="#cb17-2"></a>  <span class="fu">model</span>(<span class="at">x11 =</span> <span class="fu">X_13ARIMA_SEATS</span>(sales <span class="sc">~</span> <span class="fu">x11</span>())) <span class="sc">%&gt;%</span></span>
<span id="cb17-3"><a href="#cb17-3"></a>  <span class="fu">components</span>() <span class="sc">%&gt;%</span></span>
<span id="cb17-4"><a href="#cb17-4"></a>  <span class="fu">select</span>(date, irregular) <span class="sc">%&gt;%</span></span>
<span id="cb17-5"><a href="#cb17-5"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="fu">yearmonth</span>(date), irregular)) <span class="sc">+</span> </span>
<span id="cb17-6"><a href="#cb17-6"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.3</span>, <span class="at">size =</span> <span class="dv">4</span>) <span class="sc">+</span></span>
<span id="cb17-7"><a href="#cb17-7"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">yearmonth</span>(<span class="st">"2020 apr."</span>), <span class="at">y =</span> <span class="fl">0.8894670</span>), </span>
<span id="cb17-8"><a href="#cb17-8"></a>             <span class="at">alpha =</span> <span class="fl">0.3</span>, <span class="at">size =</span> <span class="dv">4</span>, <span class="at">colour =</span> <span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb17-9"><a href="#cb17-9"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">yearmonth</span>(<span class="st">"2020 dec."</span>), <span class="at">y =</span> <span class="fl">0.8688517</span>), </span>
<span id="cb17-10"><a href="#cb17-10"></a>             <span class="at">alpha =</span> <span class="fl">0.3</span>, <span class="at">size =</span> <span class="dv">4</span>, <span class="at">colour =</span> <span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb17-11"><a href="#cb17-11"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">yearmonth</span>(<span class="st">"2021 dec."</span>), <span class="at">y =</span> <span class="fl">0.9099203</span>), </span>
<span id="cb17-12"><a href="#cb17-12"></a>             <span class="at">alpha =</span> <span class="fl">0.3</span>, <span class="at">size =</span> <span class="dv">4</span>, <span class="at">colour =</span> <span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb17-13"><a href="#cb17-13"></a>  <span class="fu">labs</span>(<span class="at">y =</span> <span class="st">"Irregular"</span>, <span class="at">x =</span> <span class="st">"Date"</span>) <span class="sc">+</span></span>
<span id="cb17-14"><a href="#cb17-14"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">labels =</span> scales<span class="sc">::</span>dollar)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-tnsitic" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="index_files/figure-html/fig-tnsitic-1.png" class="img-fluid figure-img" width="672"></p>
<figcaption class="figure-caption">Figure&nbsp;1.5: Three negative spikes in the irregular component.</figcaption>
</figure>
</div>
</div>
</div>
<p>Apparently, these trend and irregular events are consistent independently of the decomposition technique. We implement the SEATS decomposition below. SEATS stands for <em>Seasonal Extraction in ARIMA Time Series</em>. According to <span class="citation" data-cites="hyndman2021forecasting">Hyndman and Athanasopoulos (<a href="#ref-hyndman2021forecasting" role="doc-biblioref">2021</a>)</span>, this procedure was developed at the Bank of Spain, and is now widely used by government agencies around the world. See <span class="citation" data-cites="dagum2016seasonal">Dagum and Bianconcini (<a href="#ref-dagum2016seasonal" role="doc-biblioref">2016</a>)</span> for further details.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1"></a>beer_tbls <span class="sc">%&gt;%</span></span>
<span id="cb18-2"><a href="#cb18-2"></a>  <span class="fu">model</span>(<span class="at">seats =</span> <span class="fu">X_13ARIMA_SEATS</span>(sales <span class="sc">~</span> <span class="fu">seats</span>())) <span class="sc">%&gt;%</span></span>
<span id="cb18-3"><a href="#cb18-3"></a>  <span class="fu">components</span>() <span class="sc">%&gt;%</span></span>
<span id="cb18-4"><a href="#cb18-4"></a>  <span class="fu">autoplot</span>() <span class="sc">+</span></span>
<span id="cb18-5"><a href="#cb18-5"></a>  <span class="fu">labs</span>(<span class="at">y =</span> <span class="st">"Sales"</span>, <span class="at">x =</span> <span class="st">"Date"</span>) <span class="sc">+</span></span>
<span id="cb18-6"><a href="#cb18-6"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">labels =</span> scales<span class="sc">::</span>dollar)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-adobsous" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="index_files/figure-html/fig-adobsous-1.png" class="img-fluid figure-img" width="672"></p>
<figcaption class="figure-caption">Figure&nbsp;1.6: A decomposition of beer sales obtained using SEATS.</figcaption>
</figure>
</div>
</div>
</div>
<p>A seasonal plot is similar to a time plot except that the data are plotted against the individual <em>seasons</em>, in this case months, in which the data were observed.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1"></a>beer_tbls <span class="sc">%&gt;%</span></span>
<span id="cb19-2"><a href="#cb19-2"></a>  <span class="fu">gg_season</span>(sales, <span class="at">labels =</span> <span class="st">"both"</span>) <span class="sc">+</span></span>
<span id="cb19-3"><a href="#cb19-3"></a>  <span class="fu">labs</span>(<span class="at">y =</span> <span class="st">"Sales"</span>, <span class="at">x =</span> <span class="st">"Date"</span>) <span class="sc">+</span></span>
<span id="cb19-4"><a href="#cb19-4"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">labels =</span> scales<span class="sc">::</span>dollar)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-spbs" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="index_files/figure-html/fig-spbs-1.png" class="img-fluid figure-img" width="672"></p>
<figcaption class="figure-caption">Figure&nbsp;1.7: Seasonal plot: Beer sales.</figcaption>
</figure>
</div>
</div>
</div>
<p>And this is the zoom version of the plot above.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1"></a>beer_tbls <span class="sc">%&gt;%</span></span>
<span id="cb20-2"><a href="#cb20-2"></a>  <span class="fu">filter_index</span>(<span class="st">"2019-01"</span> <span class="sc">~</span> .) <span class="sc">%&gt;%</span></span>
<span id="cb20-3"><a href="#cb20-3"></a>  <span class="fu">gg_season</span>(sales, <span class="at">labels =</span> <span class="st">"both"</span>, <span class="at">size =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb20-4"><a href="#cb20-4"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb20-5"><a href="#cb20-5"></a>  <span class="fu">labs</span>(<span class="at">y =</span> <span class="st">"Sales"</span>, <span class="at">x =</span> <span class="st">"Date"</span>) <span class="sc">+</span></span>
<span id="cb20-6"><a href="#cb20-6"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">labels =</span> scales<span class="sc">::</span>dollar)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-zspbs" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="index_files/figure-html/fig-zspbs-1.png" class="img-fluid figure-img" width="672"></p>
<figcaption class="figure-caption">Figure&nbsp;1.8: Zoom. Seasonal plot: Beer sales.</figcaption>
</figure>
</div>
</div>
</div>
<p>An alternative plot that emphasises the seasonal patterns is where the data for each month are collected together in separate mini time plots.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1"></a>beer_tbls <span class="sc">%&gt;%</span></span>
<span id="cb21-2"><a href="#cb21-2"></a>  <span class="fu">gg_subseries</span>(sales) <span class="sc">+</span></span>
<span id="cb21-3"><a href="#cb21-3"></a>  <span class="fu">labs</span>(<span class="at">y =</span> <span class="st">"Sales"</span>, <span class="at">x =</span> <span class="st">"Date"</span>) <span class="sc">+</span></span>
<span id="cb21-4"><a href="#cb21-4"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">labels =</span> scales<span class="sc">::</span>dollar)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-sspombs" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="index_files/figure-html/fig-sspombs-1.png" class="img-fluid figure-img" width="672"></p>
<figcaption class="figure-caption">Figure&nbsp;1.9: Seasonal subseries plot of monthly beer sales.</figcaption>
</figure>
</div>
</div>
</div>
<p>December is the month of the year with the highest average sales, followed by June. January is the month of the year with the lowest average sales, followed by February.</p>
<p>Following <span class="citation" data-cites="hyndman2021forecasting">Hyndman and Athanasopoulos (<a href="#ref-hyndman2021forecasting" role="doc-biblioref">2021</a>)</span>, just as correlation measures the extent of a linear relationship between two variables, autocorrelation measures the linear relationship between lagged values of a time series. When data have a trend, the autocorrelations for small lags tend to be large and positive because observations nearby in time are also nearby in value. So the ACF of a trended time series tends to have positive values that slowly decrease as the lags increase. When data are seasonal, the autocorrelations will be larger for the seasonal lags (at multiples of the seasonal period, in this case 12) than for other lags.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1"></a>beer_tbls <span class="sc">%&gt;%</span></span>
<span id="cb22-2"><a href="#cb22-2"></a>  <span class="fu">ACF</span>(sales, <span class="at">lag_max =</span> <span class="dv">60</span>) <span class="sc">%&gt;%</span></span>
<span id="cb22-3"><a href="#cb22-3"></a>  <span class="fu">autoplot</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-aombs" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="index_files/figure-html/fig-aombs-1.png" class="img-fluid figure-img" width="672"></p>
<figcaption class="figure-caption">Figure&nbsp;1.10: ACF of monthly beer sales.</figcaption>
</figure>
</div>
</div>
</div>
<p>Beer sales is both trended and seasonal. The slow decrease in the ACF as the lags increase is due to the trend, while the <em>scalloped</em> shape is due to the seasonality.</p>
</section>
</section>
<section id="forecasts-with-fpp3." class="level1" data-number="2">
<h1 data-number="2"><span class="header-section-number">2</span> Forecasts with <tt><code>fpp3</code></tt>.</h1>
<p>Here we implement some selected forecast techniques using the <span class="citation" data-cites="hyndman2021forecasting">Hyndman and Athanasopoulos (<a href="#ref-hyndman2021forecasting" role="doc-biblioref">2021</a>)</span> <tt><code>fpp3</code></tt> package. First define the training and test set (2022).</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1"></a>beer_train <span class="ot">&lt;-</span> beer_tbls <span class="sc">%&gt;%</span></span>
<span id="cb23-2"><a href="#cb23-2"></a>  <span class="fu">select</span>(date, sales) <span class="sc">%&gt;%</span></span>
<span id="cb23-3"><a href="#cb23-3"></a>  <span class="fu">filter_index</span>(. <span class="sc">~</span> <span class="st">"2021-12"</span>)</span>
<span id="cb23-4"><a href="#cb23-4"></a></span>
<span id="cb23-5"><a href="#cb23-5"></a>beer_2022 <span class="ot">&lt;-</span> beer_tbls <span class="sc">%&gt;%</span></span>
<span id="cb23-6"><a href="#cb23-6"></a>  <span class="fu">select</span>(date, sales) <span class="sc">%&gt;%</span></span>
<span id="cb23-7"><a href="#cb23-7"></a>  <span class="fu">filter_index</span>(<span class="st">"2022-01"</span> <span class="sc">~</span> .)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<section id="four-simple-techniques." class="level2" data-number="2.1">
<h2 data-number="2.1" class="anchored" data-anchor-id="four-simple-techniques."><span class="header-section-number">2.1</span> Four simple techniques.</h2>
<p>Let’s estimate four simple forecast techniques. <em>Mean</em>, where the forecasts of all future values are equal to the average of the historical data. <em>Naïve</em>, we set all forecasts to be the value of the last observation. <em>Seasonal naïve</em>, we set each forecast to be equal to the last observed value from the same season. And <em>drift</em>, to allow the forecasts to increase or decrease over time.</p>
<p>Estimate the four models.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1"></a>beer_fit <span class="ot">&lt;-</span> beer_train <span class="sc">%&gt;%</span></span>
<span id="cb24-2"><a href="#cb24-2"></a>  <span class="fu">model</span>(<span class="st">"fpp3: mean"</span> <span class="ot">=</span> <span class="fu">MEAN</span>(sales), <span class="st">"fpp3: naïve"</span> <span class="ot">=</span> <span class="fu">NAIVE</span>(sales),</span>
<span id="cb24-3"><a href="#cb24-3"></a>    <span class="st">"fpp3: seasonal naïve"</span> <span class="ot">=</span> <span class="fu">SNAIVE</span>(sales), </span>
<span id="cb24-4"><a href="#cb24-4"></a>    <span class="st">"fpp3: drift"</span> <span class="ot">=</span> <span class="fu">RW</span>(sales <span class="sc">~</span> <span class="fu">drift</span>()))</span>
<span id="cb24-5"><a href="#cb24-5"></a><span class="fu">glance</span>(beer_fit)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 4 × 2
  .model                 sigma2
  &lt;chr&gt;                   &lt;dbl&gt;
1 fpp3: mean           5421556.
2 fpp3: naïve          3256821.
3 fpp3: seasonal naïve  494516.
4 fpp3: drift          3256821.</code></pre>
</div>
</div>
<p>The 10-month forecasts.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1"></a>beer_fc <span class="ot">&lt;-</span> beer_fit <span class="sc">%&gt;%</span></span>
<span id="cb26-2"><a href="#cb26-2"></a>  fabletools<span class="sc">::</span><span class="fu">forecast</span>(<span class="at">h =</span> <span class="st">"10 months"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Let’s compute the MAPE of all forecasts.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1"></a>mape_table <span class="ot">&lt;-</span> fabletools<span class="sc">::</span><span class="fu">accuracy</span>(beer_fc, beer_2022) <span class="sc">%&gt;%</span></span>
<span id="cb27-2"><a href="#cb27-2"></a>  <span class="fu">select</span>(.model, MAPE) <span class="sc">%&gt;%</span></span>
<span id="cb27-3"><a href="#cb27-3"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(<span class="sc">-</span>MAPE))</span>
<span id="cb27-4"><a href="#cb27-4"></a>mape_table</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 4 × 2
  .model                MAPE
  &lt;chr&gt;                &lt;dbl&gt;
1 fpp3: seasonal naïve  3.82
2 fpp3: naïve          18.4 
3 fpp3: drift          21.2 
4 fpp3: mean           23.4 </code></pre>
</div>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1"></a>sn_mape <span class="ot">&lt;-</span> fabletools<span class="sc">::</span><span class="fu">accuracy</span>(beer_fc, beer_2022) <span class="sc">%&gt;%</span></span>
<span id="cb29-2"><a href="#cb29-2"></a>  <span class="fu">filter</span>(.model <span class="sc">==</span> <span class="st">"fpp3: seasonal naïve"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb29-3"><a href="#cb29-3"></a>  <span class="fu">select</span>(MAPE) <span class="sc">%&gt;%</span></span>
<span id="cb29-4"><a href="#cb29-4"></a>  <span class="fu">unlist</span>()</span>
<span id="cb29-5"><a href="#cb29-5"></a>sn_mape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>  MAPE 
3.8227 </code></pre>
</div>
</div>
<p>Let’s plot the forecast results.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1"></a>beer_fc <span class="sc">%&gt;%</span></span>
<span id="cb31-2"><a href="#cb31-2"></a>  <span class="fu">autoplot</span>(beer_tbls, <span class="at">level =</span> <span class="cn">NULL</span>) <span class="sc">+</span></span>
<span id="cb31-3"><a href="#cb31-3"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="fu">as.Date</span>(<span class="st">"2022-01-01"</span>), <span class="at">lty =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb31-4"><a href="#cb31-4"></a>  <span class="fu">labs</span>(<span class="at">y =</span> <span class="st">"Sales"</span>, <span class="at">x =</span> <span class="st">"Date"</span>) <span class="sc">+</span></span>
<span id="cb31-5"><a href="#cb31-5"></a>  <span class="fu">guides</span>(<span class="at">colour =</span> <span class="fu">guide_legend</span>(<span class="at">title =</span> <span class="st">"Forecast:"</span>)) <span class="sc">+</span></span>
<span id="cb31-6"><a href="#cb31-6"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"bottom"</span>) <span class="sc">+</span></span>
<span id="cb31-7"><a href="#cb31-7"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">labels =</span> scales<span class="sc">::</span>dollar)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-ffsf" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="index_files/figure-html/fig-ffsf-1.png" class="img-fluid figure-img" width="672"></p>
<figcaption class="figure-caption">Figure&nbsp;2.1: fpp3: four simple forecasts.</figcaption>
</figure>
</div>
</div>
</div>
<p>The plot above is not very clear. Here is a zoom version.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1"></a>beer_zoom <span class="ot">&lt;-</span> beer_tbls <span class="sc">%&gt;%</span></span>
<span id="cb32-2"><a href="#cb32-2"></a>  <span class="fu">select</span>(date, sales) <span class="sc">%&gt;%</span></span>
<span id="cb32-3"><a href="#cb32-3"></a>  <span class="fu">filter_index</span>(<span class="st">"2019-12"</span> <span class="sc">~</span> .)</span>
<span id="cb32-4"><a href="#cb32-4"></a></span>
<span id="cb32-5"><a href="#cb32-5"></a>beer_fc <span class="sc">%&gt;%</span></span>
<span id="cb32-6"><a href="#cb32-6"></a>  <span class="fu">autoplot</span>(beer_zoom, <span class="at">level =</span> <span class="cn">NULL</span>, <span class="at">lwd =</span> <span class="dv">2</span>)  <span class="sc">+</span></span>
<span id="cb32-7"><a href="#cb32-7"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="fu">as.Date</span>(<span class="st">"2022-01-01"</span>), <span class="at">lty =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb32-8"><a href="#cb32-8"></a>  <span class="fu">labs</span>(<span class="at">y =</span> <span class="st">"Sales"</span>, <span class="at">x =</span> <span class="st">"Date"</span>) <span class="sc">+</span></span>
<span id="cb32-9"><a href="#cb32-9"></a>  <span class="fu">guides</span>(<span class="at">colour =</span> <span class="fu">guide_legend</span>(<span class="at">title =</span> <span class="st">"Forecast:"</span>)) <span class="sc">+</span></span>
<span id="cb32-10"><a href="#cb32-10"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"bottom"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-zffsf" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="index_files/figure-html/fig-zffsf-1.png" class="img-fluid figure-img" width="672"></p>
<figcaption class="figure-caption">Figure&nbsp;2.2: Zoom. fpp3: four simple forecasts.</figcaption>
</figure>
</div>
</div>
</div>
<p>This is the seasonal naïve forecasts.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1"></a>beer_zoom <span class="ot">&lt;-</span> beer_tbls <span class="sc">%&gt;%</span></span>
<span id="cb33-2"><a href="#cb33-2"></a>  <span class="fu">select</span>(date, sales) <span class="sc">%&gt;%</span></span>
<span id="cb33-3"><a href="#cb33-3"></a>  <span class="fu">filter_index</span>(<span class="st">"2019-12"</span> <span class="sc">~</span> .)</span>
<span id="cb33-4"><a href="#cb33-4"></a></span>
<span id="cb33-5"><a href="#cb33-5"></a>beer_sn_fc <span class="ot">&lt;-</span> beer_fc <span class="sc">%&gt;%</span></span>
<span id="cb33-6"><a href="#cb33-6"></a>  <span class="fu">filter</span>(.model <span class="sc">==</span> <span class="st">"fpp3: seasonal naïve"</span>) </span>
<span id="cb33-7"><a href="#cb33-7"></a></span>
<span id="cb33-8"><a href="#cb33-8"></a>  <span class="fu">ggplot</span>(beer_zoom, <span class="fu">aes</span>(<span class="fu">yearmonth</span>(date), sales), <span class="at">lwd =</span> <span class="dv">2</span>, <span class="at">alpha =</span> <span class="fl">0.4</span>) <span class="sc">+</span></span>
<span id="cb33-9"><a href="#cb33-9"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb33-10"><a href="#cb33-10"></a>  <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">5</span>, <span class="at">color =</span> <span class="st">"black"</span>, <span class="at">alpha =</span> <span class="fl">0.5</span>, </span>
<span id="cb33-11"><a href="#cb33-11"></a>             <span class="at">shape =</span> <span class="dv">21</span>, <span class="at">fill =</span> <span class="st">"black"</span>) <span class="sc">+</span></span>
<span id="cb33-12"><a href="#cb33-12"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">y =</span> .mean), <span class="at">size =</span> <span class="dv">5</span>, </span>
<span id="cb33-13"><a href="#cb33-13"></a>             <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">alpha =</span> <span class="fl">0.5</span>, <span class="at">shape =</span> <span class="dv">21</span>, </span>
<span id="cb33-14"><a href="#cb33-14"></a>             <span class="at">fill =</span> <span class="st">"red"</span>, <span class="at">data =</span> beer_sn_fc) <span class="sc">+</span></span>
<span id="cb33-15"><a href="#cb33-15"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> .mean), <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">size =</span> <span class="fl">0.5</span>, <span class="at">data =</span> beer_sn_fc) <span class="sc">+</span></span>
<span id="cb33-16"><a href="#cb33-16"></a>    <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="fu">as.numeric</span>(<span class="fu">as.Date</span>(<span class="st">"2021-12-01"</span>)), </span>
<span id="cb33-17"><a href="#cb33-17"></a>               <span class="at">linetype =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb33-18"><a href="#cb33-18"></a>  <span class="fu">labs</span>(<span class="at">y =</span> <span class="st">"Sales"</span>, <span class="at">x =</span> <span class="st">"Date"</span>,</span>
<span id="cb33-19"><a href="#cb33-19"></a>       <span class="at">caption =</span> <span class="fu">c</span>(<span class="fu">paste</span>(<span class="st">"MAPE="</span>,(<span class="fu">round</span>(sn_mape, <span class="dv">5</span>))))) <span class="sc">+</span></span>
<span id="cb33-20"><a href="#cb33-20"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"bottom"</span>) <span class="sc">+</span></span>
<span id="cb33-21"><a href="#cb33-21"></a>    <span class="fu">scale_y_continuous</span>(<span class="at">labels =</span> scales<span class="sc">::</span>dollar)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-zfsnf" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="index_files/figure-html/fig-zfsnf-1.png" class="img-fluid figure-img" width="672"></p>
<figcaption class="figure-caption">Figure&nbsp;2.3: Zoom. fpp3: seasonal naïve forecasts.</figcaption>
</figure>
</div>
</div>
</div>
<p>The simple techniques are not necessarily bad techniques.</p>
</section>
<section id="exponential-smoothing." class="level2" data-number="2.2">
<h2 data-number="2.2" class="anchored" data-anchor-id="exponential-smoothing."><span class="header-section-number">2.2</span> Exponential smoothing.</h2>
<p>According to <span class="citation" data-cites="hyndman2021forecasting">Hyndman and Athanasopoulos (<a href="#ref-hyndman2021forecasting" role="doc-biblioref">2021</a>)</span>, forecasts produced using exponential smoothing methods are weighted averages of past observations, with the weights decaying exponentially as the observations get older. In other words, the more recent the observation the higher the associated weight. This framework generates reliable forecasts quickly and for a wide range of time series, which is a great advantage and of major importance to applications in industry.</p>
<p>In this subsection, we let the <tt><code>ETS()</code></tt> function select the model by minimising the AICc.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1"></a>beer_ets <span class="ot">&lt;-</span> beer_train <span class="sc">%&gt;%</span></span>
<span id="cb34-2"><a href="#cb34-2"></a>  <span class="fu">model</span>(<span class="fu">ETS</span>(sales))</span>
<span id="cb34-3"><a href="#cb34-3"></a><span class="fu">report</span>(beer_ets)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Series: sales 
Model: ETS(M,A,M) 
  Smoothing parameters:
    alpha = 0.1373209 
    beta  = 0.007857297 
    gamma = 0.0001009044 

  Initial states:
     l[0]     b[0]    s[0]    s[-1]    s[-2]     s[-3]    s[-4]     s[-5]
 9248.863 36.43808 1.16685 1.032394 1.036934 0.9931007 1.050443 0.9914501
    s[-6]    s[-7]    s[-8]     s[-9]    s[-10]    s[-11]
 1.126832 1.063497 0.962376 0.9818587 0.8336701 0.7605934

  sigma^2:  0.0021

     AIC     AICc      BIC 
2536.488 2541.345 2586.975 </code></pre>
</div>
</div>
<p>The <tt><code>ETS(M,A,M)</code></tt> corresponds to a Holt-Winters multiplicative method with multiplicative errors for when seasonal variations are changing proportional to the level of the series.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1"></a><span class="fu">components</span>(beer_ets) <span class="sc">%&gt;%</span></span>
<span id="cb36-2"><a href="#cb36-2"></a>  <span class="fu">autoplot</span>() <span class="sc">+</span></span>
<span id="cb36-3"><a href="#cb36-3"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Date"</span>, <span class="at">y =</span> <span class="st">"Sales"</span>) <span class="sc">+</span></span>
<span id="cb36-4"><a href="#cb36-4"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">labels =</span> scales<span class="sc">::</span>dollar)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-fec" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="index_files/figure-html/fig-fec-1.png" class="img-fluid figure-img" width="672"></p>
<figcaption class="figure-caption">Figure&nbsp;2.4: fpp3: ETS components.</figcaption>
</figure>
</div>
</div>
</div>
<p>The ETS(M,A,M) 10-month forecast.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1"></a>beer_ets_fc <span class="ot">&lt;-</span> beer_ets <span class="sc">%&gt;%</span></span>
<span id="cb37-2"><a href="#cb37-2"></a>  fabletools<span class="sc">::</span><span class="fu">forecast</span>(<span class="at">h =</span> <span class="dv">10</span>)</span>
<span id="cb37-3"><a href="#cb37-3"></a>beer_ets_fc</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A fable: 10 x 4 [1M]
# Key:     .model [1]
   .model          date            sales  .mean
   &lt;chr&gt;          &lt;mth&gt;           &lt;dist&gt;  &lt;dbl&gt;
 1 ETS(sales) 2022 ene. N(12195, 308029) 12195.
 2 ETS(sales) 2022 feb. N(13442, 382116) 13442.
 3 ETS(sales) 2022 mar. N(15922, 548113) 15922.
 4 ETS(sales) 2022 abr. N(15694, 545333) 15694.
 5 ETS(sales) 2022 may. N(17440, 690624) 17440.
 6 ETS(sales) 2022 jun. N(18582, 805158) 18582.
 7 ETS(sales) 2022 jul. N(16440, 648106) 16440.
 8 ETS(sales) 2022 ago. N(17514, 757379) 17514.
 9 ETS(sales) 2022 sep. N(16649, 705523) 16649.
10 ETS(sales) 2022 oct.  N(17479, 8e+05) 17479.</code></pre>
</div>
</div>
<p>The ETS(M,A,M) MAPE.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1"></a>ets_mape <span class="ot">&lt;-</span> fabletools<span class="sc">::</span><span class="fu">accuracy</span>(beer_ets_fc, beer_2022) <span class="sc">%&gt;%</span></span>
<span id="cb39-2"><a href="#cb39-2"></a>  <span class="fu">select</span>(MAPE) <span class="sc">%&gt;%</span></span>
<span id="cb39-3"><a href="#cb39-3"></a>  <span class="fu">unlist</span>()</span>
<span id="cb39-4"><a href="#cb39-4"></a>ets_mape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>    MAPE 
3.950335 </code></pre>
</div>
</div>
<p>Let’s see the <tt><code>ETS(M,A,M)</code></tt> forecast.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1"></a>beer_ets <span class="sc">%&gt;%</span></span>
<span id="cb41-2"><a href="#cb41-2"></a>  fabletools<span class="sc">::</span><span class="fu">forecast</span>(<span class="at">h =</span> <span class="dv">10</span>) <span class="sc">%&gt;%</span></span>
<span id="cb41-3"><a href="#cb41-3"></a>  <span class="fu">autoplot</span>(beer_tbls) <span class="sc">+</span></span>
<span id="cb41-4"><a href="#cb41-4"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="fu">as.Date</span>(<span class="st">"2022-01-01"</span>), <span class="at">lty =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb41-5"><a href="#cb41-5"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Date"</span>, <span class="at">y =</span> <span class="st">"Sales"</span>) <span class="sc">+</span></span>
<span id="cb41-6"><a href="#cb41-6"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"bottom"</span>) <span class="sc">+</span></span>
<span id="cb41-7"><a href="#cb41-7"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">labels =</span> scales<span class="sc">::</span>dollar)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-fef" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="index_files/figure-html/fig-fef-1.png" class="img-fluid figure-img" width="672"></p>
<figcaption class="figure-caption">Figure&nbsp;2.5: fpp3: ETS(M,A,M) forecast.</figcaption>
</figure>
</div>
</div>
</div>
<p>This is not very clear, here is the zoom version.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1"></a>  <span class="fu">ggplot</span>(beer_zoom, <span class="fu">aes</span>(<span class="fu">yearmonth</span>(date), sales), <span class="at">lwd =</span> <span class="dv">2</span>, <span class="at">alpha =</span> <span class="fl">0.4</span>) <span class="sc">+</span></span>
<span id="cb42-2"><a href="#cb42-2"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb42-3"><a href="#cb42-3"></a>  <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">5</span>, <span class="at">color =</span> <span class="st">"black"</span>, <span class="at">alpha =</span> <span class="fl">0.5</span>, </span>
<span id="cb42-4"><a href="#cb42-4"></a>             <span class="at">shape =</span> <span class="dv">21</span>, <span class="at">fill =</span> <span class="st">"black"</span>) <span class="sc">+</span></span>
<span id="cb42-5"><a href="#cb42-5"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">y =</span> .mean), <span class="at">size =</span> <span class="dv">5</span>, </span>
<span id="cb42-6"><a href="#cb42-6"></a>             <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">alpha =</span> <span class="fl">0.5</span>, <span class="at">shape =</span> <span class="dv">21</span>, </span>
<span id="cb42-7"><a href="#cb42-7"></a>             <span class="at">fill =</span> <span class="st">"red"</span>, <span class="at">data =</span> beer_ets_fc) <span class="sc">+</span></span>
<span id="cb42-8"><a href="#cb42-8"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> .mean), <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">size =</span> <span class="fl">0.5</span>, <span class="at">data =</span> beer_ets_fc) <span class="sc">+</span></span>
<span id="cb42-9"><a href="#cb42-9"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="fu">as.numeric</span>(<span class="fu">as.Date</span>(<span class="st">"2021-12-01"</span>)), </span>
<span id="cb42-10"><a href="#cb42-10"></a>               <span class="at">linetype =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb42-11"><a href="#cb42-11"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Date"</span>, <span class="at">y =</span> <span class="st">"Sales"</span>,</span>
<span id="cb42-12"><a href="#cb42-12"></a>       <span class="at">caption =</span> <span class="fu">c</span>(<span class="fu">paste</span>(<span class="st">"MAPE="</span>,(<span class="fu">round</span>(ets_mape, <span class="dv">5</span>))))) <span class="sc">+</span></span>
<span id="cb42-13"><a href="#cb42-13"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"bottom"</span>) <span class="sc">+</span></span>
<span id="cb42-14"><a href="#cb42-14"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">labels =</span> scales<span class="sc">::</span>dollar)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-zfef" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="index_files/figure-html/fig-zfef-1.png" class="img-fluid figure-img" width="672"></p>
<figcaption class="figure-caption">Figure&nbsp;2.6: Zoom. fpp3: ETS(M,A,M) forecast.</figcaption>
</figure>
</div>
</div>
</div>
<p>Update the MAPE table.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1"></a>mape_updated <span class="ot">&lt;-</span> mape_table <span class="sc">%&gt;%</span></span>
<span id="cb43-2"><a href="#cb43-2"></a>  <span class="fu">add_row</span>(<span class="at">.model =</span> <span class="st">"fpp3: ETS(M,A,M)"</span>, <span class="at">MAPE =</span> ets_mape) <span class="sc">%&gt;%</span></span>
<span id="cb43-3"><a href="#cb43-3"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(<span class="sc">-</span>MAPE))</span>
<span id="cb43-4"><a href="#cb43-4"></a>mape_updated</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5 × 2
  .model                MAPE
  &lt;chr&gt;                &lt;dbl&gt;
1 fpp3: seasonal naïve  3.82
2 fpp3: ETS(M,A,M)      3.95
3 fpp3: naïve          18.4 
4 fpp3: drift          21.2 
5 fpp3: mean           23.4 </code></pre>
</div>
</div>
</section>
<section id="arima." class="level2" data-number="2.3">
<h2 data-number="2.3" class="anchored" data-anchor-id="arima."><span class="header-section-number">2.3</span> ARIMA.</h2>
<p>According to <span class="citation" data-cites="hyndman2021forecasting">Hyndman and Athanasopoulos (<a href="#ref-hyndman2021forecasting" role="doc-biblioref">2021</a>)</span>, while exponential smoothing models are based on a description of the trend and seasonality in the data, ARIMA models aim to describe the autocorrelations in the data. The <tt><code>ARIMA()</code></tt> function combines unit root tests, minimisation of the AICc and MLE to obtain an ARIMA model. By setting <tt><code>stepwise = FALSE</code></tt> and <tt><code>approximation = FALSE</code></tt>, we are making R work extra hard to find a good model.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1"></a>beer_arima <span class="ot">&lt;-</span> beer_train <span class="sc">%&gt;%</span></span>
<span id="cb45-2"><a href="#cb45-2"></a>  <span class="fu">model</span>(<span class="at">arima_auto =</span> <span class="fu">ARIMA</span>(sales, <span class="at">stepwise =</span> <span class="cn">FALSE</span>, <span class="at">approx =</span> <span class="cn">FALSE</span>))</span>
<span id="cb45-3"><a href="#cb45-3"></a><span class="fu">report</span>(beer_arima)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Series: sales 
Model: ARIMA(4,1,1)(0,1,1)[12] 

Coefficients:
          ar1      ar2     ar3      ar4      ma1     sma1
      -0.0687  -0.0138  0.2292  -0.3335  -0.7658  -0.6764
s.e.   0.1075   0.1057  0.0966   0.0843   0.0840   0.1030

sigma^2 estimated as 310112:  log likelihood=-1015.76
AIC=2045.52   AICc=2046.43   BIC=2065.64</code></pre>
</div>
</div>
<p>The residuals for the best ARIMA model.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1"></a>beer_arima <span class="sc">%&gt;%</span></span>
<span id="cb47-2"><a href="#cb47-2"></a>  <span class="fu">select</span>(arima_auto) <span class="sc">%&gt;%</span></span>
<span id="cb47-3"><a href="#cb47-3"></a>  <span class="fu">gg_tsresiduals</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-rftffam" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="index_files/figure-html/fig-rftffam-1.png" class="img-fluid figure-img" width="672"></p>
<figcaption class="figure-caption">Figure&nbsp;2.7: Residuals from the fitted fpp3 ARIMA(4,1,1)(0,1,1)[12] model.</figcaption>
</figure>
</div>
</div>
</div>
<p>The forecast for the best ARIMA model.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1"></a>beer_arima_fc <span class="ot">&lt;-</span> beer_arima <span class="sc">%&gt;%</span></span>
<span id="cb48-2"><a href="#cb48-2"></a>  fabletools<span class="sc">::</span><span class="fu">forecast</span>(<span class="at">h =</span> <span class="st">"10 months"</span>)</span>
<span id="cb48-3"><a href="#cb48-3"></a>beer_arima_fc</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A fable: 10 x 4 [1M]
# Key:     .model [1]
   .model          date            sales  .mean
   &lt;chr&gt;          &lt;mth&gt;           &lt;dist&gt;  &lt;dbl&gt;
 1 arima_auto 2022 ene. N(12647, 310136) 12647.
 2 arima_auto 2022 feb. N(14311, 318632) 14311.
 3 arima_auto 2022 mar. N(15821, 332187) 15821.
 4 arima_auto 2022 abr. N(15644, 394100) 15644.
 5 arima_auto 2022 may.  N(17073, 4e+05) 17073.
 6 arima_auto 2022 jun. N(18020, 412913) 18020.
 7 arima_auto 2022 jul. N(16766, 432703) 16766.
 8 arima_auto 2022 ago. N(17366, 433275) 17366.
 9 arima_auto 2022 sep. N(16620, 463370) 16620.
10 arima_auto 2022 oct. N(17365, 475081) 17365.</code></pre>
</div>
</div>
<p>The best ARIMA MAPE.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1"></a>arima_mape <span class="ot">&lt;-</span> fabletools<span class="sc">::</span><span class="fu">accuracy</span>(beer_arima_fc, beer_2022) <span class="sc">%&gt;%</span></span>
<span id="cb50-2"><a href="#cb50-2"></a>  <span class="fu">select</span>(MAPE) <span class="sc">%&gt;%</span></span>
<span id="cb50-3"><a href="#cb50-3"></a>  <span class="fu">unlist</span>()</span>
<span id="cb50-4"><a href="#cb50-4"></a>arima_mape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>    MAPE 
4.579835 </code></pre>
</div>
</div>
<p>Let’s plot the forecast results.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1"></a>beer_arima_fc <span class="sc">%&gt;%</span></span>
<span id="cb52-2"><a href="#cb52-2"></a>  <span class="fu">autoplot</span>(beer_tbls, <span class="at">level =</span> <span class="cn">NULL</span>) <span class="sc">+</span></span>
<span id="cb52-3"><a href="#cb52-3"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="fu">as.Date</span>(<span class="st">"2022-01-01"</span>), <span class="at">lty =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb52-4"><a href="#cb52-4"></a>  <span class="fu">labs</span>(<span class="at">y =</span> <span class="st">"Sales"</span>, <span class="at">x =</span> <span class="st">"Date"</span>) <span class="sc">+</span></span>
<span id="cb52-5"><a href="#cb52-5"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">labels =</span> scales<span class="sc">::</span>dollar)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-faf" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="index_files/figure-html/fig-faf-1.png" class="img-fluid figure-img" width="672"></p>
<figcaption class="figure-caption">Figure&nbsp;2.8: fpp3: ARIMA(4,1,1)(0,1,1)[12] forecast.</figcaption>
</figure>
</div>
</div>
</div>
<p>The plot above is not very clear. Here is a zoom version.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1"></a>  <span class="fu">ggplot</span>(beer_zoom, <span class="fu">aes</span>(<span class="fu">yearmonth</span>(date), sales), <span class="at">lwd =</span> <span class="dv">2</span>, <span class="at">alpha =</span> <span class="fl">0.4</span>) <span class="sc">+</span></span>
<span id="cb53-2"><a href="#cb53-2"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb53-3"><a href="#cb53-3"></a>  <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">5</span>, <span class="at">color =</span> <span class="st">"black"</span>, <span class="at">alpha =</span> <span class="fl">0.5</span>, </span>
<span id="cb53-4"><a href="#cb53-4"></a>             <span class="at">shape =</span> <span class="dv">21</span>, <span class="at">fill =</span> <span class="st">"black"</span>) <span class="sc">+</span></span>
<span id="cb53-5"><a href="#cb53-5"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">y =</span> .mean), <span class="at">size =</span> <span class="dv">5</span>, </span>
<span id="cb53-6"><a href="#cb53-6"></a>             <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">alpha =</span> <span class="fl">0.5</span>, <span class="at">shape =</span> <span class="dv">21</span>, </span>
<span id="cb53-7"><a href="#cb53-7"></a>             <span class="at">fill =</span> <span class="st">"red"</span>, <span class="at">data =</span> beer_arima_fc) <span class="sc">+</span></span>
<span id="cb53-8"><a href="#cb53-8"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> .mean), <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">size =</span> <span class="fl">0.5</span>, <span class="at">data =</span> beer_arima_fc) <span class="sc">+</span></span>
<span id="cb53-9"><a href="#cb53-9"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="fu">as.numeric</span>(<span class="fu">as.Date</span>(<span class="st">"2021-12-01"</span>)), </span>
<span id="cb53-10"><a href="#cb53-10"></a>               <span class="at">linetype =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb53-11"><a href="#cb53-11"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Date"</span>, <span class="at">y =</span> <span class="st">"Sales"</span>,</span>
<span id="cb53-12"><a href="#cb53-12"></a>       <span class="at">caption =</span> <span class="fu">c</span>(<span class="fu">paste</span>(<span class="st">"MAPE="</span>,(<span class="fu">round</span>(arima_mape, <span class="dv">5</span>))))) <span class="sc">+</span></span>
<span id="cb53-13"><a href="#cb53-13"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"bottom"</span>) <span class="sc">+</span></span>
<span id="cb53-14"><a href="#cb53-14"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">labels =</span> scales<span class="sc">::</span>dollar)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-zfaf" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="index_files/figure-html/fig-zfaf-1.png" class="img-fluid figure-img" width="672"></p>
<figcaption class="figure-caption">Figure&nbsp;2.9: Zoom. fpp3: ARIMA(4,1,1)(0,1,1)[12] forecast.</figcaption>
</figure>
</div>
</div>
</div>
<p>Update the MAPE table.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1"></a>mape_updated <span class="ot">&lt;-</span> mape_updated <span class="sc">%&gt;%</span></span>
<span id="cb54-2"><a href="#cb54-2"></a>  <span class="fu">add_row</span>(<span class="at">.model =</span> <span class="st">"fpp3: ARIMA(4,1,1)(0,1,1)[12]"</span>, <span class="at">MAPE =</span> arima_mape) <span class="sc">%&gt;%</span></span>
<span id="cb54-3"><a href="#cb54-3"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(<span class="sc">-</span>MAPE))</span>
<span id="cb54-4"><a href="#cb54-4"></a>mape_updated</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 2
  .model                         MAPE
  &lt;chr&gt;                         &lt;dbl&gt;
1 fpp3: seasonal naïve           3.82
2 fpp3: ETS(M,A,M)               3.95
3 fpp3: ARIMA(4,1,1)(0,1,1)[12]  4.58
4 fpp3: naïve                   18.4 
5 fpp3: drift                   21.2 
6 fpp3: mean                    23.4 </code></pre>
</div>
</div>
</section>
<section id="neural-network." class="level2" data-number="2.4">
<h2 data-number="2.4" class="anchored" data-anchor-id="neural-network."><span class="header-section-number">2.4</span> Neural network.</h2>
<p>Artificial neural networks are forecasting methods that are based on simple mathematical models of the brain. They allow complex nonlinear relationships between the response variable and its predictors. With time series data, lagged values of the time series can be used as inputs to a neural network, just as we used lagged values in a linear autoregression model. We call this a neural network autoregression or NNAR model.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1"></a>beer_nnet <span class="ot">&lt;-</span> beer_train <span class="sc">%&gt;%</span></span>
<span id="cb56-2"><a href="#cb56-2"></a>  <span class="fu">model</span>(<span class="fu">NNETAR</span>(sales))</span>
<span id="cb56-3"><a href="#cb56-3"></a><span class="fu">report</span>(beer_nnet)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Series: sales 
Model: NNAR(15,1,8)[12] 

Average of 20 networks, each of which is
a 15-8-1 network with 137 weights
options were - linear output units 

sigma^2 estimated as 971.7</code></pre>
</div>
</div>
<p>The NNAR(15,1,8)[12] model has inputs <span class="math inline">\(y_{t−1}, y_{t−2},..., y_{t−15}\)</span> and 8 neurons in the hidden layer.</p>
<p>The forecast for the best NNAR model.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1"></a>beer_nnet_fc <span class="ot">&lt;-</span> beer_nnet <span class="sc">%&gt;%</span></span>
<span id="cb58-2"><a href="#cb58-2"></a>  fabletools<span class="sc">::</span><span class="fu">forecast</span>(<span class="at">h =</span> <span class="st">"10 months"</span>)</span>
<span id="cb58-3"><a href="#cb58-3"></a>beer_nnet_fc</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A fable: 10 x 4 [1M]
# Key:     .model [1]
   .model             date        sales  .mean
   &lt;chr&gt;             &lt;mth&gt;       &lt;dist&gt;  &lt;dbl&gt;
 1 NNETAR(sales) 2022 ene. sample[5000] 13734.
 2 NNETAR(sales) 2022 feb. sample[5000] 15194.
 3 NNETAR(sales) 2022 mar. sample[5000] 16761.
 4 NNETAR(sales) 2022 abr. sample[5000] 15569.
 5 NNETAR(sales) 2022 may. sample[5000] 16905.
 6 NNETAR(sales) 2022 jun. sample[5000] 18337.
 7 NNETAR(sales) 2022 jul. sample[5000] 16878.
 8 NNETAR(sales) 2022 ago. sample[5000] 17990.
 9 NNETAR(sales) 2022 sep. sample[5000] 16612.
10 NNETAR(sales) 2022 oct. sample[5000] 16816.</code></pre>
</div>
</div>
<p>The best NNET MAPE.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1"></a>nnet_mape <span class="ot">&lt;-</span> fabletools<span class="sc">::</span><span class="fu">accuracy</span>(beer_nnet_fc, beer_2022) <span class="sc">%&gt;%</span></span>
<span id="cb60-2"><a href="#cb60-2"></a>  <span class="fu">select</span>(MAPE) <span class="sc">%&gt;%</span></span>
<span id="cb60-3"><a href="#cb60-3"></a>  <span class="fu">unlist</span>()</span>
<span id="cb60-4"><a href="#cb60-4"></a>nnet_mape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>   MAPE 
6.45572 </code></pre>
</div>
</div>
<p>Let’s plot the forecast results.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb62-1"><a href="#cb62-1"></a>beer_nnet_fc <span class="sc">%&gt;%</span></span>
<span id="cb62-2"><a href="#cb62-2"></a>  <span class="fu">autoplot</span>(beer_tbls, <span class="at">level =</span> <span class="cn">NULL</span>) <span class="sc">+</span></span>
<span id="cb62-3"><a href="#cb62-3"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="fu">as.Date</span>(<span class="st">"2022-01-01"</span>), <span class="at">lty =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb62-4"><a href="#cb62-4"></a>  <span class="fu">labs</span>(<span class="at">y =</span> <span class="st">"Sales"</span>, <span class="at">x =</span> <span class="st">"Date"</span>) <span class="sc">+</span></span>
<span id="cb62-5"><a href="#cb62-5"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">labels =</span> scales<span class="sc">::</span>dollar)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-fnf" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="index_files/figure-html/fig-fnf-1.png" class="img-fluid figure-img" width="672"></p>
<figcaption class="figure-caption">Figure&nbsp;2.10: fpp3: NNAR(15,1,8)[12] forecast.</figcaption>
</figure>
</div>
</div>
</div>
<p>The plot above is not very clear. Here is a zoom version.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1"></a>  <span class="fu">ggplot</span>(beer_zoom, <span class="fu">aes</span>(<span class="fu">yearmonth</span>(date), sales), <span class="at">lwd =</span> <span class="dv">2</span>, <span class="at">alpha =</span> <span class="fl">0.4</span>) <span class="sc">+</span></span>
<span id="cb63-2"><a href="#cb63-2"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb63-3"><a href="#cb63-3"></a>  <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">5</span>, <span class="at">color =</span> <span class="st">"black"</span>, <span class="at">alpha =</span> <span class="fl">0.5</span>, </span>
<span id="cb63-4"><a href="#cb63-4"></a>             <span class="at">shape =</span> <span class="dv">21</span>, <span class="at">fill =</span> <span class="st">"black"</span>) <span class="sc">+</span></span>
<span id="cb63-5"><a href="#cb63-5"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">y =</span> .mean), <span class="at">size =</span> <span class="dv">5</span>, </span>
<span id="cb63-6"><a href="#cb63-6"></a>             <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">alpha =</span> <span class="fl">0.5</span>, <span class="at">shape =</span> <span class="dv">21</span>, </span>
<span id="cb63-7"><a href="#cb63-7"></a>             <span class="at">fill =</span> <span class="st">"red"</span>, <span class="at">data =</span> beer_nnet_fc) <span class="sc">+</span></span>
<span id="cb63-8"><a href="#cb63-8"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> .mean), <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">size =</span> <span class="fl">0.5</span>, <span class="at">data =</span> beer_nnet_fc) <span class="sc">+</span></span>
<span id="cb63-9"><a href="#cb63-9"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="fu">as.numeric</span>(<span class="fu">as.Date</span>(<span class="st">"2021-12-01"</span>)), </span>
<span id="cb63-10"><a href="#cb63-10"></a>               <span class="at">linetype =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb63-11"><a href="#cb63-11"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Date"</span>, <span class="at">y =</span> <span class="st">"Sales"</span>,</span>
<span id="cb63-12"><a href="#cb63-12"></a>       <span class="at">caption =</span> <span class="fu">c</span>(<span class="fu">paste</span>(<span class="st">"MAPE="</span>,(<span class="fu">round</span>(nnet_mape, <span class="dv">5</span>))))) <span class="sc">+</span></span>
<span id="cb63-13"><a href="#cb63-13"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"bottom"</span>) <span class="sc">+</span></span>
<span id="cb63-14"><a href="#cb63-14"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">labels =</span> scales<span class="sc">::</span>dollar)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-zfnf" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="index_files/figure-html/fig-zfnf-1.png" class="img-fluid figure-img" width="672"></p>
<figcaption class="figure-caption">Figure&nbsp;2.11: Zoom. fpp3: NNAR(15,1,8)[12] forecast.</figcaption>
</figure>
</div>
</div>
</div>
<p>Update the MAPE table.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb64-1"><a href="#cb64-1"></a>mape_updated <span class="ot">&lt;-</span> mape_updated <span class="sc">%&gt;%</span></span>
<span id="cb64-2"><a href="#cb64-2"></a>  <span class="fu">add_row</span>(<span class="at">.model =</span> <span class="st">"fpp3: NNAR(15,1,8)[12]"</span>, <span class="at">MAPE =</span> nnet_mape) <span class="sc">%&gt;%</span></span>
<span id="cb64-3"><a href="#cb64-3"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(<span class="sc">-</span>MAPE))</span>
<span id="cb64-4"><a href="#cb64-4"></a>mape_updated</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 7 × 2
  .model                         MAPE
  &lt;chr&gt;                         &lt;dbl&gt;
1 fpp3: seasonal naïve           3.82
2 fpp3: ETS(M,A,M)               3.95
3 fpp3: ARIMA(4,1,1)(0,1,1)[12]  4.58
4 fpp3: NNAR(15,1,8)[12]         6.46
5 fpp3: naïve                   18.4 
6 fpp3: drift                   21.2 
7 fpp3: mean                    23.4 </code></pre>
</div>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb66-1"><a href="#cb66-1"></a><span class="co"># I save the mape_updated object to use it in hh2o.rmd</span></span>
<span id="cb66-2"><a href="#cb66-2"></a><span class="fu">saveRDS</span>(mape_updated, <span class="st">"mape_updated.rds"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb67-1"><a href="#cb67-1"></a><span class="co"># I save the forecast object to use it in hh2o.rmd</span></span>
<span id="cb67-2"><a href="#cb67-2"></a>fpp3_fc <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(beer_sn_fc, beer_ets_fc, beer_arima_fc,</span>
<span id="cb67-3"><a href="#cb67-3"></a>                     beer_nnet_fc)</span>
<span id="cb67-4"><a href="#cb67-4"></a><span class="fu">saveRDS</span>(fpp3_fc, <span class="st">"fpp3_fc.rds"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
</section>
<section id="forecasts-with-h2o." class="level1" data-number="3">
<h1 data-number="3"><span class="header-section-number">3</span> Forecasts with <tt><code>h2o</code></tt>.</h1>
<p>As in the previous section, the problem is to forecast a time series. In particular, the time series is the <em>Beer, Wine, and Distilled Alcoholic Beverages Sales</em> as in the original Matt Dancho’s example. The data is taken from FRED (Federal Reserve Economic Data). The data belongs to the non-durable goods category, it includes U.S. merchant wholesalers, except manufacturers’ sales branches and offices sales. The monthly time series goes from 2010-01-01 to 2022-10-31. And the goal is to use 2022 data (10 months) as a test data to conduct the forecast.</p>
<p>For the full database details see: https://fred.stlouisfed.org/series/S4248SM144NCEN</p>
<p>Let’s load the R packages.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb68-1"><a href="#cb68-1"></a><span class="co"># Load libraries</span></span>
<span id="cb68-2"><a href="#cb68-2"></a><span class="fu">library</span>(fpp3)</span>
<span id="cb68-3"><a href="#cb68-3"></a><span class="fu">library</span>(h2o)        <span class="co"># ML Library.</span></span>
<span id="cb68-4"><a href="#cb68-4"></a><span class="fu">library</span>(timetk)     <span class="co"># Toolkit for working with time series in R.</span></span>
<span id="cb68-5"><a href="#cb68-5"></a><span class="fu">library</span>(tidyquant)  <span class="co"># Loads tidyverse, financial pkgs, used to get data.</span></span>
<span id="cb68-6"><a href="#cb68-6"></a><span class="fu">library</span>(dplyr)      <span class="co"># Database manipulation.</span></span>
<span id="cb68-7"><a href="#cb68-7"></a><span class="fu">library</span>(ggplot2)    <span class="co"># Plots.</span></span>
<span id="cb68-8"><a href="#cb68-8"></a><span class="fu">library</span>(tibble)     <span class="co"># Tables.</span></span>
<span id="cb68-9"><a href="#cb68-9"></a><span class="fu">library</span>(kableExtra) <span class="co"># Tables.</span></span>
<span id="cb68-10"><a href="#cb68-10"></a><span class="fu">library</span>(knitr)      </span>
<span id="cb68-11"><a href="#cb68-11"></a><span class="fu">library</span>(bit64)      <span class="co"># Useful in the machine learning workflow.</span></span>
<span id="cb68-12"><a href="#cb68-12"></a><span class="fu">library</span>(sweep)      <span class="co"># Broom-style tidiers for the forecast package.</span></span>
<span id="cb68-13"><a href="#cb68-13"></a><span class="fu">library</span>(forecast)   <span class="co"># Forecasting models and predictions package.</span></span>
<span id="cb68-14"><a href="#cb68-14"></a><span class="fu">library</span>(seasonal)</span>
<span id="cb68-15"><a href="#cb68-15"></a><span class="fu">library</span>(tictoc)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb69-1"><a href="#cb69-1"></a><span class="co"># This comes from ffpp3.rmd</span></span>
<span id="cb69-2"><a href="#cb69-2"></a>mape_updated <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">"mape_updated.rds"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>We can conveniently download the data directly from the FRED API in one line of code.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb70-1"><a href="#cb70-1"></a><span class="co"># Beer, Wine, Distilled Alcoholic Beverages, in Millions USD.</span></span>
<span id="cb70-2"><a href="#cb70-2"></a>beer <span class="ot">&lt;-</span> <span class="fu">tq_get</span>(<span class="st">"S4248SM144NCEN"</span>, <span class="at">get =</span> <span class="st">"economic.data"</span>, </span>
<span id="cb70-3"><a href="#cb70-3"></a>               <span class="at">from =</span> <span class="st">"2010-01-01"</span>, <span class="at">to =</span> <span class="st">"2022-10-31"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Let’s have a look of the data set. By default it says <em>price</em>, but these are sales figures in monetary terms. According to the main FRED reference, these are in millions of dollars, not seasonally adjusted.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb71-1"><a href="#cb71-1"></a><span class="fu">head</span>(beer)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 3
  symbol         date       price
  &lt;chr&gt;          &lt;date&gt;     &lt;int&gt;
1 S4248SM144NCEN 2010-01-01  6558
2 S4248SM144NCEN 2010-02-01  7481
3 S4248SM144NCEN 2010-03-01  9475
4 S4248SM144NCEN 2010-04-01  9424
5 S4248SM144NCEN 2010-05-01  9351
6 S4248SM144NCEN 2010-06-01 10552</code></pre>
</div>
</div>
<p>We can change the name of the price column.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb73-1"><a href="#cb73-1"></a>beer <span class="ot">&lt;-</span> beer <span class="sc">%&gt;%</span></span>
<span id="cb73-2"><a href="#cb73-2"></a>  <span class="fu">rename</span>(<span class="at">sales =</span> price)</span>
<span id="cb73-3"><a href="#cb73-3"></a></span>
<span id="cb73-4"><a href="#cb73-4"></a><span class="fu">tail</span>(beer)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 3
  symbol         date       sales
  &lt;chr&gt;          &lt;date&gt;     &lt;int&gt;
1 S4248SM144NCEN 2022-05-01 16755
2 S4248SM144NCEN 2022-06-01 17882
3 S4248SM144NCEN 2022-07-01 15168
4 S4248SM144NCEN 2022-08-01 16977
5 S4248SM144NCEN 2022-09-01 16430
6 S4248SM144NCEN 2022-10-01 15480</code></pre>
</div>
</div>
<p>Better now.</p>
<section id="the-h2o-package." class="level2" data-number="3.1">
<h2 data-number="3.1" class="anchored" data-anchor-id="the-h2o-package."><span class="header-section-number">3.1</span> The <tt><code>h2o</code></tt> package.</h2>
<p>Machine learning is the study of computer algorithms that improve automatically through experience. There are many ways and approaches to implement machine learning especially in time series forecasts purposes. This document heavily relies on <tt><code>h2o</code></tt> library. The <tt><code>h2o</code></tt> package is a product offered by H2O.ai that contains a number of cutting edge machine learning algorithms, performance metrics, and auxiliary functions to make machine learning both powerful and easy to implement.</p>
<p>One of the most important features of this package is the <tt><code>h2o.automl()</code></tt> (Automatic Machine Learning). H2O’s AutoML can be used for automating the machine learning workflow, which includes automatic training and tuning of many models within a user-specified time-limit. Stacked Ensembles – one based on all previously trained models, another one on the best model of each family – will be automatically trained on collections of individual models to produce highly predictive ensemble models which, in most cases, will be the top performing models in the AutoML Leaderboard. We can verify this in the example below.</p>
<p>This document has limited explanations about the applied machine learning techniques. The value of this document is to gather several examples that are originally presented separately in Business Science IO and <a href="r-bloggers.com">R-bloggers.</a> sites and extend the analysis to elaborate further on the code logic and interpretation. It can also be useful to better understand how the R functions work, how results are produced, and it could help to replicate a different example with a new database for those who are new in the field.</p>
<p>You have to download and install H2O. <a href="https://docs.h2o.ai/h2o/latest-stable/h2o-docs/downloading.html#install-in-r">Click here for full instructions.</a> You are also expected to review the H2O webpage contents because they have important information that will allow you to better understand the value of this machine learning tool.</p>
<p>The main objective here is to use <tt><code>h2o</code></tt> locally (in your own computer) to develop a high accuracy time series model on the <tt><code>beer</code></tt> data set. This is a supervised machine learning regression problem. An interesting reference to learn the basics of supervised and unsupervised machine learning techniques applied to business is: <span class="citation" data-cites="hull2020machine">Hull (<a href="#ref-hull2020machine" role="doc-biblioref">2020</a>)</span>.</p>
</section>
<section id="the-data.-1" class="level2" data-number="3.2">
<h2 data-number="3.2" class="anchored" data-anchor-id="the-data.-1"><span class="header-section-number">3.2</span> The data.</h2>
<p>We need an additional data set. The <em>validation</em> dataset is the sample of data used to provide an unbiased evaluation of a model fit on the training dataset while tuning model hyperparameters. The new datasets are the following.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb75-1"><a href="#cb75-1"></a>beer <span class="sc">%&gt;%</span></span>
<span id="cb75-2"><a href="#cb75-2"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(date, sales)) <span class="sc">+</span></span>
<span id="cb75-3"><a href="#cb75-3"></a>  <span class="co"># Train Region:</span></span>
<span id="cb75-4"><a href="#cb75-4"></a>  <span class="fu">annotate</span>(<span class="st">"text"</span>, <span class="at">x =</span> <span class="fu">ymd</span>(<span class="st">"2013-01-01"</span>), <span class="at">y =</span> <span class="dv">14000</span>, </span>
<span id="cb75-5"><a href="#cb75-5"></a>           <span class="at">color =</span> <span class="st">"black"</span>, <span class="at">label =</span> <span class="st">"Train region"</span>) <span class="sc">+</span></span>
<span id="cb75-6"><a href="#cb75-6"></a>  <span class="co"># Validation Region:</span></span>
<span id="cb75-7"><a href="#cb75-7"></a>  <span class="fu">geom_rect</span>(<span class="at">xmin =</span> <span class="fu">as.numeric</span>(<span class="fu">ymd</span>(<span class="st">"2021-01-01"</span>)), </span>
<span id="cb75-8"><a href="#cb75-8"></a>            <span class="at">xmax =</span> <span class="fu">as.numeric</span>(<span class="fu">ymd</span>(<span class="st">"2021-12-31"</span>)), <span class="at">ymin =</span> <span class="dv">0</span>, <span class="at">ymax =</span> <span class="dv">20000</span>, </span>
<span id="cb75-9"><a href="#cb75-9"></a>            <span class="at">alpha =</span> <span class="fl">0.01</span>, <span class="at">fill =</span> <span class="st">"purple"</span>) <span class="sc">+</span></span>
<span id="cb75-10"><a href="#cb75-10"></a>  <span class="fu">annotate</span>(<span class="st">"text"</span>, <span class="at">x =</span> <span class="fu">ymd</span>(<span class="st">"2021-04-01"</span>), <span class="at">y =</span> <span class="dv">7000</span>,</span>
<span id="cb75-11"><a href="#cb75-11"></a>           <span class="at">color =</span> <span class="st">"black"</span>, <span class="at">label =</span> <span class="st">"Validation</span><span class="sc">\n</span><span class="st">region"</span>) <span class="sc">+</span></span>
<span id="cb75-12"><a href="#cb75-12"></a>  <span class="co"># Test Region:</span></span>
<span id="cb75-13"><a href="#cb75-13"></a>  <span class="fu">geom_rect</span>(<span class="at">xmin =</span> <span class="fu">as.numeric</span>(<span class="fu">ymd</span>(<span class="st">"2022-01-01"</span>)), </span>
<span id="cb75-14"><a href="#cb75-14"></a>            <span class="at">xmax =</span> <span class="fu">as.numeric</span>(<span class="fu">ymd</span>(<span class="st">"2022-09-30"</span>)), <span class="at">ymin =</span> <span class="dv">0</span>, <span class="at">ymax =</span> <span class="dv">20000</span>, </span>
<span id="cb75-15"><a href="#cb75-15"></a>            <span class="at">alpha =</span> <span class="fl">0.02</span>, <span class="at">fill =</span> <span class="st">"pink"</span>) <span class="sc">+</span></span>
<span id="cb75-16"><a href="#cb75-16"></a>  <span class="fu">annotate</span>(<span class="st">"text"</span>, <span class="at">x =</span> <span class="fu">ymd</span>(<span class="st">"2022-06-01"</span>), <span class="at">y =</span> <span class="dv">9000</span>,</span>
<span id="cb75-17"><a href="#cb75-17"></a>           <span class="at">color =</span> <span class="st">"black"</span>, <span class="at">label =</span> <span class="st">"Test</span><span class="sc">\n</span><span class="st">region"</span>) <span class="sc">+</span></span>
<span id="cb75-18"><a href="#cb75-18"></a>  <span class="co"># Data.</span></span>
<span id="cb75-19"><a href="#cb75-19"></a>  <span class="fu">geom_line</span>(<span class="at">col =</span> <span class="st">"black"</span>) <span class="sc">+</span></span>
<span id="cb75-20"><a href="#cb75-20"></a>  <span class="fu">geom_point</span>(<span class="at">col =</span> <span class="st">"black"</span>, <span class="at">alpha =</span> <span class="fl">0.5</span>, <span class="at">size =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb75-21"><a href="#cb75-21"></a>  <span class="co"># Aesthetics.</span></span>
<span id="cb75-22"><a href="#cb75-22"></a>  <span class="fu">theme_tq</span>() <span class="sc">+</span></span>
<span id="cb75-23"><a href="#cb75-23"></a>  <span class="fu">scale_x_date</span>(<span class="at">date_breaks =</span> <span class="st">"1 year"</span>, <span class="at">date_labels =</span> <span class="st">"%Y"</span>) <span class="sc">+</span></span>
<span id="cb75-24"><a href="#cb75-24"></a>  <span class="fu">labs</span>(<span class="at">subtitle =</span> </span>
<span id="cb75-25"><a href="#cb75-25"></a>  <span class="st">"Train (2010 - 2020), validation (2021), and test set (Jan 2022 to Oct 2022)"</span>,</span>
<span id="cb75-26"><a href="#cb75-26"></a>  <span class="at">x =</span> <span class="st">"Date"</span>, <span class="at">y =</span> <span class="st">"Sales"</span>,</span>
<span id="cb75-27"><a href="#cb75-27"></a>       <span class="at">caption =</span> <span class="st">"The models do not know the test region, this is for us </span></span>
<span id="cb75-28"><a href="#cb75-28"></a><span class="st">       to see how well the models do the 10-month ahead forecast."</span>) <span class="sc">+</span></span>
<span id="cb75-29"><a href="#cb75-29"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">labels =</span> scales<span class="sc">::</span>dollar)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-bstvats" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="index_files/figure-html/fig-bstvats-1.png" class="img-fluid figure-img" width="672"></p>
<figcaption class="figure-caption">Figure&nbsp;3.1: Beer sales: train, validation and test sets.</figcaption>
</figure>
</div>
</div>
</div>
<p>And the corresponding zoom version.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb76-1"><a href="#cb76-1"></a>beer <span class="sc">%&gt;%</span></span>
<span id="cb76-2"><a href="#cb76-2"></a>  <span class="fu">filter</span>(date <span class="sc">&gt;</span> <span class="fu">as.Date</span>(<span class="st">"2020-01-01"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb76-3"><a href="#cb76-3"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(date, sales)) <span class="sc">+</span></span>
<span id="cb76-4"><a href="#cb76-4"></a>  <span class="co"># Train Region:</span></span>
<span id="cb76-5"><a href="#cb76-5"></a>  <span class="fu">annotate</span>(<span class="st">"text"</span>, <span class="at">x =</span> <span class="fu">ymd</span>(<span class="st">"2020-08-01"</span>), <span class="at">y =</span> <span class="dv">14000</span>, </span>
<span id="cb76-6"><a href="#cb76-6"></a>           <span class="at">color =</span> <span class="st">"black"</span>, <span class="at">label =</span> <span class="st">"Train region"</span>) <span class="sc">+</span></span>
<span id="cb76-7"><a href="#cb76-7"></a>  <span class="co"># Validation Region:</span></span>
<span id="cb76-8"><a href="#cb76-8"></a>  <span class="fu">geom_rect</span>(<span class="at">xmin =</span> <span class="fu">as.numeric</span>(<span class="fu">ymd</span>(<span class="st">"2021-01-01"</span>)), </span>
<span id="cb76-9"><a href="#cb76-9"></a>            <span class="at">xmax =</span> <span class="fu">as.numeric</span>(<span class="fu">ymd</span>(<span class="st">"2021-12-31"</span>)), <span class="at">ymin =</span> <span class="dv">0</span>, <span class="at">ymax =</span> <span class="dv">20000</span>, </span>
<span id="cb76-10"><a href="#cb76-10"></a>            <span class="at">alpha =</span> <span class="fl">0.01</span>, <span class="at">fill =</span> <span class="st">"purple"</span>) <span class="sc">+</span></span>
<span id="cb76-11"><a href="#cb76-11"></a>  <span class="fu">annotate</span>(<span class="st">"text"</span>, <span class="at">x =</span> <span class="fu">ymd</span>(<span class="st">"2021-07-01"</span>), <span class="at">y =</span> <span class="dv">14000</span>,</span>
<span id="cb76-12"><a href="#cb76-12"></a>           <span class="at">color =</span> <span class="st">"black"</span>, <span class="at">label =</span> <span class="st">"Validation region"</span>) <span class="sc">+</span></span>
<span id="cb76-13"><a href="#cb76-13"></a>  <span class="co"># Test Region:</span></span>
<span id="cb76-14"><a href="#cb76-14"></a>  <span class="fu">geom_rect</span>(<span class="at">xmin =</span> <span class="fu">as.numeric</span>(<span class="fu">ymd</span>(<span class="st">"2022-01-01"</span>)), </span>
<span id="cb76-15"><a href="#cb76-15"></a>            <span class="at">xmax =</span> <span class="fu">as.numeric</span>(<span class="fu">ymd</span>(<span class="st">"2022-09-30"</span>)), <span class="at">ymin =</span> <span class="dv">0</span>, <span class="at">ymax =</span> <span class="dv">20000</span>, </span>
<span id="cb76-16"><a href="#cb76-16"></a>            <span class="at">alpha =</span> <span class="fl">0.02</span>, <span class="at">fill =</span> <span class="st">"pink"</span>) <span class="sc">+</span></span>
<span id="cb76-17"><a href="#cb76-17"></a>  <span class="fu">annotate</span>(<span class="st">"text"</span>, <span class="at">x =</span> <span class="fu">ymd</span>(<span class="st">"2022-05-01"</span>), <span class="at">y =</span> <span class="dv">14000</span>,</span>
<span id="cb76-18"><a href="#cb76-18"></a>           <span class="at">color =</span> <span class="st">"black"</span>, <span class="at">label =</span> <span class="st">"Test region"</span>) <span class="sc">+</span></span>
<span id="cb76-19"><a href="#cb76-19"></a>  <span class="co"># Data.</span></span>
<span id="cb76-20"><a href="#cb76-20"></a>  <span class="fu">geom_line</span>(<span class="at">col =</span> <span class="st">"black"</span>) <span class="sc">+</span></span>
<span id="cb76-21"><a href="#cb76-21"></a>  <span class="fu">geom_point</span>(<span class="at">col =</span> <span class="st">"black"</span>, <span class="at">alpha =</span> <span class="fl">0.5</span>, <span class="at">size =</span> <span class="dv">5</span>) <span class="sc">+</span></span>
<span id="cb76-22"><a href="#cb76-22"></a>  <span class="co"># Aesthetics.</span></span>
<span id="cb76-23"><a href="#cb76-23"></a>  <span class="fu">theme_tq</span>() <span class="sc">+</span></span>
<span id="cb76-24"><a href="#cb76-24"></a>  <span class="fu">scale_x_date</span>(<span class="at">date_breaks =</span> <span class="st">"1 year"</span>, <span class="at">date_labels =</span> <span class="st">"%Y"</span>) <span class="sc">+</span></span>
<span id="cb76-25"><a href="#cb76-25"></a>  <span class="fu">labs</span>(<span class="at">subtitle =</span> </span>
<span id="cb76-26"><a href="#cb76-26"></a>  <span class="st">"Train (2010 - 2020), validation (2021), and test set (Jan 2022 to Oct 2022)"</span>,</span>
<span id="cb76-27"><a href="#cb76-27"></a>  <span class="at">x =</span> <span class="st">"Date"</span>, <span class="at">y =</span> <span class="st">"Sales"</span>,</span>
<span id="cb76-28"><a href="#cb76-28"></a>       <span class="at">caption =</span> <span class="st">"The models do not know the test region, this is for us </span></span>
<span id="cb76-29"><a href="#cb76-29"></a><span class="st">       to see how well the models do the 10-month ahead forecast."</span>) <span class="sc">+</span></span>
<span id="cb76-30"><a href="#cb76-30"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">labels =</span> scales<span class="sc">::</span>dollar)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-zbstvats" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="index_files/figure-html/fig-zbstvats-1.png" class="img-fluid figure-img" width="672"></p>
<figcaption class="figure-caption">Figure&nbsp;3.2: Zoom. Beer sales: train, validation and test sets.</figcaption>
</figure>
</div>
</div>
</div>
<p>The <tt><code>tk_augment_timeseries_signature()</code></tt> function expands out the timestamp information column-wise into a machine learning feature set, adding columns of time series information to the original data frame. We’ll again use <tt><code>head()</code></tt> function for quick inspection of this expansion. See how there are now 31 features extracted from the original database. Not all will be important for the final and chosen models, but some will.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb77-1"><a href="#cb77-1"></a><span class="co"># See the full list of new variables to realize the expansion effect.</span></span>
<span id="cb77-2"><a href="#cb77-2"></a>beer_aug <span class="ot">&lt;-</span> beer <span class="sc">%&gt;%</span></span>
<span id="cb77-3"><a href="#cb77-3"></a>  <span class="fu">tk_augment_timeseries_signature</span>() </span>
<span id="cb77-4"><a href="#cb77-4"></a></span>
<span id="cb77-5"><a href="#cb77-5"></a><span class="fu">tail</span>(beer_aug)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 31
  symbol    date       sales index.num   diff  year year.iso  half quarter month
  &lt;chr&gt;     &lt;date&gt;     &lt;int&gt;     &lt;dbl&gt;  &lt;dbl&gt; &lt;int&gt;    &lt;int&gt; &lt;int&gt;   &lt;int&gt; &lt;int&gt;
1 S4248SM1… 2022-05-01 16755    1.65e9 2.59e6  2022     2022     1       2     5
2 S4248SM1… 2022-06-01 17882    1.65e9 2.68e6  2022     2022     1       2     6
3 S4248SM1… 2022-07-01 15168    1.66e9 2.59e6  2022     2022     2       3     7
4 S4248SM1… 2022-08-01 16977    1.66e9 2.68e6  2022     2022     2       3     8
5 S4248SM1… 2022-09-01 16430    1.66e9 2.68e6  2022     2022     2       3     9
6 S4248SM1… 2022-10-01 15480    1.66e9 2.59e6  2022     2022     2       4    10
# ℹ 21 more variables: month.xts &lt;int&gt;, month.lbl &lt;ord&gt;, day &lt;int&gt;, hour &lt;int&gt;,
#   minute &lt;int&gt;, second &lt;int&gt;, hour12 &lt;int&gt;, am.pm &lt;int&gt;, wday &lt;int&gt;,
#   wday.xts &lt;int&gt;, wday.lbl &lt;ord&gt;, mday &lt;int&gt;, qday &lt;int&gt;, yday &lt;int&gt;,
#   mweek &lt;int&gt;, week &lt;int&gt;, week.iso &lt;int&gt;, week2 &lt;int&gt;, week3 &lt;int&gt;,
#   week4 &lt;int&gt;, mday7 &lt;int&gt;</code></pre>
</div>
</div>
<p>The variable (column) names <tt><code>beer_aug</code></tt> are:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb79"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb79-1"><a href="#cb79-1"></a><span class="fu">colnames</span>(beer_aug)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "symbol"    "date"      "sales"     "index.num" "diff"      "year"     
 [7] "year.iso"  "half"      "quarter"   "month"     "month.xts" "month.lbl"
[13] "day"       "hour"      "minute"    "second"    "hour12"    "am.pm"    
[19] "wday"      "wday.xts"  "wday.lbl"  "mday"      "qday"      "yday"     
[25] "mweek"     "week"      "week.iso"  "week2"     "week3"     "week4"    
[31] "mday7"    </code></pre>
</div>
</div>
<p>Note how we went from 3 columns in <tt><code>beer</code></tt> to 31 columns in <tt><code>beer_aug</code></tt>.</p>
<p>We need to prepare the data in a format for H2O. First, let’s remove any unnecessary columns such as dates or those with missing values, and change the ordered classes to plain factors. We prefer <tt><code>dplyr</code></tt> operations for these steps. Sometimes we do not need to implement this step as the data is already clean (as in this case), but sometimes it is not. Thus, let’s clean the data.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb81"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb81-1"><a href="#cb81-1"></a><span class="co"># See the full list of variables to realize the cleaning effect.</span></span>
<span id="cb81-2"><a href="#cb81-2"></a>beer_clean <span class="ot">&lt;-</span> beer_aug <span class="sc">%&gt;%</span></span>
<span id="cb81-3"><a href="#cb81-3"></a>  <span class="fu">select_if</span>(<span class="sc">~</span> <span class="sc">!</span><span class="fu">is.Date</span>(.)) <span class="sc">%&gt;%</span></span>
<span id="cb81-4"><a href="#cb81-4"></a>  <span class="fu">select_if</span>(<span class="sc">~</span> <span class="sc">!</span><span class="fu">any</span>(<span class="fu">is.na</span>(.))) <span class="sc">%&gt;%</span></span>
<span id="cb81-5"><a href="#cb81-5"></a>  <span class="fu">mutate_if</span>(is.ordered, <span class="sc">~</span> <span class="fu">as.character</span>(.) <span class="sc">%&gt;%</span> as.factor)</span>
<span id="cb81-6"><a href="#cb81-6"></a></span>
<span id="cb81-7"><a href="#cb81-7"></a><span class="fu">head</span>(beer_clean)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 29
  symbol  sales index.num  year year.iso  half quarter month month.xts month.lbl
  &lt;chr&gt;   &lt;int&gt;     &lt;dbl&gt; &lt;int&gt;    &lt;int&gt; &lt;int&gt;   &lt;int&gt; &lt;int&gt;     &lt;int&gt; &lt;fct&gt;    
1 S4248S…  6558    1.26e9  2010     2009     1       1     1         0 enero    
2 S4248S…  7481    1.26e9  2010     2010     1       1     2         1 febrero  
3 S4248S…  9475    1.27e9  2010     2010     1       1     3         2 marzo    
4 S4248S…  9424    1.27e9  2010     2010     1       2     4         3 abril    
5 S4248S…  9351    1.27e9  2010     2010     1       2     5         4 mayo     
6 S4248S… 10552    1.28e9  2010     2010     1       2     6         5 junio    
# ℹ 19 more variables: day &lt;int&gt;, hour &lt;int&gt;, minute &lt;int&gt;, second &lt;int&gt;,
#   hour12 &lt;int&gt;, am.pm &lt;int&gt;, wday &lt;int&gt;, wday.xts &lt;int&gt;, wday.lbl &lt;fct&gt;,
#   mday &lt;int&gt;, qday &lt;int&gt;, yday &lt;int&gt;, mweek &lt;int&gt;, week &lt;int&gt;,
#   week.iso &lt;int&gt;, week2 &lt;int&gt;, week3 &lt;int&gt;, week4 &lt;int&gt;, mday7 &lt;int&gt;</code></pre>
</div>
</div>
<p>The database did not change too much. Now we have 29 columns in <tt><code>beer_clean</code></tt>. In the case of two variables, the structure ordered factors <tt><code>&lt;ord&gt;</code></tt> changed into factors <tt><code>&lt;fct&gt;</code></tt>, which is necessary for some H2O functions.</p>
<p>Let’s split the database into a training, validation and test sets following the time ranges in the visualization above. These training sets are the way most machine learning algorithms can be implemented and evaluated. We normally take more observations for the training, and less observations for the validation and test. The test set (the most recent dates) is unknown in the learning process of the models, the test set will be useful for us to be able to compare forecasts versus what really happened. This is how we can measure out-of-sample estimation errors.</p>
<p>These are the 10-months we are interested to forecast.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb83"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb83-1"><a href="#cb83-1"></a><span class="co"># Split into training, validation and test sets.</span></span>
<span id="cb83-2"><a href="#cb83-2"></a>train_tbl <span class="ot">&lt;-</span> beer_clean <span class="sc">%&gt;%</span> <span class="fu">filter</span>(year <span class="sc">&lt;</span> <span class="dv">2021</span>)</span>
<span id="cb83-3"><a href="#cb83-3"></a>valid_tbl <span class="ot">&lt;-</span> beer_clean <span class="sc">%&gt;%</span> <span class="fu">filter</span>(year <span class="sc">==</span> <span class="dv">2021</span>)</span>
<span id="cb83-4"><a href="#cb83-4"></a>test_tbl  <span class="ot">&lt;-</span> beer_clean <span class="sc">%&gt;%</span> <span class="fu">filter</span>(year <span class="sc">==</span> <span class="dv">2022</span>)</span>
<span id="cb83-5"><a href="#cb83-5"></a></span>
<span id="cb83-6"><a href="#cb83-6"></a>test_tbl<span class="sc">$</span>sales</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code> [1] 11862 13358 16216 15766 16755 17882 15168 16977 16430 15480</code></pre>
</div>
</div>
<p>Our goal is to forecast the first 10 months of 2022.</p>
</section>
<section id="prepare-for-h2o." class="level2" data-number="3.3">
<h2 data-number="3.3" class="anchored" data-anchor-id="prepare-for-h2o."><span class="header-section-number">3.3</span> Prepare for H2O.</h2>
<p>First, fire up H2O. This will initialize the Java Virtual Machine (JVM) that H2O uses locally. In simple terms, here your local computer will remotely connect to a high-power clusters to do the H2O machine learning job. This is not only amazing, it is also free.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb85"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb85-1"><a href="#cb85-1"></a><span class="fu">h2o.init</span>() <span class="co"># Fire up h2o.</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
H2O is not running yet, starting it now...

Note:  In case of errors look at the following log files:
    C:\Users\ML\AppData\Local\Temp\RtmpeIDv38\file4e3c605865f7/h2o_ML_started_from_r.out
    C:\Users\ML\AppData\Local\Temp\RtmpeIDv38\file4e3c20c854f9/h2o_ML_started_from_r.err


Starting H2O JVM and connecting: .. Connection successful!

R is connected to the H2O cluster: 
    H2O cluster uptime:         9 seconds 853 milliseconds 
    H2O cluster timezone:       America/Mexico_City 
    H2O data parsing timezone:  UTC 
    H2O cluster version:        3.42.0.2 
    H2O cluster version age:    5 months and 14 days 
    H2O cluster name:           H2O_started_from_R_ML_ctt216 
    H2O cluster total nodes:    1 
    H2O cluster total memory:   3.52 GB 
    H2O cluster total cores:    4 
    H2O cluster allowed cores:  4 
    H2O cluster healthy:        TRUE 
    H2O Connection ip:          localhost 
    H2O Connection port:        54321 
    H2O Connection proxy:       NA 
    H2O Internal Security:      FALSE 
    R Version:                  R version 4.3.2 (2023-10-31 ucrt) </code></pre>
</div>
</div>
<p>We need the data sets in a format that can be readable by H2O. This is an easy step.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb87"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb87-1"><a href="#cb87-1"></a><span class="co"># Convert to H2OFrame objects.</span></span>
<span id="cb87-2"><a href="#cb87-2"></a><span class="fu">h2o.no_progress</span>() <span class="co"># We do not need a progress bar here.</span></span>
<span id="cb87-3"><a href="#cb87-3"></a>train_h2o <span class="ot">&lt;-</span> <span class="fu">as.h2o</span>(train_tbl)</span>
<span id="cb87-4"><a href="#cb87-4"></a>valid_h2o <span class="ot">&lt;-</span> <span class="fu">as.h2o</span>(valid_tbl)</span>
<span id="cb87-5"><a href="#cb87-5"></a>test_h2o  <span class="ot">&lt;-</span> <span class="fu">as.h2o</span>(test_tbl)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Let’s list the names of the variables.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb88"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb88-1"><a href="#cb88-1"></a><span class="co"># Set names for h2o.</span></span>
<span id="cb88-2"><a href="#cb88-2"></a>y <span class="ot">&lt;-</span> <span class="st">"sales"</span></span>
<span id="cb88-3"><a href="#cb88-3"></a>x <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(<span class="fu">names</span>(train_h2o), y) <span class="co"># Adds sales to the names list.</span></span>
<span id="cb88-4"><a href="#cb88-4"></a><span class="fu">colnames</span>(train_h2o)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "symbol"    "sales"     "index.num" "year"      "year.iso"  "half"     
 [7] "quarter"   "month"     "month.xts" "month.lbl" "day"       "hour"     
[13] "minute"    "second"    "hour12"    "am.pm"     "wday"      "wday.xts" 
[19] "wday.lbl"  "mday"      "qday"      "yday"      "mweek"     "week"     
[25] "week.iso"  "week2"     "week3"     "week4"     "mday7"    </code></pre>
</div>
</div>
<p>The <tt><code>h2o.automl()</code></tt> is a function in H2O that automates the process of building a large number of models, with the goal of finding the <em>best</em> model without any prior knowledge or effort by the data scientist. The alternative of using <tt><code>h2o.automl()</code></tt> is to pick some models according to the database characteristics, implement the models, and pick the one with the best performance according to some evaluation criterion. This alternative is time consuming and it could use an intensive computational memory and power, this is why H2O is valuable.</p>
<p>The available algorithms that <tt><code>h2o.automl()</code></tt> currently run and compare are (click on each one to see a full description):</p>
<ul>
<li><a href="https://docs.h2o.ai/h2o/latest-stable/h2o-docs/data-science/drf.html">Distributed Random Forest (DRF).</a></li>
<li><a href="https://docs.h2o.ai/h2o/latest-stable/h2o-docs/data-science/glm.html?highlight=glm">Generalized Linear Model (GLM).</a></li>
<li><a href="https://docs.h2o.ai/h2o/latest-stable/h2o-docs/data-science/xgboost.html?highlight=xgboost">XGBoost.</a></li>
<li><a href="https://docs.h2o.ai/h2o/latest-stable/h2o-docs/data-science/gbm.html?highlight=gbm">Gradient Boosting Machine (GBM).</a></li>
<li><a href="https://docs.h2o.ai/h2o/latest-stable/h2o-docs/data-science/deep-learning.html?highlight=deeplearning">Deep Learning (Neural Networks).</a></li>
<li><a href="https://docs.h2o.ai/h2o/latest-stable/h2o-docs/data-science/stacked-ensembles.html?highlight=stackedensemble">Stacked Ensembles.</a></li>
</ul>
<p>When we implement <tt><code>h2o.automl()</code></tt> function, H2O test for the six <em>algorithms</em> listed above. Each algorithm includes many other <em>models</em> that belongs to these algorithms in the machine learning process. The result of <tt><code>h2o.automl()</code></tt> is one model that belongs to one algorithm. This is the difference between forecasting techniques, algorithms, and models.</p>
</section>
<section id="estimate-h2o-models." class="level2" data-number="3.4">
<h2 data-number="3.4" class="anchored" data-anchor-id="estimate-h2o-models."><span class="header-section-number">3.4</span> Estimate H2O models.</h2>
<p>Here, we implement the <tt><code>h2o.automl()</code></tt> in three different ways because of reproducibility issues. Reproducibility means obtaining consistent computational results using the same input data, computational steps, methods, code, and conditions of analysis. It turns out that Deep Learning cannot be reproducible by construction. Then, we first apply <tt><code>h2o.automl()</code></tt> without Deep Learning. Second, we apply <tt><code>h2o.automl()</code></tt> with only Deep Learning, here the results will be different each time we run the code. And third, including all available algorithms in <tt><code>h2o.automl()</code></tt>, again, the results might change every time we run the code. The first is the only one which can be reproducible and the other two are expected to change every time we run the R code.</p>
<p>Please note that in the code below we set <tt><code>exclude_algos</code></tt> to exclude Deep Learning, and <tt><code>seed = 13</code></tt> to make sure every time we run the code we can get the same results.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb90"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb90-1"><a href="#cb90-1"></a><span class="co"># It takes some time to run. </span></span>
<span id="cb90-2"><a href="#cb90-2"></a><span class="fu">tic</span>(<span class="st">"inner1"</span>)</span>
<span id="cb90-3"><a href="#cb90-3"></a></span>
<span id="cb90-4"><a href="#cb90-4"></a>automl_models_h2o <span class="ot">&lt;-</span> <span class="fu">h2o.automl</span>(<span class="at">x =</span> x, <span class="at">y =</span> y, <span class="at">training_frame =</span> train_h2o, </span>
<span id="cb90-5"><a href="#cb90-5"></a>    <span class="at">validation_frame =</span> valid_h2o, <span class="at">leaderboard_frame =</span> test_h2o,</span>
<span id="cb90-6"><a href="#cb90-6"></a>    <span class="at">exclude_algos =</span> <span class="fu">c</span>(<span class="st">"DeepLearning"</span>), <span class="co"># without Deep Learning.</span></span>
<span id="cb90-7"><a href="#cb90-7"></a>    <span class="co">#max_models = 10, # We can adjust this to save time.</span></span>
<span id="cb90-8"><a href="#cb90-8"></a>    <span class="at">max_runtime_secs =</span> <span class="dv">60</span>, <span class="at">stopping_metric =</span> <span class="st">"RMSE"</span>, <span class="at">seed =</span> <span class="dv">13</span>,</span>
<span id="cb90-9"><a href="#cb90-9"></a>    <span class="at">verbosity =</span> <span class="cn">NULL</span>)</span>
<span id="cb90-10"><a href="#cb90-10"></a></span>
<span id="cb90-11"><a href="#cb90-11"></a>t_inner1 <span class="ot">&lt;-</span> <span class="fu">toc</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>inner1: 505.81 sec elapsed</code></pre>
</div>
</div>
<p>After 8.43 minutes running, the selected model by <tt><code>h2o.automl()</code></tt> is:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb92"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb92-1"><a href="#cb92-1"></a><span class="co"># Extract leader model.</span></span>
<span id="cb92-2"><a href="#cb92-2"></a>automl_leader <span class="ot">&lt;-</span> automl_models_h2o<span class="sc">@</span>leader</span>
<span id="cb92-3"><a href="#cb92-3"></a>automl_leader<span class="sc">@</span>algorithm</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "stackedensemble"</code></pre>
</div>
</div>
<p>See why stackedensemble was the chosen one. Model rankings: <tt><code>h2o.automl()</code></tt> without Deep Learning algorithm.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb94"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb94-1"><a href="#cb94-1"></a><span class="co"># Model rankings: h2o.automl without Deep Learning algorithm.</span></span>
<span id="cb94-2"><a href="#cb94-2"></a><span class="fu">head</span>(automl_models_h2o<span class="sc">@</span>leaderboard[,<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>], <span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>                                                 model_id     rmse
1  StackedEnsemble_BestOfFamily_3_AutoML_1_20240109_00755 1048.771
2  StackedEnsemble_BestOfFamily_5_AutoML_1_20240109_00755 1061.491
3             GBM_grid_1_AutoML_1_20240109_00755_model_39 1199.115
4  StackedEnsemble_BestOfFamily_4_AutoML_1_20240109_00755 1215.447
5            GBM_grid_1_AutoML_1_20240109_00755_model_219 1263.118
6             GBM_grid_1_AutoML_1_20240109_00755_model_64 1263.946
7            GBM_grid_1_AutoML_1_20240109_00755_model_118 1319.513
8      StackedEnsemble_Best1000_1_AutoML_1_20240109_00755 1354.083
9     StackedEnsemble_AllModels_5_AutoML_1_20240109_00755 1360.523
10    StackedEnsemble_AllModels_3_AutoML_1_20240109_00755 1360.523</code></pre>
</div>
</div>
<p>The <tt><code>model_id</code></tt> column list the top 10 models with the lowest errors. The value of <tt><code>h2o.automl()</code></tt> is that we can take the best model and use it to conduct our forecast. Remember we proposed to run <tt><code>h2o.automl()</code></tt> three times. Now let’s consider the second alternative (only Deep Learning). There are several ways to implement Deep Learning, this is why it makes sense to use only this family into the <tt><code>h2o.automl()</code></tt> function. Deep Learning cannot be reproducible by construction so adding a seed in this case would be useless.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb96"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb96-1"><a href="#cb96-1"></a><span class="co"># This might take some time to run. </span></span>
<span id="cb96-2"><a href="#cb96-2"></a><span class="fu">tic</span>(<span class="st">"inner2"</span>)</span>
<span id="cb96-3"><a href="#cb96-3"></a></span>
<span id="cb96-4"><a href="#cb96-4"></a>DL <span class="ot">&lt;-</span> <span class="fu">h2o.automl</span>(<span class="at">x =</span> x, <span class="at">y =</span> y, <span class="at">training_frame =</span> train_h2o, </span>
<span id="cb96-5"><a href="#cb96-5"></a>    <span class="at">validation_frame =</span> valid_h2o, <span class="at">leaderboard_frame =</span> test_h2o,</span>
<span id="cb96-6"><a href="#cb96-6"></a>    <span class="at">include_algos =</span> <span class="fu">c</span>(<span class="st">"DeepLearning"</span>), <span class="at">max_runtime_secs =</span> <span class="dv">60</span>, </span>
<span id="cb96-7"><a href="#cb96-7"></a>    <span class="at">stopping_metric =</span> <span class="st">"RMSE"</span>, <span class="at">verbosity =</span> <span class="cn">NULL</span>)</span>
<span id="cb96-8"><a href="#cb96-8"></a></span>
<span id="cb96-9"><a href="#cb96-9"></a>t_inner2 <span class="ot">&lt;-</span> <span class="fu">toc</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>inner2: 183.33 sec elapsed</code></pre>
</div>
</div>
<p>After 3.06 minutes running, the selected Deep Learning model by <tt><code>h2o.automl()</code></tt> is:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb98"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb98-1"><a href="#cb98-1"></a><span class="co"># Extract leader model</span></span>
<span id="cb98-2"><a href="#cb98-2"></a>automl_DL <span class="ot">&lt;-</span> DL<span class="sc">@</span>leader</span>
<span id="cb98-3"><a href="#cb98-3"></a>automl_DL<span class="sc">@</span>algorithm</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "deeplearning"</code></pre>
</div>
</div>
<p>See why this specific deeplearning model was the chosen one. Model rankings: <tt><code>h2o.automl()</code></tt> with only Deep Learning algorithm.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb100"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb100-1"><a href="#cb100-1"></a><span class="fu">head</span>(DL<span class="sc">@</span>leaderboard[,<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>], <span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>                                             model_id     rmse
1 DeepLearning_grid_1_AutoML_2_20240109_01621_model_2 1028.497
2 DeepLearning_grid_1_AutoML_2_20240109_01621_model_1 1212.859
3 DeepLearning_grid_1_AutoML_2_20240109_01621_model_4 1489.465
4 DeepLearning_grid_1_AutoML_2_20240109_01621_model_6 1826.080
5 DeepLearning_grid_1_AutoML_2_20240109_01621_model_7 1859.433
6 DeepLearning_grid_1_AutoML_2_20240109_01621_model_5 1895.855
7 DeepLearning_grid_1_AutoML_2_20240109_01621_model_3 2068.979
8              DeepLearning_1_AutoML_2_20240109_01621 2374.515</code></pre>
</div>
</div>
<p>All models belong to the same algorithm, but we clearly choose the first one of the list. The machine learning workflow estimate a number of models using the train region and evaluate them using the validation region. The estimated model parameters then change as they learn from their mistakes. This process is repeated until a specific restriction meets, in this case <tt><code>max_runtime_secs</code></tt> is set to 60 seconds. At the end, we select the best ranked model.</p>
<p>Now let’s consider the third alternative. This is, run <tt><code>h2o.automl()</code></tt> with no restrictions at all. Here, it would be interesting to see if this led to the best alternative. In principle, we cannot anticipate which one of these three runs will be the best. This is because the Deep Learning algorithm has a random component which might lead to better results, and remember the second round was exclusive for Deep Learning and the third includes Deep Learning. Then, every time I compile this document or run this R code we should expect different results in the second and third alternative.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb102"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb102-1"><a href="#cb102-1"></a><span class="fu">tic</span>(<span class="st">"inner3"</span>)</span>
<span id="cb102-2"><a href="#cb102-2"></a><span class="co"># This might take some time to run. </span></span>
<span id="cb102-3"><a href="#cb102-3"></a>automl_models_h2o_all <span class="ot">&lt;-</span> <span class="fu">h2o.automl</span>(<span class="at">x =</span> x, <span class="at">y =</span> y, </span>
<span id="cb102-4"><a href="#cb102-4"></a>    <span class="at">training_frame =</span> train_h2o, <span class="at">validation_frame =</span> valid_h2o, </span>
<span id="cb102-5"><a href="#cb102-5"></a>    <span class="at">leaderboard_frame =</span> test_h2o, <span class="at">max_runtime_secs =</span> <span class="dv">60</span>, </span>
<span id="cb102-6"><a href="#cb102-6"></a>    <span class="at">stopping_metric =</span> <span class="st">"RMSE"</span>, <span class="at">verbosity =</span> <span class="cn">NULL</span>)</span>
<span id="cb102-7"><a href="#cb102-7"></a></span>
<span id="cb102-8"><a href="#cb102-8"></a>t_inner3 <span class="ot">&lt;-</span> <span class="fu">toc</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>inner3: 511.15 sec elapsed</code></pre>
</div>
</div>
<p>After 8.52 minutes running, the selected model by <tt><code>h2o.automl()</code></tt> is:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb104"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb104-1"><a href="#cb104-1"></a><span class="co"># Extract leader model</span></span>
<span id="cb104-2"><a href="#cb104-2"></a>automl_leader_all <span class="ot">&lt;-</span> automl_models_h2o_all<span class="sc">@</span>leader</span>
<span id="cb104-3"><a href="#cb104-3"></a>automl_leader_all<span class="sc">@</span>algorithm</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "stackedensemble"</code></pre>
</div>
</div>
<p>See why c model was the chosen one in this specific and unique code compilation. Model rankings: <tt><code>h2o.automl</code></tt> with all available algorithms</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb106"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb106-1"><a href="#cb106-1"></a><span class="fu">head</span>(automl_models_h2o_all<span class="sc">@</span>leaderboard[,<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>], <span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>                                                 model_id     rmse
1  StackedEnsemble_BestOfFamily_3_AutoML_3_20240109_01927 1071.224
2     DeepLearning_grid_1_AutoML_3_20240109_01927_model_2 1320.492
3             GBM_grid_1_AutoML_3_20240109_01927_model_65 1330.039
4     StackedEnsemble_AllModels_3_AutoML_3_20240109_01927 1389.254
5             GBM_grid_1_AutoML_3_20240109_01927_model_56 1402.098
6              GBM_grid_1_AutoML_3_20240109_01927_model_9 1406.070
7     StackedEnsemble_AllModels_4_AutoML_3_20240109_01927 1417.645
8            GBM_grid_1_AutoML_3_20240109_01927_model_115 1423.343
9              GBM_grid_1_AutoML_3_20240109_01927_model_5 1426.755
10           GBM_grid_1_AutoML_3_20240109_01927_model_121 1435.739</code></pre>
</div>
</div>
<p>Let’s summarize the results according to the root mean square error <em>rmse</em> as this was the criterion in <tt><code>stopping_metric</code></tt>. The table shows the best ranked model according to our three different runs of <tt><code>h2o.automl()</code></tt>.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb108"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb108-1"><a href="#cb108-1"></a><span class="co"># Collect model names and the rmse.</span></span>
<span id="cb108-2"><a href="#cb108-2"></a>without_DL <span class="ot">&lt;-</span> <span class="fu">c</span>(automl_leader<span class="sc">@</span>algorithm, </span>
<span id="cb108-3"><a href="#cb108-3"></a>                <span class="fu">round</span>(automl_models_h2o<span class="sc">@</span>leaderboard[<span class="dv">1</span>, <span class="dv">2</span>], <span class="dv">2</span>))</span>
<span id="cb108-4"><a href="#cb108-4"></a>only_DL <span class="ot">&lt;-</span> <span class="fu">c</span>(automl_DL<span class="sc">@</span>algorithm, </span>
<span id="cb108-5"><a href="#cb108-5"></a>             <span class="fu">round</span>(DL<span class="sc">@</span>leaderboard[<span class="dv">1</span>,<span class="dv">2</span>], <span class="dv">2</span>))</span>
<span id="cb108-6"><a href="#cb108-6"></a>all <span class="ot">&lt;-</span> <span class="fu">c</span>(automl_leader_all<span class="sc">@</span>algorithm, </span>
<span id="cb108-7"><a href="#cb108-7"></a>         <span class="fu">round</span>(automl_models_h2o_all<span class="sc">@</span>leaderboard[<span class="dv">1</span>, <span class="dv">2</span>], <span class="dv">2</span>))</span>
<span id="cb108-8"><a href="#cb108-8"></a><span class="co"># Three different runs of h2o.automl.</span></span>
<span id="cb108-9"><a href="#cb108-9"></a>automl_three <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(without_DL, only_DL, all)</span>
<span id="cb108-10"><a href="#cb108-10"></a><span class="fu">colnames</span>(automl_three) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Without Deep Learning"</span>, <span class="st">"Only Deep Learning"</span>,</span>
<span id="cb108-11"><a href="#cb108-11"></a>                            <span class="st">"All algorithms"</span>)</span>
<span id="cb108-12"><a href="#cb108-12"></a><span class="fu">kable</span>(automl_three, </span>
<span id="cb108-13"><a href="#cb108-13"></a><span class="at">caption =</span> <span class="st">"Top ranked models: h2o.automl rmse."</span>) <span class="sc">%&gt;%</span></span>
<span id="cb108-14"><a href="#cb108-14"></a><span class="fu">kable_styling</span>(<span class="at">latex_options =</span> <span class="st">"HOLD_position"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="table table-sm table-striped small" data-quarto-postprocess="true">
<caption>Top ranked models: h2o.automl rmse.</caption>
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">Without Deep Learning</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">Only Deep Learning</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">All algorithms</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">stackedensemble</td>
<td style="text-align: left;">deeplearning</td>
<td style="text-align: left;">stackedensemble</td>
</tr>
<tr class="even">
<td style="text-align: left;">1048.77</td>
<td style="text-align: left;">1028.5</td>
<td style="text-align: left;">1071.22</td>
</tr>
</tbody>
</table>


</div>
</div>
<p>This is interesting because this suggest that it makes sense to run the H2O more than one time. It would be good to test for a different <tt><code>stopping_metric</code></tt>, <tt><code>max_runtime_secs</code></tt> and <tt><code>max_models</code></tt>.</p>
</section>
<section id="predictions." class="level2" data-number="3.5">
<h2 data-number="3.5" class="anchored" data-anchor-id="predictions."><span class="header-section-number">3.5</span> Predictions.</h2>
<p>Here are the forecasts.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb109"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb109-1"><a href="#cb109-1"></a><span class="co"># The h2o.predict function do the job.</span></span>
<span id="cb109-2"><a href="#cb109-2"></a>pred_h2o <span class="ot">&lt;-</span> <span class="fu">h2o.predict</span>(automl_leader, <span class="at">newdata =</span> test_h2o)</span>
<span id="cb109-3"><a href="#cb109-3"></a>pred_h2o_DL <span class="ot">&lt;-</span> <span class="fu">h2o.predict</span>(automl_DL, <span class="at">newdata =</span> test_h2o)</span>
<span id="cb109-4"><a href="#cb109-4"></a>pred_h2o_all <span class="ot">&lt;-</span> <span class="fu">h2o.predict</span>(automl_leader_all, <span class="at">newdata =</span> test_h2o)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Let’s show the results in a table. First, the case without Deep Learning.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb110"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb110-1"><a href="#cb110-1"></a><span class="co"># 10-period forecast error: h2o.automl without Deep Learning.</span></span>
<span id="cb110-2"><a href="#cb110-2"></a>error_tbl <span class="ot">&lt;-</span> beer <span class="sc">%&gt;%</span> </span>
<span id="cb110-3"><a href="#cb110-3"></a>    <span class="fu">filter</span>(lubridate<span class="sc">::</span><span class="fu">year</span>(date) <span class="sc">==</span> <span class="dv">2022</span>) <span class="sc">%&gt;%</span></span>
<span id="cb110-4"><a href="#cb110-4"></a>    <span class="fu">add_column</span>(<span class="at">pred =</span> pred_h2o <span class="sc">%&gt;%</span> <span class="fu">as_tibble</span>() <span class="sc">%&gt;%</span> <span class="fu">pull</span>(predict)) <span class="sc">%&gt;%</span></span>
<span id="cb110-5"><a href="#cb110-5"></a>    <span class="fu">rename</span>(<span class="at">actual =</span> sales) <span class="sc">%&gt;%</span></span>
<span id="cb110-6"><a href="#cb110-6"></a>    <span class="fu">mutate</span>(<span class="at">error =</span> actual <span class="sc">-</span> pred, <span class="at">error_pct =</span> error <span class="sc">/</span> actual)</span>
<span id="cb110-7"><a href="#cb110-7"></a><span class="fu">kable</span>(error_tbl, </span>
<span id="cb110-8"><a href="#cb110-8"></a><span class="at">caption =</span> <span class="st">"Detailed performance: h2o.automl without Deep Learning algorithm."</span>,</span>
<span id="cb110-9"><a href="#cb110-9"></a><span class="at">digits =</span> <span class="dv">3</span>, <span class="at">row.names =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb110-10"><a href="#cb110-10"></a><span class="fu">kable_styling</span>(<span class="at">latex_options =</span> <span class="st">"HOLD_position"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="table table-sm table-striped small" data-quarto-postprocess="true">
<caption>Detailed performance: h2o.automl without Deep Learning algorithm.</caption>
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th"></th>
<th style="text-align: left;" data-quarto-table-cell-role="th">symbol</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">date</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">actual</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">pred</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">error</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">error_pct</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">1</td>
<td style="text-align: left;">S4248SM144NCEN</td>
<td style="text-align: left;">2022-01-01</td>
<td style="text-align: right;">11862</td>
<td style="text-align: right;">11930.03</td>
<td style="text-align: right;">-68.035</td>
<td style="text-align: right;">-0.006</td>
</tr>
<tr class="even">
<td style="text-align: left;">2</td>
<td style="text-align: left;">S4248SM144NCEN</td>
<td style="text-align: left;">2022-02-01</td>
<td style="text-align: right;">13358</td>
<td style="text-align: right;">12807.85</td>
<td style="text-align: right;">550.151</td>
<td style="text-align: right;">0.041</td>
</tr>
<tr class="odd">
<td style="text-align: left;">3</td>
<td style="text-align: left;">S4248SM144NCEN</td>
<td style="text-align: left;">2022-03-01</td>
<td style="text-align: right;">16216</td>
<td style="text-align: right;">15018.13</td>
<td style="text-align: right;">1197.874</td>
<td style="text-align: right;">0.074</td>
</tr>
<tr class="even">
<td style="text-align: left;">4</td>
<td style="text-align: left;">S4248SM144NCEN</td>
<td style="text-align: left;">2022-04-01</td>
<td style="text-align: right;">15766</td>
<td style="text-align: right;">14151.34</td>
<td style="text-align: right;">1614.659</td>
<td style="text-align: right;">0.102</td>
</tr>
<tr class="odd">
<td style="text-align: left;">5</td>
<td style="text-align: left;">S4248SM144NCEN</td>
<td style="text-align: left;">2022-05-01</td>
<td style="text-align: right;">16755</td>
<td style="text-align: right;">15760.85</td>
<td style="text-align: right;">994.146</td>
<td style="text-align: right;">0.059</td>
</tr>
<tr class="even">
<td style="text-align: left;">6</td>
<td style="text-align: left;">S4248SM144NCEN</td>
<td style="text-align: left;">2022-06-01</td>
<td style="text-align: right;">17882</td>
<td style="text-align: right;">16255.50</td>
<td style="text-align: right;">1626.499</td>
<td style="text-align: right;">0.091</td>
</tr>
<tr class="odd">
<td style="text-align: left;">7</td>
<td style="text-align: left;">S4248SM144NCEN</td>
<td style="text-align: left;">2022-07-01</td>
<td style="text-align: right;">15168</td>
<td style="text-align: right;">14577.47</td>
<td style="text-align: right;">590.527</td>
<td style="text-align: right;">0.039</td>
</tr>
<tr class="even">
<td style="text-align: left;">8</td>
<td style="text-align: left;">S4248SM144NCEN</td>
<td style="text-align: left;">2022-08-01</td>
<td style="text-align: right;">16977</td>
<td style="text-align: right;">16029.08</td>
<td style="text-align: right;">947.916</td>
<td style="text-align: right;">0.056</td>
</tr>
<tr class="odd">
<td style="text-align: left;">9</td>
<td style="text-align: left;">S4248SM144NCEN</td>
<td style="text-align: left;">2022-09-01</td>
<td style="text-align: right;">16430</td>
<td style="text-align: right;">15168.44</td>
<td style="text-align: right;">1261.562</td>
<td style="text-align: right;">0.077</td>
</tr>
<tr class="even">
<td style="text-align: left;">10</td>
<td style="text-align: left;">S4248SM144NCEN</td>
<td style="text-align: left;">2022-10-01</td>
<td style="text-align: right;">15480</td>
<td style="text-align: right;">15901.02</td>
<td style="text-align: right;">-421.019</td>
<td style="text-align: right;">-0.027</td>
</tr>
</tbody>
</table>


</div>
</div>
<p>The forecast looks good. Note that in some cases it over-estimate and in others under-estimate the real values, but in general these differences are small. Now, let’s look at the same information in a plot.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb111"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb111-1"><a href="#cb111-1"></a>beer <span class="sc">%&gt;%</span></span>
<span id="cb111-2"><a href="#cb111-2"></a>  <span class="fu">filter</span>(date <span class="sc">&gt;</span> <span class="fu">as.Date</span>(<span class="st">"2021-01-01"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb111-3"><a href="#cb111-3"></a>    <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">yearmonth</span>(date), <span class="at">y =</span> sales)) <span class="sc">+</span></span>
<span id="cb111-4"><a href="#cb111-4"></a>    <span class="co"># Data.</span></span>
<span id="cb111-5"><a href="#cb111-5"></a>    <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">5</span>, <span class="at">color =</span> <span class="st">"black"</span>, <span class="at">alpha =</span> <span class="fl">0.5</span>, </span>
<span id="cb111-6"><a href="#cb111-6"></a>               <span class="at">shape =</span> <span class="dv">21</span>, <span class="at">fill =</span> <span class="st">"black"</span>) <span class="sc">+</span></span>
<span id="cb111-7"><a href="#cb111-7"></a>    <span class="fu">geom_line</span>(<span class="at">color =</span> <span class="st">"black"</span>, <span class="at">size =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb111-8"><a href="#cb111-8"></a>    <span class="co"># Predictions.</span></span>
<span id="cb111-9"><a href="#cb111-9"></a>    <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">y =</span> pred), <span class="at">size =</span> <span class="dv">5</span>, </span>
<span id="cb111-10"><a href="#cb111-10"></a>               <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">alpha =</span> <span class="fl">0.5</span>, <span class="at">shape =</span> <span class="dv">21</span>, </span>
<span id="cb111-11"><a href="#cb111-11"></a>               <span class="at">fill =</span> <span class="st">"red"</span>, <span class="at">data =</span> error_tbl) <span class="sc">+</span></span>
<span id="cb111-12"><a href="#cb111-12"></a><span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> pred), <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">size =</span> <span class="fl">0.5</span>, <span class="at">data =</span> error_tbl) <span class="sc">+</span></span>
<span id="cb111-13"><a href="#cb111-13"></a><span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="fu">as.numeric</span>(<span class="fu">as.Date</span>(<span class="st">"2021-12-01"</span>)), <span class="at">linetype =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb111-14"><a href="#cb111-14"></a>    <span class="co"># Aesthetics.</span></span>
<span id="cb111-15"><a href="#cb111-15"></a>    <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Date"</span>, <span class="at">y =</span> <span class="st">"Sales"</span>,</span>
<span id="cb111-16"><a href="#cb111-16"></a>    <span class="at">caption =</span> <span class="fu">c</span>(<span class="fu">paste</span>(<span class="st">"MAPE="</span>, </span>
<span id="cb111-17"><a href="#cb111-17"></a>                      ((<span class="fu">round</span>(<span class="fu">mean</span>(<span class="fu">abs</span>(error_tbl<span class="sc">$</span>error_pct))<span class="sc">*</span><span class="dv">100</span>, <span class="dv">5</span>)))))) <span class="sc">+</span></span>
<span id="cb111-18"><a href="#cb111-18"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">labels =</span> scales<span class="sc">::</span>dollar)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-fhwdla" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="index_files/figure-html/fig-fhwdla-1.png" class="img-fluid figure-img" width="672"></p>
<figcaption class="figure-caption">Figure&nbsp;3.3: Forecast. H2O without Deep Learning algorithm.</figcaption>
</figure>
</div>
</div>
</div>
<p>This is an additional performance summary.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb112"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb112-1"><a href="#cb112-1"></a><span class="co"># Without Deep Learning.</span></span>
<span id="cb112-2"><a href="#cb112-2"></a><span class="fu">h2o.performance</span>(automl_leader, <span class="at">newdata =</span> test_h2o)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>H2ORegressionMetrics: stackedensemble

MSE:  1099921
RMSE:  1048.771
MAE:  927.2389
RMSLE:  0.0664646
Mean Residual Deviance :  1099921</code></pre>
</div>
</div>
<p>Now, the case of only Deep Learning. The detailed forecast is in the following table.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb114"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb114-1"><a href="#cb114-1"></a><span class="co"># 10-period forecast error: h2o.automl only Deep Learning.</span></span>
<span id="cb114-2"><a href="#cb114-2"></a>error_tbl_DL <span class="ot">&lt;-</span> beer <span class="sc">%&gt;%</span> </span>
<span id="cb114-3"><a href="#cb114-3"></a>    <span class="fu">filter</span>(lubridate<span class="sc">::</span><span class="fu">year</span>(date) <span class="sc">==</span> <span class="dv">2022</span>) <span class="sc">%&gt;%</span></span>
<span id="cb114-4"><a href="#cb114-4"></a>    <span class="fu">add_column</span>(<span class="at">pred =</span> pred_h2o_DL <span class="sc">%&gt;%</span> <span class="fu">as_tibble</span>() <span class="sc">%&gt;%</span> <span class="fu">pull</span>(predict)) <span class="sc">%&gt;%</span></span>
<span id="cb114-5"><a href="#cb114-5"></a>    <span class="fu">rename</span>(<span class="at">actual =</span> sales) <span class="sc">%&gt;%</span></span>
<span id="cb114-6"><a href="#cb114-6"></a>    <span class="fu">mutate</span>(<span class="at">error =</span> actual <span class="sc">-</span> pred, <span class="at">error_pct =</span> error <span class="sc">/</span> actual) </span>
<span id="cb114-7"><a href="#cb114-7"></a><span class="fu">kable</span>(error_tbl_DL, </span>
<span id="cb114-8"><a href="#cb114-8"></a><span class="at">caption =</span> <span class="st">"Detailed performance: h2o.automl only Deep Learning algorithm."</span>,</span>
<span id="cb114-9"><a href="#cb114-9"></a>      <span class="at">digits =</span> <span class="dv">3</span>, <span class="at">row.names =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb114-10"><a href="#cb114-10"></a><span class="fu">kable_styling</span>(<span class="at">latex_options =</span> <span class="st">"HOLD_position"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="table table-sm table-striped small" data-quarto-postprocess="true">
<caption>Detailed performance: h2o.automl only Deep Learning algorithm.</caption>
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th"></th>
<th style="text-align: left;" data-quarto-table-cell-role="th">symbol</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">date</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">actual</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">pred</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">error</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">error_pct</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">1</td>
<td style="text-align: left;">S4248SM144NCEN</td>
<td style="text-align: left;">2022-01-01</td>
<td style="text-align: right;">11862</td>
<td style="text-align: right;">12058.95</td>
<td style="text-align: right;">-196.955</td>
<td style="text-align: right;">-0.017</td>
</tr>
<tr class="even">
<td style="text-align: left;">2</td>
<td style="text-align: left;">S4248SM144NCEN</td>
<td style="text-align: left;">2022-02-01</td>
<td style="text-align: right;">13358</td>
<td style="text-align: right;">12953.52</td>
<td style="text-align: right;">404.475</td>
<td style="text-align: right;">0.030</td>
</tr>
<tr class="odd">
<td style="text-align: left;">3</td>
<td style="text-align: left;">S4248SM144NCEN</td>
<td style="text-align: left;">2022-03-01</td>
<td style="text-align: right;">16216</td>
<td style="text-align: right;">15106.23</td>
<td style="text-align: right;">1109.774</td>
<td style="text-align: right;">0.068</td>
</tr>
<tr class="even">
<td style="text-align: left;">4</td>
<td style="text-align: left;">S4248SM144NCEN</td>
<td style="text-align: left;">2022-04-01</td>
<td style="text-align: right;">15766</td>
<td style="text-align: right;">13705.46</td>
<td style="text-align: right;">2060.542</td>
<td style="text-align: right;">0.131</td>
</tr>
<tr class="odd">
<td style="text-align: left;">5</td>
<td style="text-align: left;">S4248SM144NCEN</td>
<td style="text-align: left;">2022-05-01</td>
<td style="text-align: right;">16755</td>
<td style="text-align: right;">16933.65</td>
<td style="text-align: right;">-178.654</td>
<td style="text-align: right;">-0.011</td>
</tr>
<tr class="even">
<td style="text-align: left;">6</td>
<td style="text-align: left;">S4248SM144NCEN</td>
<td style="text-align: left;">2022-06-01</td>
<td style="text-align: right;">17882</td>
<td style="text-align: right;">18073.03</td>
<td style="text-align: right;">-191.025</td>
<td style="text-align: right;">-0.011</td>
</tr>
<tr class="odd">
<td style="text-align: left;">7</td>
<td style="text-align: left;">S4248SM144NCEN</td>
<td style="text-align: left;">2022-07-01</td>
<td style="text-align: right;">15168</td>
<td style="text-align: right;">15369.71</td>
<td style="text-align: right;">-201.706</td>
<td style="text-align: right;">-0.013</td>
</tr>
<tr class="even">
<td style="text-align: left;">8</td>
<td style="text-align: left;">S4248SM144NCEN</td>
<td style="text-align: left;">2022-08-01</td>
<td style="text-align: right;">16977</td>
<td style="text-align: right;">17655.58</td>
<td style="text-align: right;">-678.577</td>
<td style="text-align: right;">-0.040</td>
</tr>
<tr class="odd">
<td style="text-align: left;">9</td>
<td style="text-align: left;">S4248SM144NCEN</td>
<td style="text-align: left;">2022-09-01</td>
<td style="text-align: right;">16430</td>
<td style="text-align: right;">17419.44</td>
<td style="text-align: right;">-989.443</td>
<td style="text-align: right;">-0.060</td>
</tr>
<tr class="even">
<td style="text-align: left;">10</td>
<td style="text-align: left;">S4248SM144NCEN</td>
<td style="text-align: left;">2022-10-01</td>
<td style="text-align: right;">15480</td>
<td style="text-align: right;">17310.21</td>
<td style="text-align: right;">-1830.214</td>
<td style="text-align: right;">-0.118</td>
</tr>
</tbody>
</table>


</div>
</div>
<p>The same information in a plot.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb115"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb115-1"><a href="#cb115-1"></a>beer <span class="sc">%&gt;%</span></span>
<span id="cb115-2"><a href="#cb115-2"></a>    <span class="fu">filter</span>(date <span class="sc">&gt;</span> <span class="fu">as.Date</span>(<span class="st">"2021-01-01"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb115-3"><a href="#cb115-3"></a>    <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">yearmonth</span>(date), <span class="at">y =</span> sales)) <span class="sc">+</span></span>
<span id="cb115-4"><a href="#cb115-4"></a>    <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">5</span>, <span class="at">color =</span> <span class="st">"black"</span>, <span class="at">alpha =</span> <span class="fl">0.5</span>, </span>
<span id="cb115-5"><a href="#cb115-5"></a>               <span class="at">shape =</span> <span class="dv">21</span>, <span class="at">fill =</span> <span class="st">"black"</span>) <span class="sc">+</span></span>
<span id="cb115-6"><a href="#cb115-6"></a>    <span class="fu">geom_line</span>(<span class="at">color =</span> <span class="st">"black"</span>, <span class="at">size =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb115-7"><a href="#cb115-7"></a>    <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">y =</span> pred), <span class="at">size =</span> <span class="dv">5</span>, </span>
<span id="cb115-8"><a href="#cb115-8"></a>               <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">alpha =</span> <span class="fl">0.5</span>, <span class="at">shape =</span> <span class="dv">21</span>, </span>
<span id="cb115-9"><a href="#cb115-9"></a>               <span class="at">fill =</span> <span class="st">"red"</span>, <span class="at">data =</span> error_tbl_DL) <span class="sc">+</span></span>
<span id="cb115-10"><a href="#cb115-10"></a><span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> pred), <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">size =</span> <span class="fl">0.5</span>, </span>
<span id="cb115-11"><a href="#cb115-11"></a>          <span class="at">data =</span> error_tbl_DL) <span class="sc">+</span></span>
<span id="cb115-12"><a href="#cb115-12"></a>    <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="fu">as.numeric</span>(<span class="fu">as.Date</span>(<span class="st">"2021-12-01"</span>)), </span>
<span id="cb115-13"><a href="#cb115-13"></a>               <span class="at">linetype =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb115-14"><a href="#cb115-14"></a>    <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Date"</span>, <span class="at">y =</span> <span class="st">"Sales"</span>,</span>
<span id="cb115-15"><a href="#cb115-15"></a>    <span class="at">caption =</span> <span class="fu">c</span>(<span class="fu">paste</span>(<span class="st">"MAPE="</span>,</span>
<span id="cb115-16"><a href="#cb115-16"></a>                      ((<span class="fu">round</span>(<span class="fu">mean</span>(<span class="fu">abs</span>(error_tbl_DL<span class="sc">$</span>error_pct))<span class="sc">*</span><span class="dv">100</span>, <span class="dv">5</span>)))))) <span class="sc">+</span></span>
<span id="cb115-17"><a href="#cb115-17"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">labels =</span> scales<span class="sc">::</span>dollar)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-fhiodla" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="index_files/figure-html/fig-fhiodla-1.png" class="img-fluid figure-img" width="672"></p>
<figcaption class="figure-caption">Figure&nbsp;3.4: Forecast. H2O including only Deep Learning algorithm.</figcaption>
</figure>
</div>
</div>
</div>
<p>Additional performance indicators.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb116"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb116-1"><a href="#cb116-1"></a><span class="co"># Only Deep Learning.</span></span>
<span id="cb116-2"><a href="#cb116-2"></a><span class="fu">h2o.performance</span>(automl_DL, <span class="at">newdata =</span> test_h2o)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>H2ORegressionMetrics: deeplearning

MSE:  1057807
RMSE:  1028.497
MAE:  784.1365
RMSLE:  0.0661037
Mean Residual Deviance :  1057807</code></pre>
</div>
</div>
<p>Finally, this is the H2O case with no restrictions, considering all available algorithms.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb118"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb118-1"><a href="#cb118-1"></a><span class="co"># 10-period forecast error: h2o.automl all algorithms.</span></span>
<span id="cb118-2"><a href="#cb118-2"></a>error_tbl_all <span class="ot">&lt;-</span> beer <span class="sc">%&gt;%</span> </span>
<span id="cb118-3"><a href="#cb118-3"></a>    <span class="fu">filter</span>(lubridate<span class="sc">::</span><span class="fu">year</span>(date) <span class="sc">==</span> <span class="dv">2022</span>) <span class="sc">%&gt;%</span></span>
<span id="cb118-4"><a href="#cb118-4"></a>    <span class="fu">add_column</span>(<span class="at">pred =</span> pred_h2o_all <span class="sc">%&gt;%</span> <span class="fu">as_tibble</span>() <span class="sc">%&gt;%</span> <span class="fu">pull</span>(predict)) <span class="sc">%&gt;%</span></span>
<span id="cb118-5"><a href="#cb118-5"></a>    <span class="fu">rename</span>(<span class="at">actual =</span> sales) <span class="sc">%&gt;%</span></span>
<span id="cb118-6"><a href="#cb118-6"></a>    <span class="fu">mutate</span>(<span class="at">error =</span> actual <span class="sc">-</span> pred, <span class="at">error_pct =</span> error <span class="sc">/</span> actual) </span>
<span id="cb118-7"><a href="#cb118-7"></a><span class="fu">kable</span>(error_tbl_all, </span>
<span id="cb118-8"><a href="#cb118-8"></a>      <span class="at">caption =</span> <span class="st">"Detailed performance: h2o.automl all algorithms."</span>,</span>
<span id="cb118-9"><a href="#cb118-9"></a>      <span class="at">digits =</span> <span class="dv">3</span>, <span class="at">row.names =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb118-10"><a href="#cb118-10"></a><span class="fu">kable_styling</span>(<span class="at">latex_options =</span> <span class="st">"HOLD_position"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="table table-sm table-striped small" data-quarto-postprocess="true">
<caption>Detailed performance: h2o.automl all algorithms.</caption>
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th"></th>
<th style="text-align: left;" data-quarto-table-cell-role="th">symbol</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">date</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">actual</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">pred</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">error</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">error_pct</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">1</td>
<td style="text-align: left;">S4248SM144NCEN</td>
<td style="text-align: left;">2022-01-01</td>
<td style="text-align: right;">11862</td>
<td style="text-align: right;">11827.03</td>
<td style="text-align: right;">34.970</td>
<td style="text-align: right;">0.003</td>
</tr>
<tr class="even">
<td style="text-align: left;">2</td>
<td style="text-align: left;">S4248SM144NCEN</td>
<td style="text-align: left;">2022-02-01</td>
<td style="text-align: right;">13358</td>
<td style="text-align: right;">12590.54</td>
<td style="text-align: right;">767.459</td>
<td style="text-align: right;">0.057</td>
</tr>
<tr class="odd">
<td style="text-align: left;">3</td>
<td style="text-align: left;">S4248SM144NCEN</td>
<td style="text-align: left;">2022-03-01</td>
<td style="text-align: right;">16216</td>
<td style="text-align: right;">14525.07</td>
<td style="text-align: right;">1690.935</td>
<td style="text-align: right;">0.104</td>
</tr>
<tr class="even">
<td style="text-align: left;">4</td>
<td style="text-align: left;">S4248SM144NCEN</td>
<td style="text-align: left;">2022-04-01</td>
<td style="text-align: right;">15766</td>
<td style="text-align: right;">13953.26</td>
<td style="text-align: right;">1812.742</td>
<td style="text-align: right;">0.115</td>
</tr>
<tr class="odd">
<td style="text-align: left;">5</td>
<td style="text-align: left;">S4248SM144NCEN</td>
<td style="text-align: left;">2022-05-01</td>
<td style="text-align: right;">16755</td>
<td style="text-align: right;">15716.99</td>
<td style="text-align: right;">1038.006</td>
<td style="text-align: right;">0.062</td>
</tr>
<tr class="even">
<td style="text-align: left;">6</td>
<td style="text-align: left;">S4248SM144NCEN</td>
<td style="text-align: left;">2022-06-01</td>
<td style="text-align: right;">17882</td>
<td style="text-align: right;">16500.34</td>
<td style="text-align: right;">1381.662</td>
<td style="text-align: right;">0.077</td>
</tr>
<tr class="odd">
<td style="text-align: left;">7</td>
<td style="text-align: left;">S4248SM144NCEN</td>
<td style="text-align: left;">2022-07-01</td>
<td style="text-align: right;">15168</td>
<td style="text-align: right;">15180.70</td>
<td style="text-align: right;">-12.701</td>
<td style="text-align: right;">-0.001</td>
</tr>
<tr class="even">
<td style="text-align: left;">8</td>
<td style="text-align: left;">S4248SM144NCEN</td>
<td style="text-align: left;">2022-08-01</td>
<td style="text-align: right;">16977</td>
<td style="text-align: right;">16062.97</td>
<td style="text-align: right;">914.028</td>
<td style="text-align: right;">0.054</td>
</tr>
<tr class="odd">
<td style="text-align: left;">9</td>
<td style="text-align: left;">S4248SM144NCEN</td>
<td style="text-align: left;">2022-09-01</td>
<td style="text-align: right;">16430</td>
<td style="text-align: right;">15585.70</td>
<td style="text-align: right;">844.297</td>
<td style="text-align: right;">0.051</td>
</tr>
<tr class="even">
<td style="text-align: left;">10</td>
<td style="text-align: left;">S4248SM144NCEN</td>
<td style="text-align: left;">2022-10-01</td>
<td style="text-align: right;">15480</td>
<td style="text-align: right;">15932.56</td>
<td style="text-align: right;">-452.555</td>
<td style="text-align: right;">-0.029</td>
</tr>
</tbody>
</table>


</div>
</div>
<p>The visual representation.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb119"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb119-1"><a href="#cb119-1"></a>beer <span class="sc">%&gt;%</span></span>
<span id="cb119-2"><a href="#cb119-2"></a>    <span class="fu">filter</span>(date <span class="sc">&gt;</span> <span class="fu">as.Date</span>(<span class="st">"2021-01-01"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb119-3"><a href="#cb119-3"></a>    <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">yearmonth</span>(date), <span class="at">y =</span> sales)) <span class="sc">+</span></span>
<span id="cb119-4"><a href="#cb119-4"></a>    <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">5</span>, <span class="at">color =</span> <span class="st">"black"</span>, <span class="at">alpha =</span> <span class="fl">0.5</span>, </span>
<span id="cb119-5"><a href="#cb119-5"></a>               <span class="at">shape =</span> <span class="dv">21</span>, <span class="at">fill =</span> <span class="st">"black"</span>) <span class="sc">+</span></span>
<span id="cb119-6"><a href="#cb119-6"></a>    <span class="fu">geom_line</span>(<span class="at">color =</span> <span class="st">"black"</span>, <span class="at">size =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb119-7"><a href="#cb119-7"></a>    <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">y =</span> pred), <span class="at">size =</span> <span class="dv">5</span>, </span>
<span id="cb119-8"><a href="#cb119-8"></a>               <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">alpha =</span> <span class="fl">0.5</span>, <span class="at">shape =</span> <span class="dv">21</span>, </span>
<span id="cb119-9"><a href="#cb119-9"></a>               <span class="at">fill =</span> <span class="st">"red"</span>, <span class="at">data =</span> error_tbl_all) <span class="sc">+</span></span>
<span id="cb119-10"><a href="#cb119-10"></a><span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> pred), <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">size =</span> <span class="fl">0.5</span>, </span>
<span id="cb119-11"><a href="#cb119-11"></a>          <span class="at">data =</span> error_tbl_all) <span class="sc">+</span></span>
<span id="cb119-12"><a href="#cb119-12"></a><span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="fu">as.numeric</span>(<span class="fu">as.Date</span>(<span class="st">"2021-12-01"</span>)), <span class="at">linetype =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb119-13"><a href="#cb119-13"></a>    <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Date"</span>, <span class="at">y =</span> <span class="st">"Sales"</span>,</span>
<span id="cb119-14"><a href="#cb119-14"></a>    <span class="at">caption =</span> <span class="fu">c</span>(<span class="fu">paste</span>(<span class="st">"MAPE="</span>,</span>
<span id="cb119-15"><a href="#cb119-15"></a>                      ((<span class="fu">round</span>(<span class="fu">mean</span>(<span class="fu">abs</span>(error_tbl_all<span class="sc">$</span>error_pct))<span class="sc">*</span><span class="dv">100</span>, <span class="dv">5</span>)))))) <span class="sc">+</span></span>
<span id="cb119-16"><a href="#cb119-16"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">labels =</span> scales<span class="sc">::</span>dollar)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-fhiaaa" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="index_files/figure-html/fig-fhiaaa-1.png" class="img-fluid figure-img" width="672"></p>
<figcaption class="figure-caption">Figure&nbsp;3.5: Forecast. H2O including all available algorithms.</figcaption>
</figure>
</div>
</div>
</div>
<p>Additional performance metrics.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb120"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb120-1"><a href="#cb120-1"></a><span class="fu">h2o.performance</span>(automl_leader_all, <span class="at">newdata =</span> test_h2o)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>H2ORegressionMetrics: stackedensemble

MSE:  1147521
RMSE:  1071.224
MAE:  894.9356
RMSLE:  0.06912513
Mean Residual Deviance :  1147521</code></pre>
</div>
</div>
<p>In finance we care about the future and these techniques can be used as a tool to reduce the uncertainty about the future. Obviously, we cannot predict without errors, but the objective is to achieve the lowest forecasting errors possible.</p>
</section>
<section id="summary-h2o-models." class="level2" data-number="3.6">
<h2 data-number="3.6" class="anchored" data-anchor-id="summary-h2o-models."><span class="header-section-number">3.6</span> Summary H2O models.</h2>
<p>It is useful to see the performance results for the three different H2O runs above. First, the performance for the overall 10-period forecast.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb122"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb122-1"><a href="#cb122-1"></a><span class="co"># There might be a more compact way to create this table.</span></span>
<span id="cb122-2"><a href="#cb122-2"></a>error_tbl_summ <span class="ot">&lt;-</span> error_tbl <span class="sc">%&gt;%</span></span>
<span id="cb122-3"><a href="#cb122-3"></a>    <span class="fu">summarise</span>(<span class="at">model =</span> automl_leader<span class="sc">@</span>algorithm,</span>
<span id="cb122-4"><a href="#cb122-4"></a>      <span class="at">me =</span> <span class="fu">mean</span>(error), <span class="at">rmse =</span> <span class="fu">mean</span>(error<span class="sc">^</span><span class="dv">2</span>)<span class="sc">^</span><span class="fl">0.5</span>,</span>
<span id="cb122-5"><a href="#cb122-5"></a>              <span class="at">mae  =</span> <span class="fu">mean</span>(<span class="fu">abs</span>(error)), <span class="at">mape =</span> <span class="dv">100</span> <span class="sc">*</span> <span class="fu">mean</span>(<span class="fu">abs</span>(error_pct)),</span>
<span id="cb122-6"><a href="#cb122-6"></a>              <span class="at">mpe  =</span> <span class="dv">100</span> <span class="sc">*</span> <span class="fu">mean</span>(error_pct)) </span>
<span id="cb122-7"><a href="#cb122-7"></a>error_tbl_DL_summ <span class="ot">&lt;-</span> error_tbl_DL <span class="sc">%&gt;%</span></span>
<span id="cb122-8"><a href="#cb122-8"></a>    <span class="fu">summarise</span>(<span class="at">model =</span> automl_DL<span class="sc">@</span>algorithm,</span>
<span id="cb122-9"><a href="#cb122-9"></a>      <span class="at">me =</span> <span class="fu">mean</span>(error), <span class="at">rmse =</span> <span class="fu">mean</span>(error<span class="sc">^</span><span class="dv">2</span>)<span class="sc">^</span><span class="fl">0.5</span>,</span>
<span id="cb122-10"><a href="#cb122-10"></a>              <span class="at">mae =</span> <span class="fu">mean</span>(<span class="fu">abs</span>(error)), <span class="at">mape =</span> <span class="dv">100</span> <span class="sc">*</span> <span class="fu">mean</span>(<span class="fu">abs</span>(error_pct)),</span>
<span id="cb122-11"><a href="#cb122-11"></a>              <span class="at">mpe =</span> <span class="dv">100</span> <span class="sc">*</span> <span class="fu">mean</span>(error_pct))</span>
<span id="cb122-12"><a href="#cb122-12"></a>error_tbl_all_summ <span class="ot">&lt;-</span> error_tbl_all <span class="sc">%&gt;%</span></span>
<span id="cb122-13"><a href="#cb122-13"></a>    <span class="fu">summarise</span>(<span class="at">model =</span> automl_leader_all<span class="sc">@</span>algorithm,</span>
<span id="cb122-14"><a href="#cb122-14"></a>      <span class="at">me =</span> <span class="fu">mean</span>(error), <span class="at">rmse =</span> <span class="fu">mean</span>(error<span class="sc">^</span><span class="dv">2</span>)<span class="sc">^</span><span class="fl">0.5</span>,</span>
<span id="cb122-15"><a href="#cb122-15"></a>              <span class="at">mae  =</span> <span class="fu">mean</span>(<span class="fu">abs</span>(error)), <span class="at">mape =</span> <span class="dv">100</span> <span class="sc">*</span> <span class="fu">mean</span>(<span class="fu">abs</span>(error_pct)),</span>
<span id="cb122-16"><a href="#cb122-16"></a>              <span class="at">mpe  =</span> <span class="dv">100</span> <span class="sc">*</span> <span class="fu">mean</span>(error_pct))</span>
<span id="cb122-17"><a href="#cb122-17"></a>error_automl_summ <span class="ot">&lt;-</span> <span class="fu">rbind</span>(error_tbl_summ, error_tbl_DL_summ,</span>
<span id="cb122-18"><a href="#cb122-18"></a>                                error_tbl_all_summ) <span class="sc">%&gt;%</span></span>
<span id="cb122-19"><a href="#cb122-19"></a>  <span class="fu">as.data.frame</span>()</span>
<span id="cb122-20"><a href="#cb122-20"></a></span>
<span id="cb122-21"><a href="#cb122-21"></a><span class="fu">row.names</span>(error_automl_summ) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Without Deep Learning"</span>, </span>
<span id="cb122-22"><a href="#cb122-22"></a>                                  <span class="st">"Only Deep Learning"</span>, <span class="st">"All algorithms"</span>)</span>
<span id="cb122-23"><a href="#cb122-23"></a></span>
<span id="cb122-24"><a href="#cb122-24"></a><span class="fu">kable</span>(error_automl_summ, </span>
<span id="cb122-25"><a href="#cb122-25"></a><span class="at">caption =</span> <span class="st">"Top ranked models: h2o.automl summary forecasting errors."</span>,</span>
<span id="cb122-26"><a href="#cb122-26"></a><span class="at">digits =</span> <span class="dv">2</span>) <span class="sc">%&gt;%</span></span>
<span id="cb122-27"><a href="#cb122-27"></a><span class="fu">kable_styling</span>(<span class="at">latex_options =</span> <span class="st">"HOLD_position"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="table table-sm table-striped small" data-quarto-postprocess="true">
<caption>Top ranked models: h2o.automl summary forecasting errors.</caption>
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th"></th>
<th style="text-align: left;" data-quarto-table-cell-role="th">model</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">me</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">rmse</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">mae</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">mape</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">mpe</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Without Deep Learning</td>
<td style="text-align: left;">stackedensemble</td>
<td style="text-align: right;">829.43</td>
<td style="text-align: right;">1048.77</td>
<td style="text-align: right;">927.24</td>
<td style="text-align: right;">5.72</td>
<td style="text-align: right;">5.06</td>
</tr>
<tr class="even">
<td style="text-align: left;">Only Deep Learning</td>
<td style="text-align: left;">deeplearning</td>
<td style="text-align: right;">-69.18</td>
<td style="text-align: right;">1028.50</td>
<td style="text-align: right;">784.14</td>
<td style="text-align: right;">4.99</td>
<td style="text-align: right;">-0.40</td>
</tr>
<tr class="odd">
<td style="text-align: left;">All algorithms</td>
<td style="text-align: left;">stackedensemble</td>
<td style="text-align: right;">801.88</td>
<td style="text-align: right;">1071.22</td>
<td style="text-align: right;">894.94</td>
<td style="text-align: right;">5.54</td>
<td style="text-align: right;">4.94</td>
</tr>
</tbody>
</table>


</div>
</div>
<p>As you can see, there are several ways in which we can measure the forecast errors. We can specify which one is the evaluation criterion to rank the models. And we can also determine which error measure: me (mean error), rmse (root mean squared error), mae (mean absolute error), mape (mean absolute percentage error), or mpe (mean percentage error) will be the one to choose between these three alternatives. In my experience, the rmse and the mape are the most popular ones, but the others might be useful in specific circumstances.</p>
<p>We can also show the best point forecast for the three <tt><code>h2o.automl()</code></tt> runs.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb123"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb123-1"><a href="#cb123-1"></a>point_forecast_1 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb123-2"><a href="#cb123-2"></a>  <span class="at">model =</span> automl_leader<span class="sc">@</span>algorithm,</span>
<span id="cb123-3"><a href="#cb123-3"></a>  error_tbl[<span class="fu">which.min</span>(<span class="fu">abs</span>(error_tbl<span class="sc">$</span>error_pct)), <span class="dv">2</span>], </span>
<span id="cb123-4"><a href="#cb123-4"></a>  <span class="at">error =</span> error_tbl[<span class="fu">which.min</span>(<span class="fu">abs</span>(error_tbl<span class="sc">$</span>error_pct)), <span class="dv">6</span>])</span>
<span id="cb123-5"><a href="#cb123-5"></a>point_forecast_2 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb123-6"><a href="#cb123-6"></a>  <span class="at">model =</span> automl_DL<span class="sc">@</span>algorithm,</span>
<span id="cb123-7"><a href="#cb123-7"></a>  error_tbl_DL[<span class="fu">which.min</span>(<span class="fu">abs</span>(error_tbl_DL<span class="sc">$</span>error_pct)), <span class="dv">2</span>],</span>
<span id="cb123-8"><a href="#cb123-8"></a>  <span class="at">error =</span> error_tbl_DL[<span class="fu">which.min</span>(<span class="fu">abs</span>(error_tbl_DL<span class="sc">$</span>error_pct)), <span class="dv">6</span>])</span>
<span id="cb123-9"><a href="#cb123-9"></a>point_forecast_3 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb123-10"><a href="#cb123-10"></a>  <span class="at">model =</span> automl_leader_all<span class="sc">@</span>algorithm,</span>
<span id="cb123-11"><a href="#cb123-11"></a>  error_tbl_all[<span class="fu">which.min</span>(<span class="fu">abs</span>(error_tbl_all<span class="sc">$</span>error_pct)), <span class="dv">2</span>],</span>
<span id="cb123-12"><a href="#cb123-12"></a>  <span class="at">error =</span> error_tbl_all[<span class="fu">which.min</span>(<span class="fu">abs</span>(error_tbl_all<span class="sc">$</span>error_pct)), <span class="dv">6</span>])</span>
<span id="cb123-13"><a href="#cb123-13"></a>point_forecast <span class="ot">&lt;-</span> <span class="fu">rbind.data.frame</span>(point_forecast_1, point_forecast_2,</span>
<span id="cb123-14"><a href="#cb123-14"></a>                                   point_forecast_3)</span>
<span id="cb123-15"><a href="#cb123-15"></a><span class="fu">row.names</span>(point_forecast) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Without Deep Learning"</span>, </span>
<span id="cb123-16"><a href="#cb123-16"></a>                               <span class="st">"Only Deep Learning"</span>, <span class="st">"All algorithms"</span>)</span>
<span id="cb123-17"><a href="#cb123-17"></a><span class="fu">kable</span>(point_forecast, </span>
<span id="cb123-18"><a href="#cb123-18"></a><span class="at">caption =</span> <span class="st">"Top ranked models: Lowest point forecast percentage errors."</span>,</span>
<span id="cb123-19"><a href="#cb123-19"></a><span class="at">digits =</span> <span class="dv">6</span>) <span class="sc">%&gt;%</span></span>
<span id="cb123-20"><a href="#cb123-20"></a><span class="fu">kable_styling</span>(<span class="at">latex_options =</span> <span class="st">"HOLD_position"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="table table-sm table-striped small" data-quarto-postprocess="true">
<caption>Top ranked models: Lowest point forecast percentage errors.</caption>
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th"></th>
<th style="text-align: left;" data-quarto-table-cell-role="th">model</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">date</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">error_pct</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Without Deep Learning</td>
<td style="text-align: left;">stackedensemble</td>
<td style="text-align: left;">2022-01-01</td>
<td style="text-align: right;">-0.005736</td>
</tr>
<tr class="even">
<td style="text-align: left;">Only Deep Learning</td>
<td style="text-align: left;">deeplearning</td>
<td style="text-align: left;">2022-05-01</td>
<td style="text-align: right;">-0.010663</td>
</tr>
<tr class="odd">
<td style="text-align: left;">All algorithms</td>
<td style="text-align: left;">stackedensemble</td>
<td style="text-align: left;">2022-07-01</td>
<td style="text-align: right;">-0.000837</td>
</tr>
</tbody>
</table>


</div>
</div>
<p>We normally do not choose a model according to one specific point forecast. However, it is interesting to see which alternative and which specific date has been forecasted with the highest accuracy.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb124"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb124-1"><a href="#cb124-1"></a>mape_updated_h2o <span class="ot">&lt;-</span> mape_updated <span class="sc">%&gt;%</span></span>
<span id="cb124-2"><a href="#cb124-2"></a>  <span class="fu">add_row</span>(<span class="at">.model =</span> <span class="fu">paste</span>(<span class="st">"H2O no Deep Learning:"</span>, </span>
<span id="cb124-3"><a href="#cb124-3"></a>                         automl_leader<span class="sc">@</span>algorithm), </span>
<span id="cb124-4"><a href="#cb124-4"></a>          <span class="at">MAPE =</span> <span class="fu">mean</span>(<span class="fu">abs</span>(error_tbl<span class="sc">$</span>error_pct))<span class="sc">*</span><span class="dv">100</span>) <span class="sc">%&gt;%</span></span>
<span id="cb124-5"><a href="#cb124-5"></a>  <span class="fu">add_row</span>(<span class="at">.model =</span> <span class="fu">paste</span>(<span class="st">"H2O Deep Learning:"</span>,</span>
<span id="cb124-6"><a href="#cb124-6"></a>                         automl_DL<span class="sc">@</span>algorithm),</span>
<span id="cb124-7"><a href="#cb124-7"></a>          <span class="at">MAPE =</span> <span class="fu">mean</span>(<span class="fu">abs</span>(error_tbl_DL<span class="sc">$</span>error_pct))<span class="sc">*</span><span class="dv">100</span>) <span class="sc">%&gt;%</span></span>
<span id="cb124-8"><a href="#cb124-8"></a>  <span class="fu">add_row</span>(<span class="at">.model =</span> <span class="fu">paste</span>(<span class="st">"H2O all models:"</span>, </span>
<span id="cb124-9"><a href="#cb124-9"></a>                         automl_leader_all<span class="sc">@</span>algorithm),</span>
<span id="cb124-10"><a href="#cb124-10"></a>                         <span class="at">MAPE =</span> <span class="fu">mean</span>(<span class="fu">abs</span>(error_tbl_all<span class="sc">$</span>error_pct))<span class="sc">*</span><span class="dv">100</span>) <span class="sc">%&gt;%</span></span>
<span id="cb124-11"><a href="#cb124-11"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(<span class="sc">-</span>MAPE))</span>
<span id="cb124-12"><a href="#cb124-12"></a>mape_updated_h2o</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 10 × 2
   .model                                 MAPE
   &lt;chr&gt;                                 &lt;dbl&gt;
 1 fpp3: seasonal naïve                   3.82
 2 fpp3: ETS(M,A,M)                       3.95
 3 fpp3: ARIMA(4,1,1)(0,1,1)[12]          4.58
 4 H2O Deep Learning: deeplearning        4.99
 5 H2O all models: stackedensemble        5.54
 6 H2O no Deep Learning: stackedensemble  5.72
 7 fpp3: NNAR(15,1,8)[12]                 6.46
 8 fpp3: naïve                           18.4 
 9 fpp3: drift                           21.2 
10 fpp3: mean                            23.4 </code></pre>
</div>
</div>
</section>
</section>
<section id="two-more-forecast-models." class="level1" data-number="4">
<h1 data-number="4"><span class="header-section-number">4</span> Two more forecast models.</h1>
<p>As in the original Matt Dancho’s example, we include the linear regression and a different ARIMA package to conduct two more forecasts using the <tt><code>auto.arima()</code></tt> function.</p>
<section id="linear-regression." class="level2" data-number="4.1">
<h2 data-number="4.1" class="anchored" data-anchor-id="linear-regression."><span class="header-section-number">4.1</span> Linear regression.</h2>
<p>Let’s implement a simple approach using the <tt><code>lm()</code></tt> function.</p>
</section>
<section id="estimation." class="level2" data-number="4.2">
<h2 data-number="4.2" class="anchored" data-anchor-id="estimation."><span class="header-section-number">4.2</span> Estimation.</h2>
<p>This is the simplest choice, and still has a very high adjusted <span class="math inline">\(R^2\)</span>. The independent variables are all <tt><code>beer_aug</code></tt> variables except for <tt><code>date</code></tt>, <tt><code>diff</code></tt>, and <tt><code>symbol</code></tt>.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb126"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb126-1"><a href="#cb126-1"></a>fit_lm <span class="ot">&lt;-</span> <span class="fu">lm</span>(sales <span class="sc">~</span> ., <span class="at">data =</span> </span>
<span id="cb126-2"><a href="#cb126-2"></a>               <span class="fu">select</span>(beer_aug, <span class="sc">-</span><span class="fu">c</span>(date, diff, symbol)))</span>
<span id="cb126-3"><a href="#cb126-3"></a><span class="fu">summary</span>(fit_lm)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = sales ~ ., data = select(beer_aug, -c(date, diff, 
    symbol)))

Residuals:
     Min       1Q   Median       3Q      Max 
-1242.00  -365.68   -29.16   348.23  1311.62 

Coefficients: (16 not defined because of singularities)
               Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)   3.027e+08  1.843e+08   1.642  0.10307    
index.num     4.885e-03  2.965e-03   1.648  0.10190    
year         -1.247e+05  9.604e+04  -1.299  0.19645    
year.iso     -2.891e+04  8.753e+03  -3.303  0.00124 ** 
half         -2.598e+03  1.035e+03  -2.509  0.01335 *  
quarter      -2.774e+04  3.762e+04  -0.737  0.46226    
month         4.468e+03  1.254e+04   0.356  0.72226    
month.xts            NA         NA      NA       NA    
month.lbl.L          NA         NA      NA       NA    
month.lbl.Q  -1.893e+03  3.180e+02  -5.953 2.41e-08 ***
month.lbl.C   6.371e+02  8.850e+02   0.720  0.47296    
month.lbl^4   9.437e+02  2.310e+02   4.085 7.77e-05 ***
month.lbl^5   5.241e+02  7.241e+02   0.724  0.47054    
month.lbl^6  -1.313e+02  2.772e+02  -0.474  0.63658    
month.lbl^7  -9.769e+01  3.250e+02  -0.301  0.76419    
month.lbl^8   5.080e+02  5.614e+02   0.905  0.36720    
month.lbl^9          NA         NA      NA       NA    
month.lbl^10  7.215e+02  3.847e+02   1.875  0.06305 .  
month.lbl^11         NA         NA      NA       NA    
day                  NA         NA      NA       NA    
hour                 NA         NA      NA       NA    
minute               NA         NA      NA       NA    
second               NA         NA      NA       NA    
hour12               NA         NA      NA       NA    
am.pm                NA         NA      NA       NA    
wday         -1.007e+02  3.502e+01  -2.874  0.00475 ** 
wday.xts             NA         NA      NA       NA    
wday.lbl.L           NA         NA      NA       NA    
wday.lbl.Q   -1.126e+03  1.707e+02  -6.599 1.01e-09 ***
wday.lbl.C    4.051e+02  1.480e+02   2.737  0.00710 ** 
wday.lbl^4   -3.844e+01  1.750e+02  -0.220  0.82647    
wday.lbl^5    1.453e+02  1.535e+02   0.947  0.34553    
wday.lbl^6    9.055e+01  1.386e+02   0.653  0.51465    
mday                 NA         NA      NA       NA    
qday         -3.059e+02  4.154e+02  -0.736  0.46283    
yday         -1.217e+02  1.978e+02  -0.615  0.53941    
mweek         1.713e+01  2.383e+02   0.072  0.94280    
week         -2.987e+02  3.173e+02  -0.941  0.34839    
week.iso     -5.418e+02  1.686e+02  -3.213  0.00166 ** 
week2         4.890e+02  2.722e+02   1.797  0.07478 .  
week3                NA         NA      NA       NA    
week4                NA         NA      NA       NA    
mday7                NA         NA      NA       NA    
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 581.6 on 127 degrees of freedom
Multiple R-squared:  0.9542,    Adjusted R-squared:  0.9449 
F-statistic: 101.9 on 26 and 127 DF,  p-value: &lt; 2.2e-16</code></pre>
</div>
</div>
<p>At first sight, the model looks promising.</p>
</section>
<section id="predict." class="level2" data-number="4.3">
<h2 data-number="4.3" class="anchored" data-anchor-id="predict."><span class="header-section-number">4.3</span> Predict.</h2>
<p>Prediction is easy in R.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb128"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb128-1"><a href="#cb128-1"></a>pred <span class="ot">&lt;-</span> <span class="fu">predict</span>(fit_lm, <span class="at">newdata =</span> test_tbl)</span>
<span id="cb128-2"><a href="#cb128-2"></a>future_idx <span class="ot">&lt;-</span> <span class="fu">tail</span>(beer<span class="sc">$</span>date, <span class="dv">10</span>) <span class="co"># The 10-months forecast period.</span></span>
<span id="cb128-3"><a href="#cb128-3"></a>predictions_tbl <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">date  =</span> future_idx, <span class="at">value =</span> pred)</span>
<span id="cb128-4"><a href="#cb128-4"></a>predictions_tbl</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 10 × 2
   date        value
   &lt;date&gt;      &lt;dbl&gt;
 1 2022-01-01 12278.
 2 2022-02-01 13709.
 3 2022-03-01 15546.
 4 2022-04-01 14750.
 5 2022-05-01 15792.
 6 2022-06-01 17205.
 7 2022-07-01 14896.
 8 2022-08-01 16238.
 9 2022-09-01 15673.
10 2022-10-01 15374.</code></pre>
</div>
</div>
<p>We can investigate the error on our test set (actuals vs predictions).</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb130"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb130-1"><a href="#cb130-1"></a><span class="co"># Investigate test error</span></span>
<span id="cb130-2"><a href="#cb130-2"></a>actuals_tbl <span class="ot">&lt;-</span> <span class="fu">tail</span>(beer[<span class="sc">-</span><span class="dv">1</span>], <span class="dv">10</span>)</span>
<span id="cb130-3"><a href="#cb130-3"></a>error_tbl_lm <span class="ot">&lt;-</span> <span class="fu">left_join</span>(actuals_tbl, predictions_tbl) <span class="sc">%&gt;%</span></span>
<span id="cb130-4"><a href="#cb130-4"></a>    <span class="fu">rename</span>(<span class="at">actual =</span> sales, <span class="at">pred =</span> value) <span class="sc">%&gt;%</span></span>
<span id="cb130-5"><a href="#cb130-5"></a>    <span class="fu">mutate</span>(<span class="at">error =</span> actual <span class="sc">-</span> pred, <span class="at">error_pct =</span> error <span class="sc">/</span> actual) </span>
<span id="cb130-6"><a href="#cb130-6"></a>error_tbl_lm</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 10 × 5
   date       actual   pred error error_pct
   &lt;date&gt;      &lt;int&gt;  &lt;dbl&gt; &lt;dbl&gt;     &lt;dbl&gt;
 1 2022-01-01  11862 12278. -416.  -0.0351 
 2 2022-02-01  13358 13709. -351.  -0.0263 
 3 2022-03-01  16216 15546.  670.   0.0413 
 4 2022-04-01  15766 14750. 1016.   0.0645 
 5 2022-05-01  16755 15792.  963.   0.0574 
 6 2022-06-01  17882 17205.  677.   0.0379 
 7 2022-07-01  15168 14896.  272.   0.0179 
 8 2022-08-01  16977 16238.  739.   0.0435 
 9 2022-09-01  16430 15673.  757.   0.0460 
10 2022-10-01  15480 15374.  106.   0.00682</code></pre>
</div>
</div>
<p>And we can calculate a few residuals metrics. A more complex algorithm could produce more accurate results.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb132"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb132-1"><a href="#cb132-1"></a><span class="co"># Calculating test error metrics</span></span>
<span id="cb132-2"><a href="#cb132-2"></a>test_residuals_lm <span class="ot">&lt;-</span> error_tbl_lm<span class="sc">$</span>error</span>
<span id="cb132-3"><a href="#cb132-3"></a>test_error_pct_lm <span class="ot">&lt;-</span> error_tbl_lm<span class="sc">$</span>error_pct <span class="sc">*</span> <span class="dv">100</span> <span class="co"># Percentage error.</span></span>
<span id="cb132-4"><a href="#cb132-4"></a>me   <span class="ot">&lt;-</span> <span class="fu">mean</span>(test_residuals_lm, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb132-5"><a href="#cb132-5"></a>rmse <span class="ot">&lt;-</span> <span class="fu">mean</span>(test_residuals_lm<span class="sc">^</span><span class="dv">2</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)<span class="sc">^</span><span class="fl">0.5</span></span>
<span id="cb132-6"><a href="#cb132-6"></a>mae  <span class="ot">&lt;-</span> <span class="fu">mean</span>(<span class="fu">abs</span>(test_residuals_lm), <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb132-7"><a href="#cb132-7"></a>mape <span class="ot">&lt;-</span> <span class="fu">mean</span>(<span class="fu">abs</span>(test_error_pct_lm), <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb132-8"><a href="#cb132-8"></a>mpe  <span class="ot">&lt;-</span> <span class="fu">mean</span>(test_error_pct_lm, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb132-9"><a href="#cb132-9"></a><span class="fu">tibble</span>(me, rmse, mae, mape, mpe) <span class="sc">%&gt;%</span> </span>
<span id="cb132-10"><a href="#cb132-10"></a>  <span class="fu">glimpse</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 1
Columns: 5
$ me   &lt;dbl&gt; 443.1396
$ rmse &lt;dbl&gt; 660.7198
$ mae  &lt;dbl&gt; 596.5493
$ mape &lt;dbl&gt; 3.767322
$ mpe  &lt;dbl&gt; 2.540329</code></pre>
</div>
</div>
<p>Visualize our forecast.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb134"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb134-1"><a href="#cb134-1"></a>beer <span class="sc">%&gt;%</span></span>
<span id="cb134-2"><a href="#cb134-2"></a>  <span class="fu">filter</span>(date <span class="sc">&gt;</span> <span class="fu">as.Date</span>(<span class="st">"2021-01-01"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb134-3"><a href="#cb134-3"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">yearmonth</span>(date), <span class="at">y =</span> sales)) <span class="sc">+</span></span>
<span id="cb134-4"><a href="#cb134-4"></a>  <span class="fu">geom_line</span>(<span class="at">color =</span> <span class="st">"black"</span>, <span class="at">size =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb134-5"><a href="#cb134-5"></a>  <span class="fu">geom_point</span>(<span class="at">color =</span> <span class="st">"black"</span>, <span class="at">size =</span> <span class="dv">5</span>, <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb134-6"><a href="#cb134-6"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> value), <span class="at">size =</span> <span class="fl">0.5</span>,</span>
<span id="cb134-7"><a href="#cb134-7"></a>            <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">data =</span> predictions_tbl) <span class="sc">+</span></span>
<span id="cb134-8"><a href="#cb134-8"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">y =</span> value), <span class="at">size =</span> <span class="dv">5</span>, <span class="at">alpha =</span> <span class="fl">0.5</span>,</span>
<span id="cb134-9"><a href="#cb134-9"></a>             <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">data =</span> predictions_tbl) <span class="sc">+</span></span>
<span id="cb134-10"><a href="#cb134-10"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="fu">as.numeric</span>(<span class="fu">as.Date</span>(<span class="st">"2021-12-01"</span>)), <span class="at">linetype =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb134-11"><a href="#cb134-11"></a>  <span class="fu">theme_tq</span>() <span class="sc">+</span></span>
<span id="cb134-12"><a href="#cb134-12"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Date"</span>, <span class="at">y =</span> <span class="st">"Sales"</span>,</span>
<span id="cb134-13"><a href="#cb134-13"></a>       <span class="at">caption =</span> <span class="fu">c</span>(<span class="fu">paste</span>(<span class="st">"MAPE="</span>,((<span class="fu">round</span>(<span class="fu">mean</span>(<span class="fu">abs</span>(test_error_pct_lm)), <span class="dv">5</span>)))))) <span class="sc">+</span></span>
<span id="cb134-14"><a href="#cb134-14"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">labels =</span> scales<span class="sc">::</span>dollar)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-fmlr" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="index_files/figure-html/fig-fmlr-1.png" class="img-fluid figure-img" width="672"></p>
<figcaption class="figure-caption">Figure&nbsp;4.1: Forecast. Multivariate linear regression.</figcaption>
</figure>
</div>
</div>
</div>
<p>This is clearly a good alternative.</p>
</section>
<section id="arima.-1" class="level2" data-number="4.4">
<h2 data-number="4.4" class="anchored" data-anchor-id="arima.-1"><span class="header-section-number">4.4</span> ARIMA.</h2>
<p>Here, <tt><code>sweep</code></tt> is used for tidying the <tt><code>forecast</code></tt> package workflow. We’ll work through an ARIMA analysis to forecast the next 10 months of time series data. In this way we can compare our previous results.</p>
</section>
<section id="prepare-the-data." class="level2" data-number="4.5">
<h2 data-number="4.5" class="anchored" data-anchor-id="prepare-the-data."><span class="header-section-number">4.5</span> Prepare the data.</h2>
<p>The <tt><code>tk_ts()</code></tt> function coerce time series objects and tibbles with date/date-time columns to <tt><code>ts</code></tt> (time-series).</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb135"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb135-1"><a href="#cb135-1"></a><span class="co"># Convert from tbl to ts.</span></span>
<span id="cb135-2"><a href="#cb135-2"></a>beer_sales_ts <span class="ot">&lt;-</span> <span class="fu">tk_ts</span>(beer[<span class="dv">1</span><span class="sc">:</span><span class="dv">144</span>,], <span class="at">start =</span> <span class="dv">2010</span>, <span class="at">freq =</span> <span class="dv">12</span>)</span>
<span id="cb135-3"><a href="#cb135-3"></a>beer_sales_ts</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>       Jan   Feb   Mar   Apr   May   Jun   Jul   Aug   Sep   Oct   Nov   Dec
2010  6558  7481  9475  9424  9351 10552  9077  9273  9420  9413  9866 11455
2011  6901  8014  9832  9281  9967 11344  9106 10469 10085  9612 10328 11483
2012  7486  8641  9709  9423 11342 11274  9845 11163  9532 10754 10953 11922
2013  8383  8870 10085 10462 12177 11342 11139 11409 10442 11479 11077 12636
2014  8506  9003  9991 10903 11709 11815 10875 10884 10725 11697 10353 13153
2015  8279  8926 10557 10933 11330 12708 11700 11079 11882 11865 11420 14100
2016  8556 10199 11949 11253 12046 13453 10755 12465 12038 11674 12761 14137
2017  8870 10251 12241 11266 13275 14428 11165 13098 11619 12386 12904 13859
2018  9248 10056 12221 11474 13650 14067 12178 13714 11954 13450 13706 15086
2019 10391 10776 12238 12879 14358 14076 13290 13990 12849 14318 13584 16076
2020 10524 11206 13308 12167 13925 16032 15598 15217 15449 16139 14911 16309
2021 11360 12380 15354 15617 15527 17832 15751 16185 15944 15687 16909 18211</code></pre>
</div>
</div>
<p>Just verify <tt><code>tk_ts()</code></tt> function worked.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb137"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb137-1"><a href="#cb137-1"></a><span class="co"># Check that ts-object has a timetk index.</span></span>
<span id="cb137-2"><a href="#cb137-2"></a><span class="fu">has_timetk_idx</span>(beer_sales_ts)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] TRUE</code></pre>
</div>
</div>
<p>Great. This will be important when we use <tt><code>sw_sweep</code></tt>. Next, we’ll model using ARIMA.</p>
</section>
<section id="estimation.-1" class="level2" data-number="4.6">
<h2 data-number="4.6" class="anchored" data-anchor-id="estimation.-1"><span class="header-section-number">4.6</span> Estimation.</h2>
<p>We can use the <tt><code>auto.arima()</code></tt> function from the <tt><code>forecast</code></tt> package to model the time series. By doing that, we do not have to impose a specific ARIMA model, the function can test the best specification for us.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb139"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb139-1"><a href="#cb139-1"></a><span class="co"># Model using auto.arima.</span></span>
<span id="cb139-2"><a href="#cb139-2"></a><span class="fu">set.seed</span>(<span class="dv">13</span>)</span>
<span id="cb139-3"><a href="#cb139-3"></a>fit_arima <span class="ot">&lt;-</span> <span class="fu">auto.arima</span>(beer_sales_ts)</span>
<span id="cb139-4"><a href="#cb139-4"></a>fit_arima</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Series: beer_sales_ts 
ARIMA(1,1,2)(2,1,1)[12] 

Coefficients:
          ar1     ma1      ma2    sar1     sar2     sma1
      -0.7375  0.1076  -0.7204  0.4034  -0.3456  -0.8370
s.e.   0.0956  0.0868   0.0708  0.1114   0.1054   0.1371

sigma^2 = 293391:  log likelihood = -1016.19
AIC=2046.39   AICc=2047.3   BIC=2066.52</code></pre>
</div>
</div>
<p>The results are somewhat different to the ARIMA <tt><code>fpp3</code></tt> alternative. The <tt><code>sw_tidy()</code></tt> function returns the model coefficients in a tibble (tidy data frame). This might be useful in some circumstances.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb141"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb141-1"><a href="#cb141-1"></a><span class="co"># sw_tidy - Get model coefficients.</span></span>
<span id="cb141-2"><a href="#cb141-2"></a><span class="fu">sw_tidy</span>(fit_arima)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 2
  term  estimate
  &lt;chr&gt;    &lt;dbl&gt;
1 ar1     -0.737
2 ma1      0.108
3 ma2     -0.720
4 sar1     0.403
5 sar2    -0.346
6 sma1    -0.837</code></pre>
</div>
</div>
<p>The <tt><code>sw_glance()</code></tt> function returns the training set accuracy measures in a <tt><code>tibble</code></tt>. We use <code>&lt;/tt&gt;glimpse()</code> function to aid in quickly reviewing the model metrics.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb143"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb143-1"><a href="#cb143-1"></a><span class="co"># sw_glance - Get model description and training set accuracy measures.</span></span>
<span id="cb143-2"><a href="#cb143-2"></a><span class="fu">sw_glance</span>(fit_arima) <span class="sc">%&gt;%</span></span>
<span id="cb143-3"><a href="#cb143-3"></a>    <span class="fu">glimpse</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 1
Columns: 12
$ model.desc &lt;chr&gt; "ARIMA(1,1,2)(2,1,1)[12]"
$ sigma      &lt;dbl&gt; 541.6555
$ logLik     &lt;dbl&gt; -1016.195
$ AIC        &lt;dbl&gt; 2046.39
$ BIC        &lt;dbl&gt; 2066.516
$ ME         &lt;dbl&gt; 45.00804
$ RMSE       &lt;dbl&gt; 504.6577
$ MAE        &lt;dbl&gt; 374.0378
$ MPE        &lt;dbl&gt; 0.1117028
$ MAPE       &lt;dbl&gt; 3.065638
$ MASE       &lt;dbl&gt; 0.542787
$ ACF1       &lt;dbl&gt; -0.03583636</code></pre>
</div>
</div>
<p>This looks good.</p>
</section>
<section id="predict.-1" class="level2" data-number="4.7">
<h2 data-number="4.7" class="anchored" data-anchor-id="predict.-1"><span class="header-section-number">4.7</span> Predict.</h2>
<p>The <tt><code>sw_augument()</code></tt> function helps with model evaluation. We get the “.actual”, “.fitted” and “.resid” columns, which are useful in evaluating the model against the training data. Note that we can pass <tt><code>timetk_idx = TRUE</code></tt> to return the original date index.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb145"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb145-1"><a href="#cb145-1"></a><span class="co"># sw_augment - get model residuals</span></span>
<span id="cb145-2"><a href="#cb145-2"></a><span class="fu">sw_augment</span>(fit_arima, <span class="at">timetk_idx =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 144 × 4
   index      .actual .fitted .resid
   &lt;date&gt;       &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt;
 1 2010-01-01    6558   6554.  3.79 
 2 2010-02-01    7481   7479.  2.41 
 3 2010-03-01    9475   9472.  3.26 
 4 2010-04-01    9424   9422.  2.39 
 5 2010-05-01    9351   9349.  1.84 
 6 2010-06-01   10552  10549.  2.63 
 7 2010-07-01    9077   9076.  0.882
 8 2010-08-01    9273   9272.  0.956
 9 2010-09-01    9420   9419.  0.988
10 2010-10-01    9413   9412.  0.882
# ℹ 134 more rows</code></pre>
</div>
</div>
<p>We can visualize the residual diagnostics for the training data to make sure there is no pattern leftover. This looks homoscedastic.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb147"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb147-1"><a href="#cb147-1"></a><span class="fu">sw_augment</span>(fit_arima, <span class="at">timetk_idx =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb147-2"><a href="#cb147-2"></a>    <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> index, <span class="at">y =</span> .resid)) <span class="sc">+</span></span>
<span id="cb147-3"><a href="#cb147-3"></a>    <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">lwd =</span> <span class="dv">2</span>) <span class="sc">+</span> </span>
<span id="cb147-4"><a href="#cb147-4"></a>    <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">5</span>, <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span> </span>
<span id="cb147-5"><a href="#cb147-5"></a>    <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Date"</span>, <span class="at">y =</span> <span class="st">"Residuals"</span>) <span class="sc">+</span></span>
<span id="cb147-6"><a href="#cb147-6"></a>    <span class="fu">scale_x_date</span>(<span class="at">date_breaks =</span> <span class="st">"1 year"</span>, <span class="at">date_labels =</span> <span class="st">"%Y"</span>) <span class="sc">+</span></span>
<span id="cb147-7"><a href="#cb147-7"></a>    <span class="fu">theme_tq</span>() <span class="sc">+</span></span>
<span id="cb147-8"><a href="#cb147-8"></a>    <span class="fu">scale_y_continuous</span>(<span class="at">labels =</span> scales<span class="sc">::</span>dollar)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-fard" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="index_files/figure-html/fig-fard-1.png" class="img-fluid figure-img" width="672"></p>
<figcaption class="figure-caption">Figure&nbsp;4.2: Forecast. ARIMA(1,1,2)(2,1,1)[12] residual diagnosis.</figcaption>
</figure>
</div>
</div>
</div>
<p>Make a forecast using the <tt><code>forecast()</code></tt> function. This function also delivers some convenient error bounds.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb148"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb148-1"><a href="#cb148-1"></a><span class="co"># Forecast next 10 months</span></span>
<span id="cb148-2"><a href="#cb148-2"></a>fcast_arima <span class="ot">&lt;-</span> <span class="fu">forecast</span>(fit_arima, <span class="at">h =</span> <span class="dv">10</span>)</span>
<span id="cb148-3"><a href="#cb148-3"></a>fcast_arima</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>         Point Forecast    Lo 80    Hi 80    Lo 95    Hi 95
Jan 2022       13013.79 12317.30 13710.28 11948.60 14078.98
Feb 2022       13997.19 13254.62 14739.76 12861.53 15132.85
Mar 2022       16301.80 15555.01 17048.59 15159.69 17443.92
Apr 2022       16672.97 15897.00 17448.94 15486.22 17859.72
May 2022       17079.34 16295.06 17863.63 15879.88 18278.81
Jun 2022       18189.21 17383.30 18995.12 16956.68 19421.75
Jul 2022       15989.63 15172.88 16806.38 14740.52 17238.75
Aug 2022       16973.97 16139.38 17808.56 15697.57 18250.37
Sep 2022       16197.20 15350.48 17043.92 14902.26 17492.14
Oct 2022       16394.12 15531.64 17256.61 15075.06 17713.19</code></pre>
</div>
</div>
<p>One problem is the forecast output is not <em>tidy</em>. We need it in a data frame if we want to work with it using the tidyverse functionality. The class is <em>forecast</em>, which is a ts-based-object.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb150"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb150-1"><a href="#cb150-1"></a><span class="fu">class</span>(fcast_arima)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "forecast"</code></pre>
</div>
</div>
<p>We can use <tt><code>sw_sweep()</code></tt> to tidy the forecast output. As an added benefit, if the forecast-object has a <tt><code>timetk</code></tt> index, we can use it to return a date/datetime index as opposed to regular index from the ts-based-object.</p>
<p>First, let’s check if the forecast-object has a <em>timetk</em> index.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb152"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb152-1"><a href="#cb152-1"></a><span class="co"># Check if object has timetk index </span></span>
<span id="cb152-2"><a href="#cb152-2"></a><span class="fu">has_timetk_idx</span>(fcast_arima)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] TRUE</code></pre>
</div>
</div>
<p>Great. Now, use <tt><code>sw_sweep()</code></tt> to tidy the forecast output.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb154"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb154-1"><a href="#cb154-1"></a>fcast_tbl <span class="ot">&lt;-</span> <span class="fu">sw_sweep</span>(fcast_arima, <span class="at">timetk_idx =</span> <span class="cn">TRUE</span>)</span>
<span id="cb154-2"><a href="#cb154-2"></a><span class="fu">tail</span>(fcast_tbl, <span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 10 × 7
   index      key       sales  lo.80  lo.95  hi.80  hi.95
   &lt;date&gt;     &lt;chr&gt;     &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;
 1 2022-01-01 forecast 13014. 12317. 11949. 13710. 14079.
 2 2022-02-01 forecast 13997. 13255. 12862. 14740. 15133.
 3 2022-03-01 forecast 16302. 15555. 15160. 17049. 17444.
 4 2022-04-01 forecast 16673. 15897. 15486. 17449. 17860.
 5 2022-05-01 forecast 17079. 16295. 15880. 17864. 18279.
 6 2022-06-01 forecast 18189. 17383. 16957. 18995. 19422.
 7 2022-07-01 forecast 15990. 15173. 14741. 16806. 17239.
 8 2022-08-01 forecast 16974. 16139. 15698. 17809. 18250.
 9 2022-09-01 forecast 16197. 15350. 14902. 17044. 17492.
10 2022-10-01 forecast 16394. 15532. 15075. 17257. 17713.</code></pre>
</div>
</div>
<p>We can investigate the error on our test set (actuals vs predictions).</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb156"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb156-1"><a href="#cb156-1"></a><span class="co"># Investigate test error </span></span>
<span id="cb156-2"><a href="#cb156-2"></a>error_tbl_arima <span class="ot">&lt;-</span> <span class="fu">left_join</span>(actuals_tbl, fcast_tbl, </span>
<span id="cb156-3"><a href="#cb156-3"></a>                             <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"date"</span> <span class="ot">=</span> <span class="st">"index"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb156-4"><a href="#cb156-4"></a>    <span class="fu">rename</span>(<span class="at">actual =</span> sales.x, <span class="at">pred =</span> sales.y) <span class="sc">%&gt;%</span></span>
<span id="cb156-5"><a href="#cb156-5"></a>    <span class="fu">select</span>(date, actual, pred) <span class="sc">%&gt;%</span></span>
<span id="cb156-6"><a href="#cb156-6"></a>    <span class="fu">mutate</span>(<span class="at">error =</span> <span class="fu">round</span>((actual <span class="sc">-</span> pred), <span class="dv">2</span>), </span>
<span id="cb156-7"><a href="#cb156-7"></a>           <span class="at">error_pct =</span> <span class="fu">round</span>((error <span class="sc">/</span> actual), <span class="dv">4</span>)) </span>
<span id="cb156-8"><a href="#cb156-8"></a>error_tbl_arima</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 10 × 5
   date       actual   pred    error error_pct
   &lt;date&gt;      &lt;int&gt;  &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt;
 1 2022-01-01  11862 13014. -1152.     -0.0971
 2 2022-02-01  13358 13997.  -639.     -0.0479
 3 2022-03-01  16216 16302.   -85.8    -0.0053
 4 2022-04-01  15766 16673.  -907.     -0.0575
 5 2022-05-01  16755 17079.  -324.     -0.0194
 6 2022-06-01  17882 18189.  -307.     -0.0172
 7 2022-07-01  15168 15990.  -822.     -0.0542
 8 2022-08-01  16977 16974.     3.03    0.0002
 9 2022-09-01  16430 16197.   233.      0.0142
10 2022-10-01  15480 16394.  -914.     -0.0591</code></pre>
</div>
</div>
<p>And we can calculate a few residuals metrics.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb158"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb158-1"><a href="#cb158-1"></a><span class="co"># Calculate test error metrics</span></span>
<span id="cb158-2"><a href="#cb158-2"></a>test_residuals_arima <span class="ot">&lt;-</span> error_tbl_arima<span class="sc">$</span>error</span>
<span id="cb158-3"><a href="#cb158-3"></a>test_error_pct_arima <span class="ot">&lt;-</span> error_tbl_arima<span class="sc">$</span>error_pct <span class="sc">*</span> <span class="dv">100</span> <span class="co"># Percentage error</span></span>
<span id="cb158-4"><a href="#cb158-4"></a>me   <span class="ot">&lt;-</span> <span class="fu">mean</span>(test_residuals_arima, <span class="at">na.rm=</span><span class="cn">TRUE</span>)</span>
<span id="cb158-5"><a href="#cb158-5"></a>rmse <span class="ot">&lt;-</span> <span class="fu">mean</span>(test_residuals_arima<span class="sc">^</span><span class="dv">2</span>, <span class="at">na.rm=</span><span class="cn">TRUE</span>)<span class="sc">^</span><span class="fl">0.5</span></span>
<span id="cb158-6"><a href="#cb158-6"></a>mae  <span class="ot">&lt;-</span> <span class="fu">mean</span>(<span class="fu">abs</span>(test_residuals_arima), <span class="at">na.rm=</span><span class="cn">TRUE</span>)</span>
<span id="cb158-7"><a href="#cb158-7"></a>mape <span class="ot">&lt;-</span> <span class="fu">mean</span>(<span class="fu">abs</span>(test_error_pct_arima), <span class="at">na.rm=</span><span class="cn">TRUE</span>)</span>
<span id="cb158-8"><a href="#cb158-8"></a>mpe  <span class="ot">&lt;-</span> <span class="fu">mean</span>(test_error_pct_arima, <span class="at">na.rm=</span><span class="cn">TRUE</span>)</span>
<span id="cb158-9"><a href="#cb158-9"></a><span class="fu">tibble</span>(me, rmse, mae, mape, mpe) <span class="sc">%&gt;%</span> </span>
<span id="cb158-10"><a href="#cb158-10"></a>  <span class="fu">glimpse</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 1
Columns: 5
$ me   &lt;dbl&gt; -491.522
$ rmse &lt;dbl&gt; 657.9978
$ mae  &lt;dbl&gt; 538.688
$ mape &lt;dbl&gt; 3.721
$ mpe  &lt;dbl&gt; -3.433</code></pre>
</div>
</div>
<p>Notice that we have the entire forecast in a <tt><code>tibble</code></tt>. We can now more easily visualize the forecast.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb160"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb160-1"><a href="#cb160-1"></a>fcast_tbl <span class="sc">%&gt;%</span></span>
<span id="cb160-2"><a href="#cb160-2"></a>  <span class="fu">filter</span>(index <span class="sc">&gt;</span> <span class="fu">as.Date</span>(<span class="st">"2021-01-01"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb160-3"><a href="#cb160-3"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> index, <span class="at">y =</span> sales, <span class="at">color =</span> key)) <span class="sc">+</span></span>
<span id="cb160-4"><a href="#cb160-4"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> lo<span class="fl">.95</span>, <span class="at">ymax =</span> hi<span class="fl">.95</span>), </span>
<span id="cb160-5"><a href="#cb160-5"></a>              <span class="at">fill =</span> <span class="st">"#D5DBFF"</span>, <span class="at">color =</span> <span class="cn">NA</span>, <span class="at">size =</span> <span class="dv">0</span>) <span class="sc">+</span></span>
<span id="cb160-6"><a href="#cb160-6"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> lo<span class="fl">.80</span>, <span class="at">ymax =</span> hi<span class="fl">.80</span>, <span class="at">fill =</span> key), </span>
<span id="cb160-7"><a href="#cb160-7"></a>              <span class="at">fill =</span> <span class="st">"#596DD5"</span>, <span class="at">color =</span> <span class="cn">NA</span>, <span class="at">size =</span> <span class="dv">0</span>, <span class="at">alpha =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb160-8"><a href="#cb160-8"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb160-9"><a href="#cb160-9"></a>  <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">5</span>, <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb160-10"><a href="#cb160-10"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">y =</span> sales), <span class="at">color =</span> <span class="st">"black"</span>, </span>
<span id="cb160-11"><a href="#cb160-11"></a>            <span class="at">data =</span> actuals_tbl) <span class="sc">+</span></span>
<span id="cb160-12"><a href="#cb160-12"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">y =</span> sales), <span class="at">color =</span> <span class="st">"black"</span>, <span class="at">size =</span> <span class="dv">5</span>,</span>
<span id="cb160-13"><a href="#cb160-13"></a>             <span class="at">alpha =</span> <span class="fl">0.5</span>, <span class="at">data =</span> actuals_tbl) <span class="sc">+</span></span>
<span id="cb160-14"><a href="#cb160-14"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="fu">as.numeric</span>(<span class="fu">as.Date</span>(<span class="st">"2021-12-01"</span>)), </span>
<span id="cb160-15"><a href="#cb160-15"></a>             <span class="at">linetype =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb160-16"><a href="#cb160-16"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Date"</span>, <span class="at">y =</span> <span class="st">"Sales"</span>,</span>
<span id="cb160-17"><a href="#cb160-17"></a>       <span class="at">caption =</span> <span class="fu">c</span>(<span class="fu">paste</span>(<span class="st">"MAPE="</span>,((<span class="fu">mean</span>(<span class="fu">abs</span>(test_error_pct_arima))))))) <span class="sc">+</span></span>
<span id="cb160-18"><a href="#cb160-18"></a>  <span class="fu">scale_x_date</span>(<span class="at">date_breaks =</span> <span class="st">"1 year"</span>, <span class="at">date_labels =</span> <span class="st">"%Y"</span>) <span class="sc">+</span></span>
<span id="cb160-19"><a href="#cb160-19"></a>  <span class="fu">scale_color_tq</span>() <span class="sc">+</span></span>
<span id="cb160-20"><a href="#cb160-20"></a>  <span class="fu">scale_fill_tq</span>() <span class="sc">+</span></span>
<span id="cb160-21"><a href="#cb160-21"></a>  <span class="fu">theme_tq</span>() <span class="sc">+</span></span>
<span id="cb160-22"><a href="#cb160-22"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">labels =</span> scales<span class="sc">::</span>dollar)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-fa" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="index_files/figure-html/fig-fa-1.png" class="img-fluid figure-img" width="672"></p>
<figcaption class="figure-caption">Figure&nbsp;4.3: Forecast. ARIMA(1,1,2)(2,1,1)[12].</figcaption>
</figure>
</div>
</div>
</div>
<p>This is a decent forecast.</p>
</section>
</section>
<section id="summary-of-all-results." class="level1" data-number="5">
<h1 data-number="5"><span class="header-section-number">5</span> Summary of all results.</h1>
<p>An interesting question is: <em>What happens to the accuracy when you average the predictions of all different methods?</em> This question makes sense because the decision of using one technique or another is not trivial. Taking the average could be useful to avoid extreme results but at the same time it could be hard to interpret as the forecast comes from different techniques. In any case, it is interesting to see how it works.</p>
<p>In order to calculate the average forecast we need to load the forecasts from the previous section. In particular, we include the seasonal naïve, NNAR(15,1,8)[12], ETS(M,A,M) and ARIMA(4,1,1)(0,1,1)[12]. We did not include the naïve, drift and mean.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb161"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb161-1"><a href="#cb161-1"></a><span class="co"># This comes from ffpp3.rmd</span></span>
<span id="cb161-2"><a href="#cb161-2"></a>fpp3_fc <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">"fpp3_fc.rds"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>We need to add our H2O forecast into <tt><code>fpp3_fc</code></tt>.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb162"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb162-1"><a href="#cb162-1"></a><span class="co"># Transform h2o object to a simple data frame.</span></span>
<span id="cb162-2"><a href="#cb162-2"></a>pred_h2o_x <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(pred_h2o)</span>
<span id="cb162-3"><a href="#cb162-3"></a>pred_h2o_DL_x <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(pred_h2o_DL)</span>
<span id="cb162-4"><a href="#cb162-4"></a>pred_h2o_all_x <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(pred_h2o_all)</span>
<span id="cb162-5"><a href="#cb162-5"></a><span class="co"># Transform the data frame to a tsibble.</span></span>
<span id="cb162-6"><a href="#cb162-6"></a>pred_h2o_fc <span class="ot">&lt;-</span> <span class="fu">tsibble</span>(</span>
<span id="cb162-7"><a href="#cb162-7"></a>  <span class="at">.model =</span> <span class="fu">rep</span>(<span class="st">"pred_h2o"</span>, <span class="dv">10</span>),</span>
<span id="cb162-8"><a href="#cb162-8"></a>  <span class="at">date =</span> <span class="fu">yearmonth</span>(<span class="fu">c</span>(<span class="st">"2022-01"</span>, <span class="st">"2022-02"</span>, <span class="st">"2022-03"</span>, <span class="st">"2022-04"</span>,</span>
<span id="cb162-9"><a href="#cb162-9"></a>           <span class="st">"2022-05"</span>, <span class="st">"2022-06"</span>, <span class="st">"2022-07"</span>, <span class="st">"2022-08"</span>,</span>
<span id="cb162-10"><a href="#cb162-10"></a>           <span class="st">"2022-09"</span>, <span class="st">"2022-10"</span>)),</span>
<span id="cb162-11"><a href="#cb162-11"></a>  <span class="at">.mean =</span> pred_h2o_x<span class="sc">$</span>predict,</span>
<span id="cb162-12"><a href="#cb162-12"></a>  <span class="at">index =</span> date)</span>
<span id="cb162-13"><a href="#cb162-13"></a>pred_h2o_DL_fc <span class="ot">&lt;-</span> <span class="fu">tsibble</span>(</span>
<span id="cb162-14"><a href="#cb162-14"></a>  <span class="at">.model =</span> <span class="fu">rep</span>(<span class="st">"pred_h2o_DL"</span>, <span class="dv">10</span>),</span>
<span id="cb162-15"><a href="#cb162-15"></a>  <span class="at">date =</span> <span class="fu">yearmonth</span>(<span class="fu">c</span>(<span class="st">"2022-01"</span>, <span class="st">"2022-02"</span>, <span class="st">"2022-03"</span>, <span class="st">"2022-04"</span>,</span>
<span id="cb162-16"><a href="#cb162-16"></a>           <span class="st">"2022-05"</span>, <span class="st">"2022-06"</span>, <span class="st">"2022-07"</span>, <span class="st">"2022-08"</span>,</span>
<span id="cb162-17"><a href="#cb162-17"></a>           <span class="st">"2022-09"</span>, <span class="st">"2022-10"</span>)),</span>
<span id="cb162-18"><a href="#cb162-18"></a>  <span class="at">.mean =</span> pred_h2o_DL_x<span class="sc">$</span>predict,</span>
<span id="cb162-19"><a href="#cb162-19"></a>  <span class="at">index =</span> date)</span>
<span id="cb162-20"><a href="#cb162-20"></a>pred_h2o_all_fc <span class="ot">&lt;-</span> <span class="fu">tsibble</span>(</span>
<span id="cb162-21"><a href="#cb162-21"></a>  <span class="at">.model =</span> <span class="fu">rep</span>(<span class="st">"pred_h2o_all"</span>, <span class="dv">10</span>),</span>
<span id="cb162-22"><a href="#cb162-22"></a>  <span class="at">date =</span> <span class="fu">yearmonth</span>(<span class="fu">c</span>(<span class="st">"2022-01"</span>, <span class="st">"2022-02"</span>, <span class="st">"2022-03"</span>, <span class="st">"2022-04"</span>,</span>
<span id="cb162-23"><a href="#cb162-23"></a>           <span class="st">"2022-05"</span>, <span class="st">"2022-06"</span>, <span class="st">"2022-07"</span>, <span class="st">"2022-08"</span>,</span>
<span id="cb162-24"><a href="#cb162-24"></a>           <span class="st">"2022-09"</span>, <span class="st">"2022-10"</span>)),</span>
<span id="cb162-25"><a href="#cb162-25"></a>  <span class="at">.mean =</span> pred_h2o_all_x<span class="sc">$</span>predict,</span>
<span id="cb162-26"><a href="#cb162-26"></a>  <span class="at">index =</span> date)</span>
<span id="cb162-27"><a href="#cb162-27"></a><span class="co"># Similar transformation for lm and arima.</span></span>
<span id="cb162-28"><a href="#cb162-28"></a>predictions_tbl<span class="sc">$</span>date <span class="ot">&lt;-</span> <span class="fu">yearmonth</span>(predictions_tbl<span class="sc">$</span>date)</span>
<span id="cb162-29"><a href="#cb162-29"></a></span>
<span id="cb162-30"><a href="#cb162-30"></a>pred_lm_fc <span class="ot">&lt;-</span> predictions_tbl <span class="sc">%&gt;%</span></span>
<span id="cb162-31"><a href="#cb162-31"></a>  <span class="fu">rename</span>(<span class="at">.mean =</span> value) <span class="sc">%&gt;%</span></span>
<span id="cb162-32"><a href="#cb162-32"></a>  <span class="fu">mutate</span>(<span class="at">.model =</span> <span class="fu">rep</span>(<span class="st">"lm"</span>, <span class="dv">10</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb162-33"><a href="#cb162-33"></a>  <span class="fu">relocate</span>(.model)</span>
<span id="cb162-34"><a href="#cb162-34"></a>  </span>
<span id="cb162-35"><a href="#cb162-35"></a>error_tbl_arima<span class="sc">$</span>date <span class="ot">&lt;-</span> <span class="fu">yearmonth</span>(error_tbl_arima<span class="sc">$</span>date)</span>
<span id="cb162-36"><a href="#cb162-36"></a></span>
<span id="cb162-37"><a href="#cb162-37"></a>pred_arima2_fc <span class="ot">&lt;-</span> error_tbl_arima <span class="sc">%&gt;%</span></span>
<span id="cb162-38"><a href="#cb162-38"></a>  <span class="fu">select</span>(date, pred) <span class="sc">%&gt;%</span></span>
<span id="cb162-39"><a href="#cb162-39"></a>  <span class="fu">rename</span>(<span class="at">.mean =</span> pred) <span class="sc">%&gt;%</span></span>
<span id="cb162-40"><a href="#cb162-40"></a>  <span class="fu">mutate</span>(<span class="at">.model =</span> <span class="fu">rep</span>(<span class="st">"arima2"</span>, <span class="dv">10</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb162-41"><a href="#cb162-41"></a>  <span class="fu">relocate</span>(.model)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Now gather all together, calculate the average forecast, and performance measures.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb163"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb163-1"><a href="#cb163-1"></a><span class="co"># Gather all.</span></span>
<span id="cb163-2"><a href="#cb163-2"></a>all_fc <span class="ot">&lt;-</span> <span class="fu">as_tsibble</span>(fpp3_fc) <span class="sc">%&gt;%</span></span>
<span id="cb163-3"><a href="#cb163-3"></a>  <span class="fu">select</span>(.model, date, .mean) <span class="sc">%&gt;%</span></span>
<span id="cb163-4"><a href="#cb163-4"></a>  <span class="fu">bind_rows</span>(pred_h2o_fc, pred_h2o_DL_fc, pred_h2o_all_fc,</span>
<span id="cb163-5"><a href="#cb163-5"></a>            pred_lm_fc, pred_arima2_fc)</span>
<span id="cb163-6"><a href="#cb163-6"></a><span class="co"># We need this to calculate mape.</span></span>
<span id="cb163-7"><a href="#cb163-7"></a>average <span class="ot">&lt;-</span> all_fc <span class="sc">%&gt;%</span></span>
<span id="cb163-8"><a href="#cb163-8"></a>  <span class="fu">index_by</span>(date) <span class="sc">%&gt;%</span></span>
<span id="cb163-9"><a href="#cb163-9"></a>  <span class="fu">summarise</span>(<span class="at">av_fc =</span> <span class="fu">mean</span>(.mean)) <span class="sc">%&gt;%</span> <span class="co"># This is the average forecast.</span></span>
<span id="cb163-10"><a href="#cb163-10"></a>  <span class="fu">bind_cols</span>(<span class="at">sales =</span> actuals_tbl<span class="sc">$</span>sales) <span class="sc">%&gt;%</span></span>
<span id="cb163-11"><a href="#cb163-11"></a>    <span class="fu">mutate</span>(<span class="at">error =</span> <span class="fu">round</span>((sales <span class="sc">-</span> av_fc), <span class="dv">2</span>), </span>
<span id="cb163-12"><a href="#cb163-12"></a>           <span class="at">error_pct =</span> <span class="fu">round</span>((error <span class="sc">/</span> sales), <span class="dv">4</span>)) </span>
<span id="cb163-13"><a href="#cb163-13"></a>average</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tsibble: 10 x 5 [1M]
        date  av_fc sales  error error_pct
       &lt;mth&gt;  &lt;dbl&gt; &lt;int&gt;  &lt;dbl&gt;     &lt;dbl&gt;
 1 2022 ene. 12338. 11862 -476.    -0.0401
 2 2022 feb. 13487. 13358 -129.    -0.0097
 3 2022 mar. 15595. 16216  621.     0.0383
 4 2022 abr. 15084. 15766  682.     0.0433
 5 2022 may. 16470. 16755  285.     0.017 
 6 2022 jun. 17666. 17882  216      0.0121
 7 2022 jul. 15761. 15168 -593.    -0.0391
 8 2022 ago. 16891. 16977   86.4    0.0051
 9 2022 sep. 16208. 16430  222.     0.0135
10 2022 oct. 16473. 15480 -993.    -0.0642</code></pre>
</div>
</div>
<p>Finally, the forecast.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb165"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb165-1"><a href="#cb165-1"></a>beer <span class="sc">%&gt;%</span></span>
<span id="cb165-2"><a href="#cb165-2"></a>  <span class="fu">filter</span>(date <span class="sc">&gt;</span> <span class="fu">as.Date</span>(<span class="st">"2021-01-01"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb165-3"><a href="#cb165-3"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">yearmonth</span>(date), <span class="at">y =</span> sales)) <span class="sc">+</span></span>
<span id="cb165-4"><a href="#cb165-4"></a>  <span class="fu">geom_line</span>(<span class="at">color =</span> <span class="st">"black"</span>, <span class="at">size =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb165-5"><a href="#cb165-5"></a>  <span class="fu">geom_point</span>(<span class="at">color =</span> <span class="st">"black"</span>, <span class="at">size =</span> <span class="dv">5</span>, <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb165-6"><a href="#cb165-6"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> av_fc), <span class="at">size =</span> <span class="fl">0.5</span>,</span>
<span id="cb165-7"><a href="#cb165-7"></a>            <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">data =</span> average) <span class="sc">+</span></span>
<span id="cb165-8"><a href="#cb165-8"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">y =</span> av_fc), <span class="at">size =</span> <span class="dv">5</span>, <span class="at">alpha =</span> <span class="fl">0.5</span>,</span>
<span id="cb165-9"><a href="#cb165-9"></a>             <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">data =</span> average) <span class="sc">+</span></span>
<span id="cb165-10"><a href="#cb165-10"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="fu">as.numeric</span>(<span class="fu">as.Date</span>(<span class="st">"2021-12-01"</span>)), <span class="at">linetype =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb165-11"><a href="#cb165-11"></a>  <span class="fu">theme_tq</span>() <span class="sc">+</span></span>
<span id="cb165-12"><a href="#cb165-12"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Date"</span>, <span class="at">y =</span> <span class="st">"Sales"</span>,</span>
<span id="cb165-13"><a href="#cb165-13"></a>       <span class="at">caption =</span> <span class="fu">c</span>(<span class="fu">paste</span>(<span class="st">"MAPE="</span>,</span>
<span id="cb165-14"><a href="#cb165-14"></a>                         ((<span class="fu">round</span>(<span class="dv">100</span><span class="sc">*</span><span class="fu">mean</span>(<span class="fu">abs</span>(average<span class="sc">$</span>error_pct)), <span class="dv">5</span>)))))) <span class="sc">+</span></span>
<span id="cb165-15"><a href="#cb165-15"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">labels =</span> scales<span class="sc">::</span>dollar)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-fav" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="index_files/figure-html/fig-fav-1.png" class="img-fluid figure-img" width="672"></p>
<figcaption class="figure-caption">Figure&nbsp;5.1: Forecast. Average.</figcaption>
</figure>
</div>
</div>
</div>
<p>Let’s update our MAPE summary table.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb166"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb166-1"><a href="#cb166-1"></a>mape_updated_all <span class="ot">&lt;-</span> mape_updated_h2o <span class="sc">%&gt;%</span></span>
<span id="cb166-2"><a href="#cb166-2"></a>  <span class="fu">add_row</span>(<span class="at">.model =</span> <span class="st">"Linear model"</span>, </span>
<span id="cb166-3"><a href="#cb166-3"></a>          <span class="at">MAPE =</span> <span class="fu">mean</span>(<span class="fu">abs</span>(test_error_pct_lm))) <span class="sc">%&gt;%</span></span>
<span id="cb166-4"><a href="#cb166-4"></a>  <span class="fu">add_row</span>(<span class="at">.model =</span> <span class="st">"ARIMA(1,1,2)(2,1,1)[12]"</span>, </span>
<span id="cb166-5"><a href="#cb166-5"></a>          <span class="at">MAPE =</span> <span class="fu">mean</span>(<span class="fu">abs</span>(test_error_pct_arima))) <span class="sc">%&gt;%</span></span>
<span id="cb166-6"><a href="#cb166-6"></a>  <span class="fu">add_row</span>(<span class="at">.model =</span> <span class="st">"Average forecast"</span>, </span>
<span id="cb166-7"><a href="#cb166-7"></a>          <span class="at">MAPE =</span> <span class="dv">100</span><span class="sc">*</span><span class="fu">mean</span>(<span class="fu">abs</span>(average<span class="sc">$</span>error_pct))) <span class="sc">%&gt;%</span></span>
<span id="cb166-8"><a href="#cb166-8"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(<span class="sc">-</span>MAPE))</span>
<span id="cb166-9"><a href="#cb166-9"></a>mape_updated_all</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 13 × 2
   .model                                 MAPE
   &lt;chr&gt;                                 &lt;dbl&gt;
 1 Average forecast                       2.82
 2 ARIMA(1,1,2)(2,1,1)[12]                3.72
 3 Linear model                           3.77
 4 fpp3: seasonal naïve                   3.82
 5 fpp3: ETS(M,A,M)                       3.95
 6 fpp3: ARIMA(4,1,1)(0,1,1)[12]          4.58
 7 H2O Deep Learning: deeplearning        4.99
 8 H2O all models: stackedensemble        5.54
 9 H2O no Deep Learning: stackedensemble  5.72
10 fpp3: NNAR(15,1,8)[12]                 6.46
11 fpp3: naïve                           18.4 
12 fpp3: drift                           21.2 
13 fpp3: mean                            23.4 </code></pre>
</div>
</div>
<p>Nice.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb168"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb168-1"><a href="#cb168-1"></a><span class="fu">h2o.shutdown</span>(<span class="at">prompt =</span> <span class="cn">TRUE</span>) <span class="co"># yes (Y) instead of TRUE?</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Are you sure you want to shutdown the H2O instance running at http://localhost:54321/ (Y/N)? </code></pre>
</div>
</div>
<section id="unsorted-references." class="level2" data-number="5.1">
<h2 data-number="5.1" class="anchored" data-anchor-id="unsorted-references."><span class="header-section-number">5.1</span> Unsorted references.</h2>
<p>The main web references of this document are (these are web links):</p>
<ul>
<li><a href="https://www.r-bloggers.com/demo-week-time-series-machine-learning-with-h2o-and-timetk/">Time Series Machine Learning with h2o and timetk.</a></li>
<li><a href="https://www.business-science.io/code-tools/2017/10/24/demo_week_timetk.html">Time Series Machine Learning with timetk.</a></li>
<li><a href="https://www.business-science.io/code-tools/2017/10/25/demo_week_sweep.html">Tidy Forecasting with sweep</a></li>
<li><a href="http://docs.h2o.ai/h2o-tutorials/latest-stable/index.html">H2O Tutorials</a></li>
</ul>
<p>rm(list=ls())</p>
</section>
</section>
<section id="robotrader-in-fa-brands-python" class="level1" data-number="6">
<h1 data-number="6"><span class="header-section-number">6</span> Robotrader in <i class="fa-brands fa-python" aria-label="python"></i></h1>
<p>Stock price movements are influenced by a myriad of factors, including market trends, economic indicators, and company-specific news. While predicting precise movements remains a challenging task, statistical analysis, machine learning algorithms, and technical indicators enable traders to identify patterns and trends that offer insights into potential price changes. By leveraging historical data and employing sophisticated algorithms, trading bots can analyze vast amounts of information in real-time, identifying patterns and correlations that humans might overlook. While not foolproof, these algorithms can exploit market inefficiencies and capitalize on short-term trends, aiming to generate daily returns by executing timely and automated trades based on the anticipated movements in stock prices. However, it’s important to note that markets are inherently dynamic, and past performance does not guarantee future results, requiring continuous refinement and adaptation of trading strategies to changing market conditions.</p>
<p>Here we introduce a Python code for a simple robo trader, this program utilizes moving averages as a fundamental tool to anticipate stock price movements. The algorithm involves calculating moving averages to generates a buy, sell or keep signal. This basic yet effective strategy aims to capitalize on trends and momentum in stock prices. The code is designed to fetch real-time stock data, compute moving averages, and trigger buy or sell orders accordingly. Traders can customize the parameters and incorporate additional indicators for a more sophisticated trading strategy. It serves as a practical example of how Python can be employed to implement algorithmic trading strategies for those looking to automate their trading decisions based on moving average signals.</p>
<p>Install if necessary.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb170"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb170-1"><a href="#cb170-1"></a><span class="co"># !pip install yfinance</span></span>
<span id="cb170-2"><a href="#cb170-2"></a><span class="co"># !pip install matplotlib</span></span>
<span id="cb170-3"><a href="#cb170-3"></a><span class="co"># !pip install seaborn</span></span>
<span id="cb170-4"><a href="#cb170-4"></a><span class="co"># !pip install c</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Set up the packages.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb171"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb171-1"><a href="#cb171-1"></a><span class="im">import</span> yfinance <span class="im">as</span> yf</span>
<span id="cb171-2"><a href="#cb171-2"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb171-3"><a href="#cb171-3"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb171-4"><a href="#cb171-4"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb171-5"><a href="#cb171-5"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb171-6"><a href="#cb171-6"></a></span>
<span id="cb171-7"><a href="#cb171-7"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> confusion_matrix</span>
<span id="cb171-8"><a href="#cb171-8"></a><span class="im">from</span> sklearn.model_selection <span class="im">import</span> train_test_split</span>
<span id="cb171-9"><a href="#cb171-9"></a><span class="im">from</span> sklearn.ensemble <span class="im">import</span> RandomForestClassifier</span>
<span id="cb171-10"><a href="#cb171-10"></a><span class="im">from</span> sklearn.neighbors <span class="im">import</span> KNeighborsClassifier</span>
<span id="cb171-11"><a href="#cb171-11"></a><span class="im">from</span> sklearn.tree <span class="im">import</span> DecisionTreeClassifier </span>
<span id="cb171-12"><a href="#cb171-12"></a><span class="im">from</span> sklearn.neural_network <span class="im">import</span> MLPClassifier </span>
<span id="cb171-13"><a href="#cb171-13"></a><span class="im">from</span> sklearn.ensemble <span class="im">import</span> AdaBoostClassifier</span>
<span id="cb171-14"><a href="#cb171-14"></a><span class="im">from</span> sklearn.impute <span class="im">import</span> SimpleImputer</span>
<span id="cb171-15"><a href="#cb171-15"></a><span class="im">from</span> sklearn.pipeline <span class="im">import</span> Pipeline</span>
<span id="cb171-16"><a href="#cb171-16"></a><span class="im">from</span> sklearn.svm <span class="im">import</span> SVC</span>
<span id="cb171-17"><a href="#cb171-17"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> accuracy_score</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<section id="download-the-data." class="level2" data-number="6.1">
<h2 data-number="6.1" class="anchored" data-anchor-id="download-the-data."><span class="header-section-number">6.1</span> Download the data.</h2>
<p>This period includes training and test set.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb172"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb172-1"><a href="#cb172-1"></a>ticker <span class="op">=</span> <span class="st">'AAPL'</span></span>
<span id="cb172-2"><a href="#cb172-2"></a>start_date <span class="op">=</span> <span class="st">"2021-01-01"</span></span>
<span id="cb172-3"><a href="#cb172-3"></a>end_date <span class="op">=</span> <span class="st">"2023-01-06"</span></span>
<span id="cb172-4"><a href="#cb172-4"></a>data <span class="op">=</span> yf.download(ticker, start <span class="op">=</span> start_date, </span>
<span id="cb172-5"><a href="#cb172-5"></a>                   end <span class="op">=</span> end_date, progress <span class="op">=</span> <span class="va">False</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Take a look of the data.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb173"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb173-1"><a href="#cb173-1"></a>data</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>                  Open        High  ...   Adj Close     Volume
Date                                ...                       
2021-01-04  133.520004  133.610001  ...  127.164185  143301900
2021-01-05  128.889999  131.740005  ...  128.736374   97664900
2021-01-06  127.720001  131.050003  ...  124.402916  155088000
2021-01-07  128.360001  131.630005  ...  128.647964  109578200
2021-01-08  132.429993  132.630005  ...  129.758331  105158200
...                ...         ...  ...         ...        ...
2022-12-29  127.989998  130.479996  ...  128.889572   75703700
2022-12-30  128.410004  129.949997  ...  129.207794   77034200
2023-01-03  130.279999  130.899994  ...  124.374802  112117500
2023-01-04  126.889999  128.660004  ...  125.657639   89113600
2023-01-05  127.129997  127.769997  ...  124.325081   80962700

[506 rows x 6 columns]</code></pre>
</div>
</div>
</section>
<section id="visualize-the-data." class="level2" data-number="6.2">
<h2 data-number="6.2" class="anchored" data-anchor-id="visualize-the-data."><span class="header-section-number">6.2</span> Visualize the data.</h2>
<p>The red line splits the training and test data.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb175"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb175-1"><a href="#cb175-1"></a>plt.figure(figsize <span class="op">=</span> (<span class="dv">10</span>, <span class="dv">6</span>))</span>
<span id="cb175-2"><a href="#cb175-2"></a>plt.plot(data.index, data[<span class="st">"Close"</span>])</span>
<span id="cb175-3"><a href="#cb175-3"></a>plt.axvline(x <span class="op">=</span> pd.to_datetime(<span class="st">'2022-08-17'</span>), color <span class="op">=</span> <span class="st">'r'</span>, linestyle <span class="op">=</span> <span class="st">'--'</span>)</span>
<span id="cb175-4"><a href="#cb175-4"></a>plt.text(pd.to_datetime(<span class="st">'2021-11-01'</span>), <span class="dv">120</span>, </span>
<span id="cb175-5"><a href="#cb175-5"></a>         <span class="st">'Looks hard to make returns.'</span>, </span>
<span id="cb175-6"><a href="#cb175-6"></a>         fontsize <span class="op">=</span> <span class="dv">12</span>, color <span class="op">=</span> <span class="st">'black'</span>)</span>
<span id="cb175-7"><a href="#cb175-7"></a>plt.title(<span class="st">"Close Price"</span>)</span>
<span id="cb175-8"><a href="#cb175-8"></a>plt.xlabel(<span class="st">"Date"</span>)</span>
<span id="cb175-9"><a href="#cb175-9"></a>plt.ylabel(<span class="st">"Price"</span>)</span>
<span id="cb175-10"><a href="#cb175-10"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-227-1.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
</div>
<p>These are the correspondent daily returns.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb176"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb176-1"><a href="#cb176-1"></a>data[<span class="st">"Return"</span>] <span class="op">=</span> data[<span class="st">"Close"</span>].pct_change()  </span>
<span id="cb176-2"><a href="#cb176-2"></a>data.dropna(inplace <span class="op">=</span> <span class="va">True</span>)</span>
<span id="cb176-3"><a href="#cb176-3"></a></span>
<span id="cb176-4"><a href="#cb176-4"></a>data[<span class="st">"Return"</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Date
2021-01-05    0.012364
2021-01-06   -0.033662
2021-01-07    0.034123
2021-01-08    0.008631
2021-01-11   -0.023249
                ...   
2022-12-29    0.028324
2022-12-30    0.002469
2023-01-03   -0.037405
2023-01-04    0.010314
2023-01-05   -0.010605
Name: Return, Length: 505, dtype: float64</code></pre>
</div>
</div>
<p>A density plot:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb178"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb178-1"><a href="#cb178-1"></a>plt.figure(figsize <span class="op">=</span> (<span class="dv">10</span>, <span class="dv">6</span>))</span>
<span id="cb178-2"><a href="#cb178-2"></a>sns.kdeplot(data[<span class="st">'Return'</span>], fill <span class="op">=</span> <span class="va">True</span>)</span>
<span id="cb178-3"><a href="#cb178-3"></a>plt.title(<span class="st">'Density Plot of Return'</span>)</span>
<span id="cb178-4"><a href="#cb178-4"></a>plt.xlabel(<span class="st">'Return'</span>)</span>
<span id="cb178-5"><a href="#cb178-5"></a>plt.ylabel(<span class="st">'Density'</span>)</span>
<span id="cb178-6"><a href="#cb178-6"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-229-3.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
</div>
<p>Compared with a normal distribution:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb179"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb179-1"><a href="#cb179-1"></a>mean_return <span class="op">=</span> np.mean(data[<span class="st">'Return'</span>])</span>
<span id="cb179-2"><a href="#cb179-2"></a>var_return <span class="op">=</span> np.var(data[<span class="st">'Return'</span>])</span>
<span id="cb179-3"><a href="#cb179-3"></a>samples <span class="op">=</span> np.random.normal(mean_return, np.sqrt(var_return), <span class="dv">100000</span>)</span>
<span id="cb179-4"><a href="#cb179-4"></a></span>
<span id="cb179-5"><a href="#cb179-5"></a>sns.kdeplot(data[<span class="st">'Return'</span>], fill <span class="op">=</span> <span class="va">True</span>, label <span class="op">=</span> <span class="st">'Return'</span>, color <span class="op">=</span> <span class="st">"r"</span>)</span>
<span id="cb179-6"><a href="#cb179-6"></a>sns.kdeplot(samples, fill <span class="op">=</span> <span class="va">True</span>, label <span class="op">=</span> <span class="st">'Normal Distribution'</span>, </span>
<span id="cb179-7"><a href="#cb179-7"></a>            color <span class="op">=</span> <span class="st">"g"</span>)</span>
<span id="cb179-8"><a href="#cb179-8"></a>plt.title(<span class="st">'Density Plot of Return and Normal Distribution'</span>)</span>
<span id="cb179-9"><a href="#cb179-9"></a>plt.xlabel(<span class="st">'Return'</span>)</span>
<span id="cb179-10"><a href="#cb179-10"></a>plt.ylabel(<span class="st">'Density'</span>)</span>
<span id="cb179-11"><a href="#cb179-11"></a>plt.legend()</span>
<span id="cb179-12"><a href="#cb179-12"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-230-5.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Positive and negative daily returns in test and training set.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb180"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb180-1"><a href="#cb180-1"></a>plt.figure(figsize <span class="op">=</span> (<span class="dv">10</span>, <span class="dv">6</span>))</span>
<span id="cb180-2"><a href="#cb180-2"></a>plt.bar(data.index, data[<span class="st">'Return'</span>], </span>
<span id="cb180-3"><a href="#cb180-3"></a>        color<span class="op">=</span>[<span class="st">'blue'</span> <span class="cf">if</span> x <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="st">'red'</span> <span class="cf">for</span> x <span class="kw">in</span> data[<span class="st">'Return'</span>]])</span>
<span id="cb180-4"><a href="#cb180-4"></a>plt.axvline(x<span class="op">=</span>pd.to_datetime(<span class="st">'2022-08-17'</span>), color <span class="op">=</span> <span class="st">'g'</span>, linestyle <span class="op">=</span> <span class="st">'--'</span>)</span>
<span id="cb180-5"><a href="#cb180-5"></a>plt.title(<span class="st">'Daily Returns'</span>)</span>
<span id="cb180-6"><a href="#cb180-6"></a>plt.xlabel(<span class="st">'Date'</span>)</span>
<span id="cb180-7"><a href="#cb180-7"></a>plt.ylabel(<span class="st">'Return'</span>)</span>
<span id="cb180-8"><a href="#cb180-8"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-231-7.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
</div>
<p>Isolate the test set daily returns.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb181"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb181-1"><a href="#cb181-1"></a>testReturns <span class="op">=</span> data[<span class="st">"Return"</span>].loc[pd.to_datetime(<span class="st">'2022-08-17'</span>):]</span>
<span id="cb181-2"><a href="#cb181-2"></a>testReturns</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Date
2022-08-17    0.008785
2022-08-18   -0.002292
2022-08-19   -0.015102
2022-08-22   -0.023029
2022-08-23   -0.002029
                ...   
2022-12-29    0.028324
2022-12-30    0.002469
2023-01-03   -0.037405
2023-01-04    0.010314
2023-01-05   -0.010605
Name: Return, Length: 98, dtype: float64</code></pre>
</div>
</div>
<p>Let’s ignore any forecast attempt, take these daily returns as given and calculate cumulative returns assuming we reinvest $1 in the test set.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb183"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb183-1"><a href="#cb183-1"></a>cumulative_returns <span class="op">=</span> (<span class="dv">1</span><span class="op">+</span>testReturns).cumprod()</span>
<span id="cb183-2"><a href="#cb183-2"></a>cumulative_returns</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Date
2022-08-17    1.008785
2022-08-18    1.006473
2022-08-19    0.991273
2022-08-22    0.968445
2022-08-23    0.966480
                ...   
2022-12-29    0.749061
2022-12-30    0.750910
2023-01-03    0.722823
2023-01-04    0.730278
2023-01-05    0.722534
Name: Return, Length: 98, dtype: float64</code></pre>
</div>
</div>
<p>Graphically:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb185"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb185-1"><a href="#cb185-1"></a>cumulative_returns.plot(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">6</span>))</span>
<span id="cb185-2"><a href="#cb185-2"></a>plt.title(<span class="st">'Cumulative Returns'</span>)</span>
<span id="cb185-3"><a href="#cb185-3"></a>plt.xlabel(<span class="st">'Date'</span>)</span>
<span id="cb185-4"><a href="#cb185-4"></a>plt.ylabel(<span class="st">'Cumulative Returns'</span>)</span>
<span id="cb185-5"><a href="#cb185-5"></a>plt.text(pd.to_datetime(<span class="st">'2022-11-01'</span>), <span class="fl">0.74</span>, </span>
<span id="cb185-6"><a href="#cb185-6"></a>         <span class="st">'It is hard to make returns.'</span>, </span>
<span id="cb185-7"><a href="#cb185-7"></a>         fontsize <span class="op">=</span> <span class="dv">12</span>, color <span class="op">=</span> <span class="st">'black'</span>)</span>
<span id="cb185-8"><a href="#cb185-8"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-234-9.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="simple-moving-averages." class="level2" data-number="6.3">
<h2 data-number="6.3" class="anchored" data-anchor-id="simple-moving-averages."><span class="header-section-number">6.3</span> Simple moving averages.</h2>
<p>As technical analysis suggests, simple moving averages can be used as a tool to anticipate stock prices movements.</p>
<!-- ```{python} -->
<!-- # Create a dataframe with Date, Close, and Return -->
<!-- new_df = data[['Close', 'Return']] -->
<!-- new_df -->
<!-- ``` -->
<!-- ```{python} -->
<!-- positive_returns = new_df[new_df['Return'] > 0] -->
<!-- negative_returns = new_df[new_df['Return'] < 0] -->
<!-- plt.figure(figsize = (10, 6)) -->
<!-- plt.scatter(positive_returns.index, positive_returns['Close'],  -->
<!--             color = 'blue', label = 'Positive Return', alpha = 0.5) -->
<!-- plt.scatter(negative_returns.index, negative_returns['Close'],  -->
<!--             color = 'red', label = 'Negative Return', alpha = 0.5) -->
<!-- plt.axvline(x = pd.to_datetime('2022-08-17'), color = 'g', linestyle = '--') -->
<!-- plt.title('Close Price with Positive and Negative Returns') -->
<!-- plt.xlabel('Date') -->
<!-- plt.ylabel('Price') -->
<!-- plt.legend() -->
<!-- plt.show() -->
<!-- ``` -->
<!-- ```{python} -->
<!-- # Filter data for positive and negative returns -->
<!-- positive_returns_10 = positive_returns.head(10) -->
<!-- negative_returns_10 = negative_returns.head(10) -->
<!-- # Plotting the Close -->
<!-- plt.figure(figsize = (10, 6)) -->
<!-- plt.scatter(positive_returns_10.index, positive_returns_10['Close'],  -->
<!--             color = 'blue', label = 'Positive Return', s = 150) -->
<!-- plt.scatter(negative_returns_10.index, negative_returns_10['Close'],  -->
<!--             color = 'red', label = 'Negative Return', s = 150) -->
<!-- plt.title('Close Price with Positive and Negative Returns (First 20 Observations)') -->
<!-- plt.xlabel('Date') -->
<!-- plt.ylabel('Price') -->
<!-- plt.legend() -->
<!-- plt.show() -->
<!-- ``` -->
<p>Calculate 5, 10, 15 and 20 days moving averages.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb186"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb186-1"><a href="#cb186-1"></a>data[<span class="st">"SMA_5"</span>] <span class="op">=</span> data[<span class="st">"Close"</span>].rolling(window <span class="op">=</span> <span class="dv">5</span>).mean()</span>
<span id="cb186-2"><a href="#cb186-2"></a>data[<span class="st">"SMA_10"</span>] <span class="op">=</span> data[<span class="st">"Close"</span>].rolling(window <span class="op">=</span> <span class="dv">10</span>).mean()</span>
<span id="cb186-3"><a href="#cb186-3"></a>data[<span class="st">"SMA_15"</span>] <span class="op">=</span> data[<span class="st">"Close"</span>].rolling(window <span class="op">=</span> <span class="dv">15</span>).mean()</span>
<span id="cb186-4"><a href="#cb186-4"></a>data[<span class="st">"SMA_20"</span>] <span class="op">=</span> data[<span class="st">"Close"</span>].rolling(window <span class="op">=</span> <span class="dv">20</span>).mean()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>The first four observations are lost when compunting a 5-day simple moving average.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb187"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb187-1"><a href="#cb187-1"></a>dataframe <span class="op">=</span> data[[<span class="st">'Close'</span>, <span class="st">'SMA_5'</span>]]</span>
<span id="cb187-2"><a href="#cb187-2"></a>dataframe.head(<span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>                 Close       SMA_5
Date                              
2021-01-05  131.009995         NaN
2021-01-06  126.599998         NaN
2021-01-07  130.919998         NaN
2021-01-08  132.050003         NaN
2021-01-11  128.979996  129.911998
2021-01-12  128.800003  129.470000
2021-01-13  130.889999  130.328000
2021-01-14  128.910004  129.926001
2021-01-15  127.139999  128.944000
2021-01-19  127.830002  128.714001</code></pre>
</div>
</div>
<p>The 5 and 20-day simple moving averages and the closing daily stock prices.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb189"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb189-1"><a href="#cb189-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">6</span>))</span>
<span id="cb189-2"><a href="#cb189-2"></a>plt.plot(data.index, data[<span class="st">"Close"</span>], label <span class="op">=</span> <span class="st">"Close"</span>)</span>
<span id="cb189-3"><a href="#cb189-3"></a>plt.plot(data.index, data[<span class="st">"SMA_5"</span>], label <span class="op">=</span> <span class="st">"SMA_5"</span>, </span>
<span id="cb189-4"><a href="#cb189-4"></a>         linewidth <span class="op">=</span> <span class="dv">2</span>, alpha <span class="op">=</span> <span class="fl">0.8</span>)</span>
<span id="cb189-5"><a href="#cb189-5"></a>plt.plot(data.index, data[<span class="st">"SMA_20"</span>], label <span class="op">=</span> <span class="st">"SMA_20"</span>)</span>
<span id="cb189-6"><a href="#cb189-6"></a>plt.axvline(x<span class="op">=</span>pd.to_datetime(<span class="st">'2022-08-17'</span>), color <span class="op">=</span> <span class="st">'g'</span>, linestyle <span class="op">=</span> <span class="st">'--'</span>)</span>
<span id="cb189-7"><a href="#cb189-7"></a>plt.title(<span class="st">"Close Price with SMA_5 and SMA_20"</span>)</span>
<span id="cb189-8"><a href="#cb189-8"></a>plt.xlabel(<span class="st">"Date"</span>)</span>
<span id="cb189-9"><a href="#cb189-9"></a>plt.ylabel(<span class="st">"Price"</span>)</span>
<span id="cb189-10"><a href="#cb189-10"></a>plt.legend()</span>
<span id="cb189-11"><a href="#cb189-11"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-237-11.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
</div>
<p>A zoom view.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb190"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb190-1"><a href="#cb190-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">6</span>))</span>
<span id="cb190-2"><a href="#cb190-2"></a>plt.plot(data.index[<span class="op">-</span><span class="dv">30</span>:], data[<span class="st">"Close"</span>].tail(<span class="dv">30</span>), label <span class="op">=</span> <span class="st">"Close"</span>, </span>
<span id="cb190-3"><a href="#cb190-3"></a>         color <span class="op">=</span> <span class="st">'black'</span>)</span>
<span id="cb190-4"><a href="#cb190-4"></a>plt.plot(data.index[<span class="op">-</span><span class="dv">30</span>:], data[<span class="st">"SMA_5"</span>].tail(<span class="dv">30</span>), label <span class="op">=</span> <span class="st">"SMA_5"</span>, </span>
<span id="cb190-5"><a href="#cb190-5"></a>         linewidth <span class="op">=</span> <span class="dv">7</span>, alpha <span class="op">=</span> <span class="fl">0.6</span>)</span>
<span id="cb190-6"><a href="#cb190-6"></a>plt.plot(data.index[<span class="op">-</span><span class="dv">30</span>:], data[<span class="st">"SMA_20"</span>].tail(<span class="dv">30</span>), label <span class="op">=</span> <span class="st">"SMA_20"</span>, </span>
<span id="cb190-7"><a href="#cb190-7"></a>         linewidth <span class="op">=</span> <span class="dv">7</span>, alpha <span class="op">=</span> <span class="fl">0.6</span>)</span>
<span id="cb190-8"><a href="#cb190-8"></a>plt.title(<span class="st">"Close Price with SMA_5 and SMA_20 (Last 30 Observations)"</span>)</span>
<span id="cb190-9"><a href="#cb190-9"></a>plt.xlabel(<span class="st">"Date"</span>)</span>
<span id="cb190-10"><a href="#cb190-10"></a>plt.ylabel(<span class="st">"Price"</span>)</span>
<span id="cb190-11"><a href="#cb190-11"></a>plt.legend()</span>
<span id="cb190-12"><a href="#cb190-12"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-238-13.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
</div>
<p>This is the information <span class="math inline">\(X\)</span> used to predict daily stock prices movements <span class="math inline">\(y\)</span>.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb191"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb191-1"><a href="#cb191-1"></a>X <span class="op">=</span> data[[<span class="st">"SMA_5"</span>, <span class="st">"SMA_10"</span>, <span class="st">"SMA_15"</span>, <span class="st">"SMA_20"</span>]]</span>
<span id="cb191-2"><a href="#cb191-2"></a>X.dropna(inplace <span class="op">=</span> <span class="va">True</span>)</span>
<span id="cb191-3"><a href="#cb191-3"></a></span>
<span id="cb191-4"><a href="#cb191-4"></a><span class="bu">print</span>(X)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>                 SMA_5      SMA_10      SMA_15      SMA_20
Date                                                      
2021-02-02  136.048001  137.429001  134.524001  133.371000
2021-02-03  134.424002  137.620001  134.866668  133.517501
2021-02-04  134.484003  137.672002  135.300001  134.057001
2021-02-05  135.444000  137.441000  135.823334  134.349001
2021-02-08  135.998001  136.840001  136.474667  134.592001
...                ...         ...         ...         ...
2022-12-29  129.953999  132.089999  135.925333  138.274000
2022-12-30  129.493999  131.432998  135.077333  137.355000
2023-01-03  128.135999  130.488998  133.937999  136.218000
2023-01-04  127.401999  129.887999  132.729332  135.204500
2023-01-05  127.197998  129.159998  131.365999  134.309999

[486 rows x 4 columns]</code></pre>
</div>
</div>
</section>
<section id="preliminaries-to-classify-returns." class="level2" data-number="6.4">
<h2 data-number="6.4" class="anchored" data-anchor-id="preliminaries-to-classify-returns."><span class="header-section-number">6.4</span> Preliminaries to classify returns.</h2>
<p>We are interested to anticipate positive and negative daily stock price movements <span class="math inline">\(y\)</span> or returns, so 1 stands for positive and 0 for negative realized daily returns.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb193"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb193-1"><a href="#cb193-1"></a>y <span class="op">=</span> (data.loc[<span class="st">'2021-02-02'</span>:][<span class="st">'Return'</span>] <span class="op">&gt;</span> <span class="dv">0</span>).astype(<span class="bu">int</span>)</span>
<span id="cb193-2"><a href="#cb193-2"></a></span>
<span id="cb193-3"><a href="#cb193-3"></a><span class="bu">print</span>(y)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Date
2021-02-02    1
2021-02-03    0
2021-02-04    1
2021-02-05    0
2021-02-08    1
             ..
2022-12-29    1
2022-12-30    1
2023-01-03    0
2023-01-04    1
2023-01-05    0
Name: Return, Length: 486, dtype: int32</code></pre>
</div>
</div>
<!-- ```{python} -->
<!-- new_dataframe = pd.concat([data.loc['2021-02-02':]['Close'].round(2), X.round(2), y], axis=1) -->
<!-- new_dataframe.head(30) -->
<!-- ``` -->
<p>Both training and test sets sum 486 daily observations, 80% are used to train the model and 20% to test it.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb195"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb195-1"><a href="#cb195-1"></a>split <span class="op">=</span> <span class="bu">int</span>(<span class="bu">len</span>(X) <span class="op">*</span> <span class="fl">0.8</span>)</span>
<span id="cb195-2"><a href="#cb195-2"></a>X_train, X_test, y_train, y_test <span class="op">=</span> X[:split], X[split:], y[:split], y[split:]</span>
<span id="cb195-3"><a href="#cb195-3"></a></span>
<span id="cb195-4"><a href="#cb195-4"></a><span class="bu">print</span>(X_train.shape, X_test.shape)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>(388, 4) (98, 4)</code></pre>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb197"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb197-1"><a href="#cb197-1"></a><span class="bu">print</span>(y_train.shape, y_test.shape)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>(388,) (98,)</code></pre>
</div>
</div>
<!-- ```{python} -->
<!-- plt.figure(figsize = (10, 6)) -->
<!-- plt.plot(data.index, data["Close"]) -->
<!-- plt.axvline(x = pd.to_datetime('2022-08-17'), color = 'r', linestyle = '--') -->
<!-- plt.text(pd.to_datetime('2021-12-01'), 120,  -->
<!--          'Entrenamiento (388 días).', fontsize = 12, color = 'black') -->
<!-- plt.text(pd.to_datetime('2022-09-01'), 120,  -->
<!--          'Prueba (98 días).', fontsize = 12, color = 'black') -->
<!-- plt.title("Close Price") -->
<!-- plt.xlabel("Date") -->
<!-- plt.ylabel("Price") -->
<!-- plt.show() -->
<!-- ``` -->
<!-- ```{python} -->
<!-- pipeline = Pipeline([ -->
<!--     ('imputer', SimpleImputer(strategy = 'mean')), -->
<!--     #('classifier', KNeighborsClassifier(7)), -->
<!--     #('classifier', SVC(kernel = "linear", C = 0.025, random_state = 42)) -->
<!--     #('classifier', SVC(gamma = 5, C = 4, random_state = 42))  -->
<!--     #('classifier', DecisionTreeClassifier(max_depth = 10, random_state = 42)) -->
<!--     #('classifier', MLPClassifier(alpha = 2, max_iter = 1000, random_state = 42)) -->
<!--     #('classifier', AdaBoostClassifier(random_state = 42)) -->
<!--     ('classifier', RandomForestClassifier(n_estimators = 100,  -->
<!--                                           random_state = 9)) #9, 20 -->
<!-- ]) -->
<!-- pipeline.fit(X_train, y_train) -->
<!-- ``` -->
</section>
<section id="set-up-the-model." class="level2" data-number="6.5">
<h2 data-number="6.5" class="anchored" data-anchor-id="set-up-the-model."><span class="header-section-number">6.5</span> Set up the model.</h2>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb199"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb199-1"><a href="#cb199-1"></a>pipeline <span class="op">=</span> Pipeline([</span>
<span id="cb199-2"><a href="#cb199-2"></a>    (<span class="st">'imputer'</span>, SimpleImputer(strategy <span class="op">=</span> <span class="st">'mean'</span>)),</span>
<span id="cb199-3"><a href="#cb199-3"></a>    (<span class="st">'classifier'</span>, RandomForestClassifier(n_estimators <span class="op">=</span> <span class="dv">100</span>, </span>
<span id="cb199-4"><a href="#cb199-4"></a>                                          random_state <span class="op">=</span> <span class="dv">9</span>)) <span class="co">#9, 20</span></span>
<span id="cb199-5"><a href="#cb199-5"></a>])</span>
<span id="cb199-6"><a href="#cb199-6"></a></span>
<span id="cb199-7"><a href="#cb199-7"></a>pipeline.fit(X_train, y_train)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<style>#sk-container-id-1 {color: black;}#sk-container-id-1 pre{padding: 0;}#sk-container-id-1 div.sk-toggleable {background-color: white;}#sk-container-id-1 label.sk-toggleable__label {cursor: pointer;display: block;width: 100%;margin-bottom: 0;padding: 0.3em;box-sizing: border-box;text-align: center;}#sk-container-id-1 label.sk-toggleable__label-arrow:before {content: "▸";float: left;margin-right: 0.25em;color: #696969;}#sk-container-id-1 label.sk-toggleable__label-arrow:hover:before {color: black;}#sk-container-id-1 div.sk-estimator:hover label.sk-toggleable__label-arrow:before {color: black;}#sk-container-id-1 div.sk-toggleable__content {max-height: 0;max-width: 0;overflow: hidden;text-align: left;background-color: #f0f8ff;}#sk-container-id-1 div.sk-toggleable__content pre {margin: 0.2em;color: black;border-radius: 0.25em;background-color: #f0f8ff;}#sk-container-id-1 input.sk-toggleable__control:checked~div.sk-toggleable__content {max-height: 200px;max-width: 100%;overflow: auto;}#sk-container-id-1 input.sk-toggleable__control:checked~label.sk-toggleable__label-arrow:before {content: "▾";}#sk-container-id-1 div.sk-estimator input.sk-toggleable__control:checked~label.sk-toggleable__label {background-color: #d4ebff;}#sk-container-id-1 div.sk-label input.sk-toggleable__control:checked~label.sk-toggleable__label {background-color: #d4ebff;}#sk-container-id-1 input.sk-hidden--visually {border: 0;clip: rect(1px 1px 1px 1px);clip: rect(1px, 1px, 1px, 1px);height: 1px;margin: -1px;overflow: hidden;padding: 0;position: absolute;width: 1px;}#sk-container-id-1 div.sk-estimator {font-family: monospace;background-color: #f0f8ff;border: 1px dotted black;border-radius: 0.25em;box-sizing: border-box;margin-bottom: 0.5em;}#sk-container-id-1 div.sk-estimator:hover {background-color: #d4ebff;}#sk-container-id-1 div.sk-parallel-item::after {content: "";width: 100%;border-bottom: 1px solid gray;flex-grow: 1;}#sk-container-id-1 div.sk-label:hover label.sk-toggleable__label {background-color: #d4ebff;}#sk-container-id-1 div.sk-serial::before {content: "";position: absolute;border-left: 1px solid gray;box-sizing: border-box;top: 0;bottom: 0;left: 50%;z-index: 0;}#sk-container-id-1 div.sk-serial {display: flex;flex-direction: column;align-items: center;background-color: white;padding-right: 0.2em;padding-left: 0.2em;position: relative;}#sk-container-id-1 div.sk-item {position: relative;z-index: 1;}#sk-container-id-1 div.sk-parallel {display: flex;align-items: stretch;justify-content: center;background-color: white;position: relative;}#sk-container-id-1 div.sk-item::before, #sk-container-id-1 div.sk-parallel-item::before {content: "";position: absolute;border-left: 1px solid gray;box-sizing: border-box;top: 0;bottom: 0;left: 50%;z-index: -1;}#sk-container-id-1 div.sk-parallel-item {display: flex;flex-direction: column;z-index: 1;position: relative;background-color: white;}#sk-container-id-1 div.sk-parallel-item:first-child::after {align-self: flex-end;width: 50%;}#sk-container-id-1 div.sk-parallel-item:last-child::after {align-self: flex-start;width: 50%;}#sk-container-id-1 div.sk-parallel-item:only-child::after {width: 0;}#sk-container-id-1 div.sk-dashed-wrapped {border: 1px dashed gray;margin: 0 0.4em 0.5em 0.4em;box-sizing: border-box;padding-bottom: 0.4em;background-color: white;}#sk-container-id-1 div.sk-label label {font-family: monospace;font-weight: bold;display: inline-block;line-height: 1.2em;}#sk-container-id-1 div.sk-label-container {text-align: center;}#sk-container-id-1 div.sk-container {/* jupyter's `normalize.less` sets `[hidden] { display: none; }` but bootstrap.min.css set `[hidden] { display: none !important; }` so we also need the `!important` here to be able to override the default hidden behavior on the sphinx rendered scikit-learn.org. See: https://github.com/scikit-learn/scikit-learn/issues/21755 */display: inline-block !important;position: relative;}#sk-container-id-1 div.sk-text-repr-fallback {display: none;}</style><div id="sk-container-id-1" class="sk-top-container"><div class="sk-text-repr-fallback"><pre>Pipeline(steps=[('imputer', SimpleImputer()),
                ('classifier', RandomForestClassifier(random_state=9))])</pre><b>In a Jupyter environment, please rerun this cell to show the HTML representation or trust the notebook. <br>On GitHub, the HTML representation is unable to render, please try loading this page with nbviewer.org.</b></div><div class="sk-container" hidden=""><div class="sk-item sk-dashed-wrapped"><div class="sk-label-container"><div class="sk-label sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="sk-estimator-id-1" type="checkbox"><label for="sk-estimator-id-1" class="sk-toggleable__label sk-toggleable__label-arrow">Pipeline</label><div class="sk-toggleable__content"><pre>Pipeline(steps=[('imputer', SimpleImputer()),
                ('classifier', RandomForestClassifier(random_state=9))])</pre></div></div></div><div class="sk-serial"><div class="sk-item"><div class="sk-estimator sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="sk-estimator-id-2" type="checkbox"><label for="sk-estimator-id-2" class="sk-toggleable__label sk-toggleable__label-arrow">SimpleImputer</label><div class="sk-toggleable__content"><pre>SimpleImputer()</pre></div></div></div><div class="sk-item"><div class="sk-estimator sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="sk-estimator-id-3" type="checkbox"><label for="sk-estimator-id-3" class="sk-toggleable__label sk-toggleable__label-arrow">RandomForestClassifier</label><div class="sk-toggleable__content"><pre>RandomForestClassifier(random_state=9)</pre></div></div></div></div></div></div></div>
</div>
</div>
</section>
<section id="evalute-the-model." class="level2" data-number="6.6">
<h2 data-number="6.6" class="anchored" data-anchor-id="evalute-the-model."><span class="header-section-number">6.6</span> Evalute the model.</h2>
<p>The model perfectly predicts the 200 positive and 188 negative daily returns <span class="math inline">\(y\)</span> in the training set.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb200"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb200-1"><a href="#cb200-1"></a>y_pred_train <span class="op">=</span> pipeline.predict(X_train)</span>
<span id="cb200-2"><a href="#cb200-2"></a>train_accuracy <span class="op">=</span> accuracy_score(y_train, y_pred_train)</span>
<span id="cb200-3"><a href="#cb200-3"></a></span>
<span id="cb200-4"><a href="#cb200-4"></a><span class="bu">print</span>(confusion_matrix(y_train, y_pred_train))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[[188   0]
 [  0 200]]</code></pre>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb202"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb202-1"><a href="#cb202-1"></a><span class="bu">print</span>(<span class="st">"Train Accuracy:"</span>, train_accuracy)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Train Accuracy: 1.0</code></pre>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb204"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb204-1"><a href="#cb204-1"></a>y_train.value_counts()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Return
1    200
0    188
Name: count, dtype: int64</code></pre>
</div>
</div>
<p>As expected, in the test set the story is different. We have 42 positive and 56 negative daily returns. The model correctly predicts 26 positive and 26 negative daily returns.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb206"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb206-1"><a href="#cb206-1"></a>y_pred_test <span class="op">=</span> pipeline.predict(X_test)</span>
<span id="cb206-2"><a href="#cb206-2"></a>test_accuracy <span class="op">=</span> accuracy_score(y_test, y_pred_test)</span>
<span id="cb206-3"><a href="#cb206-3"></a></span>
<span id="cb206-4"><a href="#cb206-4"></a><span class="bu">print</span>(confusion_matrix(y_test, y_pred_test))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[[26 30]
 [16 26]]</code></pre>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb208"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb208-1"><a href="#cb208-1"></a><span class="bu">print</span>(<span class="st">"Test Accuracy (26+26)/98:"</span>, test_accuracy)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Test Accuracy (26+26)/98: 0.5306122448979592</code></pre>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb210"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb210-1"><a href="#cb210-1"></a>y_test.value_counts()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Return
0    56
1    42
Name: count, dtype: int64</code></pre>
</div>
</div>
</section>
<section id="visualize-the-results." class="level2" data-number="6.7">
<h2 data-number="6.7" class="anchored" data-anchor-id="visualize-the-results."><span class="header-section-number">6.7</span> Visualize the results.</h2>
<p>First, we show both training and test sets together.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb212"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb212-1"><a href="#cb212-1"></a>data.loc[<span class="st">'2021-02-02'</span>:, <span class="st">'Predicted_Return'</span>] <span class="op">=</span> pipeline.predict(X.loc[<span class="st">'2021-02-02'</span>:])</span>
<span id="cb212-2"><a href="#cb212-2"></a>data[<span class="st">"Signal"</span>] <span class="op">=</span> data[<span class="st">"Predicted_Return"</span>].diff()</span>
<span id="cb212-3"><a href="#cb212-3"></a>data.loc[data[<span class="st">"Signal"</span>] <span class="op">&gt;</span> <span class="dv">0</span>, <span class="st">"Position"</span>] <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb212-4"><a href="#cb212-4"></a>data.loc[data[<span class="st">"Signal"</span>] <span class="op">&lt;</span> <span class="dv">0</span>, <span class="st">"Position"</span>] <span class="op">=</span> <span class="op">-</span><span class="dv">1</span></span>
<span id="cb212-5"><a href="#cb212-5"></a>data[<span class="st">"Position"</span>].fillna(<span class="dv">0</span>, inplace <span class="op">=</span> <span class="va">True</span>)</span>
<span id="cb212-6"><a href="#cb212-6"></a>data[<span class="st">"Strategy_Return"</span>] <span class="op">=</span> data[<span class="st">"Position"</span>] <span class="op">*</span> data[<span class="st">"Return"</span>]</span>
<span id="cb212-7"><a href="#cb212-7"></a>data[<span class="st">"Cumulative_Returns"</span>] <span class="op">=</span> (data[<span class="st">"Strategy_Return"</span>] <span class="op">+</span> <span class="dv">1</span>).cumprod()</span>
<span id="cb212-8"><a href="#cb212-8"></a></span>
<span id="cb212-9"><a href="#cb212-9"></a>selected_data <span class="op">=</span> data.loc[<span class="st">'2021-02-01'</span>:, [<span class="st">'Return'</span>, <span class="st">'Predicted_Return'</span>, <span class="st">'Position'</span>, <span class="st">'Strategy_Return'</span>, <span class="st">'Cumulative_Returns'</span>]]</span>
<span id="cb212-10"><a href="#cb212-10"></a></span>
<span id="cb212-11"><a href="#cb212-11"></a>selected_data</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>              Return  Predicted_Return  ...  Strategy_Return  Cumulative_Returns
Date                                    ...                                     
2021-02-01  0.016520               NaN  ...         0.000000            1.000000
2021-02-02  0.006337               1.0  ...         0.000000            1.000000
2021-02-03 -0.007778               0.0  ...         0.007778            1.007778
2021-02-04  0.025758               1.0  ...         0.025758            1.033737
2021-02-05 -0.004586               0.0  ...         0.004586            1.038477
...              ...               ...  ...              ...                 ...
2022-12-29  0.028324               0.0  ...         0.000000           16.774413
2022-12-30  0.002469               0.0  ...         0.000000           16.774413
2023-01-03 -0.037405               0.0  ...        -0.000000           16.774413
2023-01-04  0.010314               0.0  ...         0.000000           16.774413
2023-01-05 -0.010605               0.0  ...        -0.000000           16.774413

[487 rows x 5 columns]</code></pre>
</div>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb214"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb214-1"><a href="#cb214-1"></a><span class="co">#data["Strategy_Return"] = data["Position"] * data["Return"]</span></span>
<span id="cb214-2"><a href="#cb214-2"></a></span>
<span id="cb214-3"><a href="#cb214-3"></a>cumulative_returns <span class="op">=</span> (data[<span class="st">"Strategy_Return"</span>] <span class="op">+</span> <span class="dv">1</span>).cumprod()</span>
<span id="cb214-4"><a href="#cb214-4"></a></span>
<span id="cb214-5"><a href="#cb214-5"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">6</span>))</span>
<span id="cb214-6"><a href="#cb214-6"></a>plt.plot(data.index[:<span class="bu">len</span>(cumulative_returns)], cumulative_returns)</span>
<span id="cb214-7"><a href="#cb214-7"></a>plt.axvline(x<span class="op">=</span>pd.to_datetime(<span class="st">'2022-08-17'</span>), color <span class="op">=</span> <span class="st">'r'</span>, linestyle <span class="op">=</span> <span class="st">'--'</span>)  <span class="co"># Convert the date to datetime object</span></span>
<span id="cb214-8"><a href="#cb214-8"></a>plt.xlabel(<span class="st">"Date"</span>)</span>
<span id="cb214-9"><a href="#cb214-9"></a>plt.ylabel(<span class="st">"Cumulative Returns"</span>)</span>
<span id="cb214-10"><a href="#cb214-10"></a>plt.title(<span class="st">"Trading Strategy Performance"</span>)</span>
<span id="cb214-11"><a href="#cb214-11"></a>plt.grid(<span class="va">True</span>)</span>
<span id="cb214-12"><a href="#cb214-12"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-246-15.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
</div>
<p>The figure above is problematic since we assume trading starts in the training set. We should start the evaluation in the test set.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb215"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb215-1"><a href="#cb215-1"></a>data.loc[<span class="st">'2022-08-17'</span>:, <span class="st">'Predicted_Return'</span>] <span class="op">=</span> pipeline.predict(X.loc[<span class="st">'2022-08-17'</span>:])</span>
<span id="cb215-2"><a href="#cb215-2"></a>data[<span class="st">"Signal"</span>] <span class="op">=</span> data[<span class="st">"Predicted_Return"</span>].diff()</span>
<span id="cb215-3"><a href="#cb215-3"></a>data.loc[data[<span class="st">"Signal"</span>] <span class="op">&gt;</span> <span class="dv">0</span>, <span class="st">"Position"</span>] <span class="op">=</span> <span class="dv">1</span>  </span>
<span id="cb215-4"><a href="#cb215-4"></a>data.loc[data[<span class="st">"Signal"</span>] <span class="op">&lt;</span> <span class="dv">0</span>, <span class="st">"Position"</span>] <span class="op">=</span> <span class="op">-</span><span class="dv">1</span>  </span>
<span id="cb215-5"><a href="#cb215-5"></a>data[<span class="st">"Position"</span>].fillna(<span class="dv">0</span>, inplace <span class="op">=</span> <span class="va">True</span>) </span>
<span id="cb215-6"><a href="#cb215-6"></a><span class="co">#data["Strategy_Return"] = data["Position"] * data["Return"]</span></span>
<span id="cb215-7"><a href="#cb215-7"></a>data.loc[<span class="st">'2022-08-17'</span>:, <span class="st">"Strategy_Return"</span>] <span class="op">=</span> data.loc[<span class="st">'2022-08-17'</span>:, <span class="st">"Position"</span>] <span class="op">*</span> data.loc[<span class="st">'2022-08-17'</span>:, <span class="st">"Return"</span>]</span>
<span id="cb215-8"><a href="#cb215-8"></a>data[<span class="st">"Cumulative_Returns"</span>] <span class="op">=</span> (data.loc[<span class="st">'2022-08-17'</span>:,<span class="st">"Strategy_Return"</span>] <span class="op">+</span> <span class="dv">1</span>).cumprod()</span>
<span id="cb215-9"><a href="#cb215-9"></a></span>
<span id="cb215-10"><a href="#cb215-10"></a>selected_data <span class="op">=</span> data.loc[<span class="st">'2022-08-17'</span>:, [<span class="st">'Return'</span>, <span class="st">'Predicted_Return'</span>, <span class="st">'Position'</span>, <span class="st">'Strategy_Return'</span>, <span class="st">'Cumulative_Returns'</span>]]</span>
<span id="cb215-11"><a href="#cb215-11"></a></span>
<span id="cb215-12"><a href="#cb215-12"></a>selected_data</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>              Return  Predicted_Return  ...  Strategy_Return  Cumulative_Returns
Date                                    ...                                     
2022-08-17  0.008785               0.0  ...         0.000000            1.000000
2022-08-18 -0.002292               0.0  ...        -0.000000            1.000000
2022-08-19 -0.015102               0.0  ...        -0.000000            1.000000
2022-08-22 -0.023029               1.0  ...        -0.023029            0.976971
2022-08-23 -0.002029               0.0  ...         0.002029            0.978953
...              ...               ...  ...              ...                 ...
2022-12-29  0.028324               0.0  ...         0.000000            1.186438
2022-12-30  0.002469               0.0  ...         0.000000            1.186438
2023-01-03 -0.037405               0.0  ...        -0.000000            1.186438
2023-01-04  0.010314               0.0  ...         0.000000            1.186438
2023-01-05 -0.010605               0.0  ...        -0.000000            1.186438

[98 rows x 5 columns]</code></pre>
</div>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb217"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb217-1"><a href="#cb217-1"></a>cumulative_returns <span class="op">=</span> data[<span class="st">"Cumulative_Returns"</span>] <span class="op">=</span> (data.loc[<span class="st">'2022-08-17'</span>:,<span class="st">"Strategy_Return"</span>] <span class="op">+</span> <span class="dv">1</span>).cumprod()</span>
<span id="cb217-2"><a href="#cb217-2"></a></span>
<span id="cb217-3"><a href="#cb217-3"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">6</span>))</span>
<span id="cb217-4"><a href="#cb217-4"></a>plt.plot(cumulative_returns)</span>
<span id="cb217-5"><a href="#cb217-5"></a>plt.title(<span class="st">"Cumulative Returns"</span>)</span>
<span id="cb217-6"><a href="#cb217-6"></a>plt.xlabel(<span class="st">"Date"</span>)</span>
<span id="cb217-7"><a href="#cb217-7"></a>plt.ylabel(<span class="st">"Cumulative Returns"</span>)</span>
<span id="cb217-8"><a href="#cb217-8"></a>plt.grid(<span class="va">True</span>)</span>
<span id="cb217-9"><a href="#cb217-9"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-248-17.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
</div>
<p>The robot can make profits, although the results are highly sensitive to the model and parameters.</p>
<p>This document took 26.44 minutes to compile in Quarto version 1.3.450, and R version 4.3.2 (2023-10-31 ucrt).</p>
</section>
</section>
<section id="references." class="level1 unnumbered">
<h1 class="unnumbered">References.</h1>
<div id="refs" class="references csl-bib-body hanging-indent" role="list">
<div id="ref-dagum2016seasonal" class="csl-entry" role="listitem">
Dagum, Estela Bee, and Silvia Bianconcini. 2016. <em>Seasonal Adjustment Methods and Real Time Trend-Cycle Estimation</em>. Springer.
</div>
<div id="ref-hull2020machine" class="csl-entry" role="listitem">
Hull, John C. 2020. <em>Machine Learning in Business: An Introduction to the World of Data Science</em>. Amazon Distribution.
</div>
<div id="ref-hyndman2021forecasting" class="csl-entry" role="listitem">
Hyndman, Rob J, and George Athanasopoulos. 2021. <em>Forecasting: Principles and Practice</em>. OTexts.
</div>
<div id="ref-knuth1984literate" class="csl-entry" role="listitem">
Knuth, Donald Ervin. 1984. <span>“Literate Programming.”</span> <em>The Computer Journal</em> 27 (2): 97–111.
</div>
<div id="ref-Rref" class="csl-entry" role="listitem">
R Core Team. 2024. <em>R: A Language and Environment for Statistical Computing</em>. Vienna, Austria: R Foundation for Statistical Computing. <a href="https://www.R-project.org/">https://www.R-project.org/</a>.
</div>
</div>
</section>

</main>
<!-- /main column -->
<!-- Google tag (gtag.js) -->
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-63K46JN3N1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-63K46JN3N1');
</script>
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  let localAlternateSentinel = 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



<script src="index_files/libs/quarto-html/zenscroll-min.js"></script>
</body></html>